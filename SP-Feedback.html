<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奇美醫院高階臨床技能測驗-標準化病人回饋問卷</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* Bauhaus Color Palette & Base Styles */
        :root {
            --bauhaus-red: #D03328;
            --bauhaus-yellow: #EAB936;
            --bauhaus-blue: #1C4E8C;
            --bauhaus-white: #FCFBF9;
            --bauhaus-black: #1A1A1A;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bauhaus-white);
            color: var(--bauhaus-black);
            background-image: radial-gradient(var(--bauhaus-black) 1px, transparent 1px);
            background-size: 20px 20px; /* Dot pattern background */
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bauhaus-white);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bauhaus-black);
        }

        /* Bauhaus Specific Utility Classes */
        .bauhaus-shadow {
            box-shadow: 6px 6px 0px 0px var(--bauhaus-black);
        }
        .bauhaus-shadow-sm {
            box-shadow: 3px 3px 0px 0px var(--bauhaus-black);
        }
        .bauhaus-border {
            border: 3px solid var(--bauhaus-black);
        }
        
        /* Input Focus States */
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 4px 4px 0px 0px var(--bauhaus-blue);
            transform: translate(-2px, -2px);
        }

        /* Animations */
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in {
            animation: slideIn 0.4s ease-out forwards;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // Google Apps Script Web App URL
        // ==========================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHu6so82suf2dJofxzUtjw8opQSAElYkIK9YHHpzijgHV_thbBRIR3YYMb6_3A9DARVg/exec"; 
        // ==========================================

        const { useState, useEffect } = React;

        // Icons
        const CheckSquareIcon = () => <i data-lucide="check-square" className="w-6 h-6"></i>;
        
        // 產生 1 到 12 的站號
        const stationList = Array.from({ length: 12 }, (_, i) => i + 1);

        // SP 問卷評核項目
        const evaluationItems = [
            { id: 1, text: "測驗劇本演出順暢。" },
            { id: 2, text: "考前演練時考官或SP訓練師提供充足、良好的演練協助。" },
            { id: 3, text: "劇本提供之訊息足夠演練、演出之需要。" },
            { id: 4, text: "每梯演出次數尚可負擔。" }, // 特殊題：包含 4.1 和 4.2
            { id: 5, text: "換場休息時間足夠。" },
            { id: 6, text: "本次活動聯繫作業順暢。" }
        ];

        const ratings = [
            { value: 1, label: "非常不同意" },
            { value: 2, label: "不同意" },
            { value: 3, label: "無意見" },
            { value: 4, label: "同意" },
            { value: 5, label: "非常同意" }
        ];

        // 判斷按鈕顏色的邏輯函式 (全正向題)
        const getButtonColor = (questionId, value) => {
            if (value === 3) return "bg-[#EAB936]"; // Yellow for Neutral
            if (value === 1) return "bg-[#D03328]"; // Red
            if (value === 2) return "bg-[#D03328] opacity-80";
            if (value === 4) return "bg-[#1C4E8C] opacity-80";
            if (value === 5) return "bg-[#1C4E8C]"; // Blue
            return "bg-gray-200"; 
        };

        const App = () => {
            useEffect(() => {
                lucide.createIcons();
            }, []);

            const [formData, setFormData] = useState({
                spName: "",
                date: new Date().toISOString().split('T')[0],
                stationNumber: "",
                ratings: {},
                remarks: {},
                q4_1: "", // 今天的演出次數
                q4_2: "", // 建議適宜的演出次數
                commentQ7: ""  // 整體建議
            });

            const [submitted, setSubmitted] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [errors, setErrors] = useState({});

            const handleInputChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
                if (errors[field]) {
                    setErrors(prev => {
                        const newErrors = { ...prev };
                        delete newErrors[field];
                        return newErrors;
                    });
                }
            };

            const handleRatingChange = (questionId, value) => {
                setFormData(prev => ({
                    ...prev,
                    ratings: { ...prev.ratings, [questionId]: value }
                }));
            };

            const handleRemarkChange = (questionId, text) => {
                setFormData(prev => ({
                    ...prev,
                    remarks: { ...prev.remarks, [questionId]: text }
                }));
            };

            const validate = () => {
                const newErrors = {};
                if (!formData.spName) newErrors.spName = "請填寫姓名";
                if (!formData.date) newErrors.date = "請選擇日期";
                if (!formData.stationNumber) newErrors.stationNumber = "請選擇站號";
                
                // Q4 額外檢查
                if (!formData.q4_1) newErrors.q4_1 = "請填寫演出次數";
                
                const unansweredQuestions = evaluationItems.filter(item => !formData.ratings[item.id]);
                if (unansweredQuestions.length > 0) {
                    newErrors.ratings = `還有 ${unansweredQuestions.length} 題未填`;
                }

                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (validate()) {
                    setIsSubmitting(true);
                    
                    // 關鍵修正：將 Content-Type 改為 text/plain，避免 no-cors 模式下的 CORS 錯誤
                    fetch(GOOGLE_SCRIPT_URL, {
                        method: "POST",
                        mode: "no-cors",
                        headers: { 
                            "Content-Type": "text/plain" 
                        },
                        body: JSON.stringify(formData)
                    })
                    .then(() => {
                        // 因 no-cors，無法確認真正的 server response status，
                        // 但只要網路請求成功發出，即視為成功。
                        setIsSubmitting(false);
                        setSubmitted(true);
                        window.scrollTo(0, 0);
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        setIsSubmitting(false);
                        alert("傳送失敗，請檢查網路連線或稍後再試。\n" + error);
                    });

                } else {
                    const form = document.getElementById('evaluation-form');
                    form.classList.add('animate-pulse');
                    setTimeout(() => form.classList.remove('animate-pulse'), 500);
                    window.scrollTo(0, 0);
                }
            };

            if (submitted) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 md:p-6 bg-[#FCFBF9]">
                        <div className="bg-white border-[4px] border-black max-w-md w-full text-center bauhaus-shadow relative overflow-hidden">
                            <div className="bg-[#1C4E8C] text-white py-4 px-6 border-b-[4px] border-black flex items-center justify-center gap-3">
                                <div className="bg-white text-black p-1 rounded-sm border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,0.3)]">
                                    <CheckSquareIcon />
                                </div>
                                <span className="text-xl md:text-2xl font-black tracking-widest">填答成功 SUCCESS</span>
                            </div>
                            <div className="p-6 md:p-8 relative">
                                <div className="absolute top-0 left-0 w-12 h-12 bg-[#D03328] rounded-br-full border-r-4 border-b-4 border-black z-0"></div>
                                <div className="absolute bottom-0 right-0 w-20 h-20 bg-[#EAB936] rounded-tl-full border-l-4 border-t-4 border-black opacity-20 z-0"></div>
                                <div className="relative z-10 mt-2">
                                    <h2 className="text-2xl font-black mb-6 tracking-tight flex flex-col items-center">
                                        <span className="text-gray-500 text-sm font-bold uppercase tracking-widest mb-1">Evaluation Completed</span>
                                        <span>回饋問卷已順利送出</span>
                                    </h2>
                                    <div className="text-left space-y-3 bg-gray-50 p-6 border-[3px] border-black mb-8 font-bold text-sm md:text-base shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]">
                                        <div className="flex justify-between border-b-2 border-black pb-2">
                                            <span className="text-gray-500">SP姓名</span>
                                            <span className="text-[#1C4E8C] text-lg">{formData.spName}</span>
                                        </div>
                                        <div className="flex justify-between border-b-2 border-black pb-2">
                                            <span className="text-gray-500">日期</span>
                                            <span>{formData.date}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-500">站號</span>
                                            <span className="bg-black text-white px-2 py-0.5">第 {formData.stationNumber} 站</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-4xl mx-auto p-3 md:p-8 min-h-screen flex flex-col">
                    
                    {/* Header */}
                    <header className="mb-8 md:mb-12 grid grid-cols-1 md:grid-cols-12 gap-4">
                        <div className="md:col-span-8 bg-[#1C4E8C] text-white p-6 md:p-8 bauhaus-border bauhaus-shadow relative overflow-hidden">
                             <div className="absolute -right-8 -top-8 w-32 h-32 bg-[#EAB936] rounded-full border-[3px] border-black opacity-80 md:opacity-100"></div>
                             <h1 className="text-2xl md:text-4xl font-black relative z-10 leading-tight">
                                奇美醫院高階臨床技能測驗
                                <span className="block text-xl md:text-2xl mt-2 font-bold opacity-90 border-t-2 border-white/30 pt-2 inline-block">標準化病人回饋問卷</span>
                             </h1>
                        </div>
                        <div className="md:col-span-4 bg-white p-4 bauhaus-border bauhaus-shadow flex items-center justify-center relative overflow-hidden group">
                            <div className="w-full h-full flex flex-col items-center justify-center text-gray-400 bg-gray-50 border-2 border-dashed border-gray-300 min-h-[100px] md:min-h-[120px]">
                                <img 
                                   src="https://www.chimei.org.tw/main/cmh_department/59012/mag/202111/images/logo.png" 
                                   alt="Logo" 
                                   className="max-h-20 md:max-h-24 max-w-full object-contain"
                                   onError={(e) => {
                                       e.target.style.display='none';
                                       e.target.parentElement.innerHTML = '<span class="text-xs font-bold">LOGO AREA</span>';
                                   }}
                                />
                            </div>
                        </div>
                    </header>

                    <form id="evaluation-form" className="space-y-8 md:space-y-12 flex-grow">
                        
                        {/* Section 1: Basic Info */}
                        <section className="relative">
                            <div className="absolute -left-3 top-0 bottom-0 w-1 bg-black hidden md:block"></div>
                            <h2 className="text-xl md:text-2xl font-black mb-4 md:mb-6 flex items-center gap-3">
                                <span className="w-6 h-6 bg-[#EAB936] rounded-full border-2 border-black inline-block"></span>
                                基本資料
                            </h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                {/* Name Input */}
                                <div className="space-y-2">
                                    <label className="font-bold text-sm uppercase tracking-wide">標準化病人姓名 (簽名)</label>
                                    <input 
                                        type="text" 
                                        value={formData.spName}
                                        onChange={(e) => handleInputChange('spName', e.target.value)}
                                        className={`w-full p-3 md:p-4 bg-white border-[3px] border-black text-base md:text-lg font-medium transition-transform rounded-none ${errors.spName ? 'bg-red-50 border-[#D03328]' : ''}`}
                                        placeholder="請輸入姓名"
                                    />
                                    {errors.spName && <p className="text-[#D03328] font-bold text-xs">{errors.spName}</p>}
                                </div>

                                {/* Date Input */}
                                <div className="space-y-2">
                                    <label className="font-bold text-sm uppercase tracking-wide">測驗日期</label>
                                    <input 
                                        type="date" 
                                        value={formData.date}
                                        onChange={(e) => handleInputChange('date', e.target.value)}
                                        className={`w-full p-3 md:p-4 bg-white border-[3px] border-black text-base md:text-lg font-medium transition-transform rounded-none ${errors.date ? 'bg-red-50 border-[#D03328]' : ''}`}
                                    />
                                    {errors.date && <p className="text-[#D03328] font-bold text-xs">{errors.date}</p>}
                                </div>

                                {/* Station Number - Dropdown */}
                                <div className="md:col-span-2 space-y-2">
                                    <label className="font-bold text-sm uppercase tracking-wide">測驗站號</label>
                                    <div className="relative">
                                        <select
                                            value={formData.stationNumber}
                                            onChange={(e) => handleInputChange('stationNumber', e.target.value)}
                                            className={`w-full p-3 md:p-4 bg-white border-[3px] border-black text-base md:text-lg font-medium appearance-none cursor-pointer rounded-none ${errors.stationNumber ? 'border-[#D03328]' : ''}`}
                                        >
                                            <option value="" disabled>請選擇站號</option>
                                            {stationList.map(num => (
                                                <option key={num} value={num}>第 {num} 站</option>
                                            ))}
                                        </select>
                                        <div className="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                            <svg className="w-6 h-6 fill-current" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                                        </div>
                                    </div>
                                    {errors.stationNumber && <p className="text-[#D03328] font-bold text-xs">{errors.stationNumber}</p>}
                                </div>
                            </div>
                        </section>

                        {/* Section 2: Evaluation Items */}
                        <section className="relative">
                            <div className="absolute -left-3 top-0 bottom-0 w-1 bg-black hidden md:block"></div>
                            
                            <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 md:mb-8 gap-2">
                                <h2 className="text-xl md:text-2xl font-black flex items-center gap-3">
                                    <span className="w-0 h-0 border-l-[12px] border-l-transparent border-r-[12px] border-r-transparent border-b-[20px] border-b-[#1C4E8C]"></span>
                                    請針對以下項目惠予意見
                                </h2>
                                {errors.ratings && (
                                    <div className="bg-[#D03328] text-white px-4 py-1 font-bold text-sm transform md:-rotate-2 text-center md:text-left rounded md:rounded-none">
                                        ! 未完成評分
                                    </div>
                                )}
                            </div>
                            
                            <div className="space-y-4 md:space-y-6">
                                {evaluationItems.map((item, index) => (
                                    <div key={item.id} className="bg-white border-[3px] border-black p-0 overflow-hidden shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] transition-all duration-300">
                                        <div className="flex flex-col md:flex-row">
                                            {/* Question Number & Text */}
                                            <div className="md:w-1/3 bg-gray-50 p-4 md:p-6 border-b-[3px] md:border-b-0 md:border-r-[3px] border-black flex flex-col justify-center relative">
                                                <span className="inline-block self-start bg-black text-white px-3 py-1 font-mono text-sm font-bold mb-2">Q{index + 1}</span>
                                                <h3 className="text-base md:text-lg font-bold leading-snug">{item.text}</h3>
                                            </div>

                                            {/* Rating Area */}
                                            <div className="md:w-2/3 p-4 flex flex-col justify-center">
                                                <div className="grid grid-cols-5 gap-2 mb-2">
                                                    {ratings.map((rating) => {
                                                        const isSelected = formData.ratings[item.id] === rating.value;
                                                        const activeColorClass = getButtonColor(item.id, rating.value);
                                                        let btnStyle = "bg-white text-black hover:bg-gray-100";
                                                        if (isSelected) {
                                                            btnStyle = `${activeColorClass} text-white ring-2 ring-black ring-offset-2 scale-[0.98]`;
                                                        }

                                                        return (
                                                            <button
                                                                key={rating.value}
                                                                type="button"
                                                                onClick={() => handleRatingChange(item.id, rating.value)}
                                                                className={`
                                                                    flex flex-col items-center justify-center p-1 border-2 border-black min-h-[50px] md:h-20 transition-all duration-200
                                                                    ${btnStyle}
                                                                `}
                                                            >
                                                                <span className="text-lg md:text-xl font-black leading-none mb-1">{rating.value}</span>
                                                                <span className="text-[9px] md:text-[10px] font-bold leading-tight opacity-90 hidden sm:block">{rating.label}</span>
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                                
                                                <div className="flex justify-between text-[10px] font-bold text-gray-500 uppercase tracking-wider px-1 border-t-2 border-gray-100 pt-2">
                                                    <span className="text-[#D03328]">非常不同意</span>
                                                    <span className="text-[#EAB936]">無意見</span>
                                                    <span className="text-[#1C4E8C]">非常同意</span>
                                                </div>

                                                <input
                                                    type="text"
                                                    value={formData.remarks[item.id] || ""}
                                                    onChange={(e) => handleRemarkChange(item.id, e.target.value)}
                                                    placeholder="備註 (選填)..."
                                                    className="mt-2 w-full border-b-2 border-gray-200 focus:border-black bg-transparent py-2 text-sm outline-none transition-colors rounded-none"
                                                />

                                                {/* Special Handling for Question 4 */}
                                                {item.id === 4 && (
                                                    <div className="mt-4 pt-4 border-t-2 border-dashed border-gray-300 space-y-4">
                                                        <div className="space-y-1">
                                                            <label className="text-sm font-bold text-[#1C4E8C] block">4.1 請問您今天的演出次數</label>
                                                            <input
                                                                type="text"
                                                                value={formData.q4_1}
                                                                onChange={(e) => handleInputChange('q4_1', e.target.value)}
                                                                className={`w-full p-2 bg-gray-50 border-2 border-gray-300 focus:border-black rounded-none ${errors.q4_1 ? 'border-red-500 bg-red-50' : ''}`}
                                                                placeholder="請輸入次數"
                                                            />
                                                            {errors.q4_1 && <p className="text-xs text-red-500 font-bold">{errors.q4_1}</p>}
                                                        </div>
                                                        <div className="space-y-1">
                                                            <label className="text-sm font-bold text-[#1C4E8C] block">4.2 如超過您的體力負擔，您認為適宜的演出次數</label>
                                                            <input
                                                                type="text"
                                                                value={formData.q4_2}
                                                                onChange={(e) => handleInputChange('q4_2', e.target.value)}
                                                                className="w-full p-2 bg-gray-50 border-2 border-gray-300 focus:border-black rounded-none"
                                                                placeholder="選填..."
                                                            />
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>

                        {/* Section 3: Open Ended Questions */}
                        <section className="relative">
                             <div className="absolute -left-3 top-0 bottom-0 w-1 bg-black hidden md:block"></div>
                             
                             {/* Q7 */}
                             <div>
                                <h2 className="text-lg md:text-xl font-black mb-3 flex items-center gap-3">
                                    <span className="inline-block bg-black text-white px-2 py-0.5 text-sm">Q7</span>
                                    對於此次OSCE整體活動之其他意見及建議？
                                </h2>
                                <textarea
                                    value={formData.commentQ7}
                                    onChange={(e) => handleInputChange('commentQ7', e.target.value)}
                                    className="w-full h-24 md:h-32 p-4 md:p-6 bg-white border-[3px] border-black text-base md:text-lg shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] resize-none rounded-none"
                                    placeholder="請輸入意見及建議..."
                                ></textarea>
                             </div>
                        </section>

                        {/* Submit */}
                        <div className="py-4 md:py-8">
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className={`
                                    group w-full bg-black text-white text-xl md:text-2xl font-black py-4 md:py-6 border-[4px] border-black 
                                    transition-all duration-300 bauhaus-shadow flex items-center justify-center gap-4 
                                    ${isSubmitting ? 'opacity-90 cursor-wait' : 'hover:bg-[#EAB936] hover:text-black active:translate-y-1 active:shadow-none'}
                                `}
                            >
                                {isSubmitting ? (
                                    <>
                                        <div className="loading-spinner"></div>
                                        <span>傳送資料中...</span>
                                    </>
                                ) : (
                                    <>
                                        <span>提交回饋問卷</span>
                                        <div className="bg-white text-black p-1 rounded-full group-hover:bg-black group-hover:text-white transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 md:h-6 md:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}>
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                            </svg>
                                        </div>
                                    </>
                                )}
                            </button>
                        </div>

                    </form>
                    
                    <footer className="mt-8 md:mt-12 pt-6 md:pt-8 border-t-[3px] border-black flex flex-col md:flex-row justify-between items-center text-xs md:text-sm font-bold uppercase tracking-widest text-gray-500 gap-4">
                        <span className="text-center md:text-left">2025 © 奇美醫院臨床技能中心</span>
                        <div className="flex gap-2">
                            <div className="w-3 h-3 bg-[#1C4E8C] rounded-full"></div>
                            <div className="w-3 h-3 bg-[#D03328] rounded-full"></div>
                            <div className="w-3 h-3 bg-[#EAB936] rounded-full"></div>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
