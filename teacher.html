<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥‡ç¾é†«é™¢ OSCE è€ƒå®˜è©•åˆ†å„€è¡¨æ¿</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (Google Fonts) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide scrollbar for overflow-y-auto but allow scrolling */
        .overflow-y-auto::-webkit-scrollbar {
            width: 0.5em;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">
    <div id="root"></div>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN for JSX transformation in browser (for development, production build would pre-compile) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // Destructure React hooks from the global React object
        const { useState, useEffect, useCallback } = React;

        // ä¸»æ‡‰ç”¨ç¨‹å¼çµ„ä»¶
        const App = () => {
            // æ¨¡æ“¬æ•¸æ“šï¼Œæ ¹æ“šæ‚¨çš„è©•åˆ†æ¨¡æ¿å’Œéœ€æ±‚èª¿æ•´
            const initialDashboardData = {
                examinerId: "E02", // æ¨¡æ“¬åˆå§‹è€ƒå®˜ID
                station: {
                    stationId: 5,
                    title: "èƒ¸è…”å¼•æµè¡“",
                    sessionStart: "2025-06-19T09:30:00+08:00",
                    sessionEnd: "2025-06-19T11:00:00+08:00",
                    totalCandidates: 2, // Modified: Total candidates is now 2
                },
                rubric: [
                    // æ ¹æ“šåœ–ç‰‡æ¨¡æ¿ï¼Œå®šç¾©æ¯å€‹è©•åˆ†é …çš„æè¿°ï¼Œä¸¦æ–°å¢ 'description' å­—æ®µç”¨æ–¼ hover æç¤º
                    { item: "å‘ç—…äººè‡ªæˆ‘ä»‹ç´¹ä¸¦èªªæ˜è™•ç½®ç›®çš„", max: 2, description: { "1": "èƒ½ç°¡å–®èªªæ˜ç›®çš„ä½†ç¼ºä¹äº’å‹•", "2": "å®Œæ•´èªªæ˜è™•ç½®ç›®çš„ä¸¦è‰¯å¥½äº’å‹•" } },
                    { item: "æ­£ç¢ºæ´—æ‰‹ä¸¦æˆ´ä¸Šç„¡èŒæ‰‹å¥—", max: 2, description: { "1": "æ´—æ‰‹æ­¥é©Ÿä¸å®Œæ•´æˆ–æ‰‹å¥—æˆ´æ³•æœ‰ç‘•ç–µ", "2": "æ´—æ‰‹èˆ‡ç„¡èŒæ‰‹å¥—ç©¿æˆ´å®Œå…¨æ­£ç¢º" } },
                    { item: "ç¶æ­¢è¡€å¸¶æ–¼æ­£ç¢ºä½ç½®", max: 2, description: { "1": "æ­¢è¡€å¸¶ä½ç½®ç•¥æœ‰åå·®", "2": "æ­¢è¡€å¸¶ç¶æ–¼æ­£ç¢ºä¸”èˆ’é©çš„ä½ç½®" } },
                    { item: "ä½¿ç”¨ 75% é…’ç²¾æ£‰ç‰‡ç”±å…§å‘å¤–æ¶ˆæ¯’ç©¿åˆºéƒ¨ä½", max: 2, description: { "1": "æ¶ˆæ¯’ç¯„åœä¸è¶³æˆ–æ–¹å‘éŒ¯èª¤", "2": "å®Œæ•´æ¶ˆæ¯’ç©¿åˆºéƒ¨ä½ï¼Œç”±å…§å‘å¤–" } },
                    { item: "æ‹¿é‡æ™‚æª¢æŸ¥é‡å…·å®Œå¥½èˆ‡æ’æ°£", max: 2, description: { "1": "æª¢æŸ¥ä¸å¤ ç´°ç·»æˆ–æ’æ°£ä¸å®Œå…¨", "2": "å®Œæ•´æª¢æŸ¥é‡å…·ä¸¦å¾¹åº•æ’æ°£" } },
                    { item: "ä¸‹é‡è§’åº¦æ­£ç¢ºä¸¦ç©©å®šé€²é‡", max: 2, description: { "1": "è§’åº¦ç•¥æœ‰åç§»æˆ–é€²é‡ä¸ç©©", "2": "ä¸‹é‡è§’åº¦ç²¾æº–ä¸”é€²é‡ç©©å®šæµæš¢" } },
                    { item: "æˆåŠŸè¦‹å›è¡€ä¸¦å°å…¥å°ç®¡", max: 2, description: { "1": "å›è¡€æ…¢æˆ–å°ç®¡å°å…¥ä¸é †", "2": "è¿…é€Ÿè¦‹å›è¡€ä¸¦é †åˆ©å°å…¥å°ç®¡" } },
                    { item: "é¬†é–‹æ­¢è¡€å¸¶", max: 2, description: { "1": "é¬†é–‹æ™‚æ©Ÿç¨æ™šæˆ–å‹•ä½œç”Ÿç¡¬", "2": "åœ¨é©ç•¶æ™‚æ©Ÿè¿…é€Ÿé¬†é–‹æ­¢è¡€å¸¶" } },
                    { item: "ä»¥ç´—å¸ƒå£“ä½ç©¿åˆºè™•ï¼Œæ‹”é™¤é‡é ­", max: 2, description: { "1": "æŒ‰å£“ä½ç½®ä¸æº–æˆ–æ‹”é‡ä¸ç©©", "2": "ç²¾æº–æŒ‰å£“ç©¿åˆºè™•ä¸¦å¹³ç©©æ‹”é™¤é‡é ­" } },
                    { item: "å°‡å°ç®¡èˆ‡å»¶é•·ç®¡é€£æ¥ä¸¦å›ºå®šæ–¼é©ç•¶ä½ç½®", max: 2, description: { "1": "é€£æ¥ä¸å¤ ç‰¢å›ºæˆ–å›ºå®šä½ç½®ä¸ä½³", "2": "å°ç®¡èˆ‡å»¶é•·ç®¡é€£æ¥ç‰¢å›ºä¸¦å›ºå®šæ–¼é©ç•¶ä½ç½®" } },
                    { item: "ä»¥ 3M è† å¸¶å›ºå®šä¸¦æ¨™ç¤ºæ—¥æœŸ", max: 2, description: { "1": "è† å¸¶å›ºå®šä¸ç‰¢æˆ–æ—¥æœŸæ¨™ç¤ºä¸æ˜", "2": "è† å¸¶å›ºå®šç‰¢å›ºä¸”æ˜ç¢ºæ¨™ç¤ºæ—¥æœŸ" } },
                    { item: "æ­£ç¢ºè„«æ‰‹å¥—ä¸¦å°‡å»¢æ£„ç‰©åˆ†é¡", max: 2, description: { "1": "è„«æ‰‹å¥—æ–¹å¼ä¸æ­£ç¢ºæˆ–åˆ†é¡æœ‰èª¤", "2": "æ­£ç¢ºè„«é™¤æ‰‹å¥—ä¸¦å¦¥å–„åˆ†é¡å»¢æ£„ç‰©" } },
                    { item: "æ“ä½œçµæŸå¾Œå†æ¬¡æ­£ç¢ºæ´—æ‰‹", max: 2, description: { "1": "æ´—æ‰‹æ­¥é©Ÿä¸å®Œæ•´", "2": "æ“ä½œçµæŸå¾Œå†æ¬¡æ­£ç¢ºæ´—æ‰‹" } }
                ],
                currentCandidate: null, // åˆå§‹è¨­ç‚ºç©ºï¼Œç­‰å¾…é¸æ“‡
                reportUrls: {
                    batchPdf: "https://example.com/Station5_E02_20250619.pdf",
                    csv: "https://example.com/Station5_E02_20250619.csv"
                }
            };

            // æ¨¡æ“¬è€ƒç”Ÿè³‡æ–™ - æ¸›å°‘ç‚º2ä½è€ƒç”Ÿ
            const mockCandidates = [
                { id: "A01", name: "æ—å°æ˜", ticket: "A01", scored: false, savedScores: null, savedComment: "", savedOverallScore: null, savedItemNotes: null, savedExaminerFeedback: "", savedStandardizedPatientFeedback: "", totalScore: 0 },
                { id: "A02", name: "é™³å¤§è¯", ticket: "A02", scored: false, savedScores: null, savedComment: "", savedOverallScore: null, savedItemNotes: null, savedExaminerFeedback: "", savedStandardizedPatientFeedback: "", totalScore: 0 },
            ];

            // æ¨¡æ“¬è©•æ ¸è€ƒå®˜è³‡æ–™
            const mockExaminers = [
                { id: "E01", name: "æé†«å¸«" },
                { id: "E02", name: "ç‹ä¸»ä»»" },
                { id: "E03", name: "è¶™æ•™æˆ" },
                { id: "E04", name: "é™³è€å¸«" },
            ];

            // æ¨¡æ“¬æ•™æ¡ˆæŒ‡å¼•å…§å®¹
            const teachingGuideContent = {
                title: "èƒ¸è…”å¼•æµè¡“ - æ•™æ¡ˆæŒ‡å¼•",
                sections: [
                    {
                        heading: "è€ƒå®˜æŒ‡å¼•",
                        content: `è€ƒå®˜æ‚¨å¥½ï¼Œæœ¬ç«™ç‚ºã€Œèƒ¸è…”å¼•æµè¡“ã€è€ƒé¡Œï¼Œæ—¨åœ¨è©•ä¼°è€ƒç”Ÿåœ¨ç„¡èŒæ“ä½œã€è§£å‰–å®šä½ã€éº»é†‰æŠ€å·§ã€æ’ç®¡èˆ‡å›ºå®šç­‰æ–¹é¢çš„ç¶œåˆèƒ½åŠ›ã€‚è«‹æ‚¨æ ¹æ“šè©•åˆ†æ¨™æº–ï¼Œå…¬æ­£å®¢è§€åœ°çµ¦äºˆè©•åˆ†ï¼Œä¸¦åœ¨ã€Œè€ƒå®˜è¨»è§£ã€ä¸­æä¾›å…·é«”ã€å»ºè¨­æ€§çš„å›é¥‹ã€‚
        
                        è©•åˆ†æ³¨æ„äº‹é …ï¼š
                        1. ç„¡èŒæŠ€è¡“ï¼šè«‹ç‰¹åˆ¥é—œæ³¨è€ƒç”Ÿå¾æ´—æ‰‹åˆ°ç©¿æˆ´æ‰‹å¥—ã€æ¶ˆæ¯’éç¨‹çš„ç„¡èŒæ„è­˜èˆ‡æ“ä½œã€‚
                        2. è§£å‰–å®šä½ï¼šè©•ä¼°è€ƒç”Ÿèƒ½å¦æº–ç¢ºæ‰¾åˆ°ç©¿åˆºé»ã€‚
                        3. éº»é†‰æ•ˆæœï¼šè§€å¯Ÿè€ƒç”Ÿéº»é†‰è—¥ç‰©æ³¨å°„æŠ€å·§èˆ‡æ‚£è€…åæ‡‰ã€‚
                        4. æ’ç®¡æŠ€å·§ï¼šè©•ä¼°é€²é‡è§’åº¦ã€æ·±åº¦èˆ‡å°ç®¡æ”¾ç½®çš„é †æš¢æ€§ã€‚
                        5. å›ºå®šèˆ‡å¼•æµï¼šç¢ºä¿å°ç®¡å›ºå®šç‰¢å›ºï¼Œä¸¦é€£æ¥å¼•æµè£ç½®ã€‚`
                    },
                    {
                        heading: "è€ƒç”ŸæŒ‡å¼•",
                        content: `è€ƒç”Ÿæ‚¨å¥½ï¼Œåœ¨ã€Œèƒ¸è…”å¼•æµè¡“ã€è€ƒç«™ä¸­ï¼Œæ‚¨éœ€è¦å±•ç¤ºåœ¨æ¨¡æ“¬æƒ…å¢ƒä¸‹åŸ·è¡Œèƒ¸è…”å¼•æµè¡“çš„è‡¨åºŠæŠ€èƒ½ã€‚è«‹æ³¨æ„ç„¡èŒåŸå‰‡ã€èˆ‡æ¨™æº–åŒ–ç—…äººçš„æºé€šã€æ“ä½œæ­¥é©Ÿçš„æµæš¢æ€§èˆ‡å®‰å…¨æ€§ã€‚
        
                        è€ƒå‰æº–å‚™ï¼šè«‹ç¢ºèªæ‚¨å·²ç†Ÿæ‚‰èƒ¸è…”å¼•æµè¡“çš„æ¨™æº–æ“ä½œæµç¨‹ï¼ˆSOPï¼‰å’Œç›¸é—œè§£å‰–çŸ¥è­˜ã€‚
                        è€ƒè©¦æµç¨‹ï¼š
                        1. é€²å…¥è€ƒç«™å¾Œï¼Œè«‹å…ˆè‡ªæˆ‘ä»‹ç´¹ä¸¦å‘ç—…äººèªªæ˜æ“ä½œç›®çš„ã€‚
                        2. ä¾åºåŸ·è¡Œæ´—æ‰‹ã€ç©¿æˆ´ç„¡èŒæ‰‹å¥—ã€æ¶ˆæ¯’çš®è†šç­‰æ­¥é©Ÿã€‚
                        3. åŸ·è¡Œå±€éƒ¨éº»é†‰ã€‚
                        4. åŸ·è¡Œèƒ¸è…”ç©¿åˆºå¼•æµã€‚
                        5. å›ºå®šå°ç®¡ä¸¦é€£æ¥å¼•æµç“¶ã€‚
                        6. å®Œæˆæ“ä½œå¾Œçš„æ”¶å°¾å·¥ä½œã€‚`
                    },
                    {
                        heading: "æ¨™æº–åŒ–ç—…äººæŒ‡å¼•",
                        content: `æ¨™æº–åŒ–ç—…äººæ‚¨å¥½ï¼Œåœ¨ã€Œèƒ¸è…”å¼•æµè¡“ã€è€ƒç«™ä¸­ï¼Œæ‚¨çš„è§’è‰²æ˜¯ä¸€ä½å› æ°£èƒ¸éœ€æ¥å—èƒ¸è…”å¼•æµè¡“çš„æ‚£è€…ã€‚è«‹æ‚¨æ ¹æ“šä»¥ä¸‹æŒ‡ç¤ºï¼ŒçœŸå¯¦åœ°è¡¨ç¾ç—…äººçš„åæ‡‰ï¼Œä»¥å”åŠ©è€ƒå®˜è©•ä¼°è€ƒç”Ÿçš„è¡¨ç¾ã€‚
        
                        æƒ…å¢ƒè¨­å®šï¼šæ‚¨å› æ°£èƒ¸å°è‡´å‘¼å¸å›°é›£ï¼Œæ„Ÿåˆ°èƒ¸ç—›ã€‚
                        è¡¨æ¼”è¦é»ï¼š
                        1. ç–¼ç—›è¡¨ç¾ï¼šç•¶è€ƒç”Ÿè§¸æ‘¸æˆ–æ“ä½œæ™‚ï¼Œè‹¥æ„Ÿåˆ°ä¸é©ï¼Œå¯è¼•å¾®çšºçœ‰æˆ–ç™¼å‡ºè¼•å“¼ã€‚è‹¥ç–¼ç—›åŠ åŠ‡ï¼Œå¯è¡¨é”ã€Œæœ‰é»ç—›ã€ã€‚
                        2. å‘¼å¸å›°é›£ï¼šå¯è¡¨ç¾ç‚ºå‘¼å¸æ€¥ä¿ƒæˆ–æ·ºå¿«ã€‚
                        3. æºé€šäº’å‹•ï¼šå¦‚æœè€ƒç”Ÿæœ‰å‘æ‚¨èªªæ˜ã€è©¢å•æ„Ÿå—ï¼Œè«‹æ‚¨é©ç•¶åœ°çµ¦äºˆå›æ‡‰ã€‚
                        4. æƒ…ç·’åæ‡‰ï¼šä¿æŒç©©å®šï¼Œä¸éåº¦ç„¦æ…®æˆ–æŠ±æ€¨ã€‚`
                    },
                    {
                        heading: "æ•™æ¡ˆå…§å®¹èˆ‡é™„ä»¶",
                        content: `[æ­¤è™•å¯æ”¾ç½®å…·é«”SOPæµç¨‹åœ–ã€è§£å‰–ç¤ºæ„åœ–ã€æˆ–ç›¸é—œé™„ä»¶åœ–ç‰‡]`
                    }
                ]
            };

            const [dashboardData, setDashboardData] = useState(initialDashboardData);
            const [sessionTimeLeft, setSessionTimeLeft] = useState(0); // å–®ä½ï¼šç§’
            const [overallComment, setOverallComment] = useState(""); // æ•´é«”ç¸½è©•
            const [overallScore, setOverallScore] = useState(null); // æ•´é«”è¡¨ç¾è©•åˆ† (1-5)
            const [itemNotes, setItemNotes] = useState(Array(initialDashboardData.rubric.length).fill("")); // è€ƒå®˜è¨»è§£
            const [currentScores, setCurrentScores] = useState(Array(initialDashboardData.rubric.length).fill(null)); // åˆå§‹ç‚º null è¡¨ç¤ºæœªè©•åˆ†
            const [examinerFeedback, setExaminerFeedback] = useState(""); // è€ƒå®˜å›é¥‹å•å·å…§å®¹
            const [standardizedPatientFeedback, setStandardizedPatientFeedback] = useState(""); // è©•æ ¸æ¨™æº–åŒ–ç—…äººå•å·å…§å®¹

            const [showErrorModal, setShowErrorModal] = useState(false); // é¡¯ç¤ºéŒ¯èª¤æç¤ºæ¨¡æ…‹æ¡†
            const [errorMessage, setErrorMessage] = useState(""); // éŒ¯èª¤è¨Šæ¯
            const [showCandidateListModal, setShowCandidateListModal] = useState(false); // é¡¯ç¤ºè€ƒç”Ÿåˆ—è¡¨æ¨¡æ…‹æ¡† (ç”¨æ–¼ä¿®æ”¹æˆç¸¾)

            // æ–°å¢æ¨¡æ…‹æ¡†é¡¯ç¤ºç‹€æ…‹
            const [showTeachingGuideModal, setShowTeachingGuideModal] = useState(false);
            // çµ±ä¸€å•å·é¡¯ç¤ºç‚ºä¸€å€‹æ¨¡æ…‹æ¡†
            const [showFinalQuestionnairesModal, setShowFinalQuestionnairesModal] = useState(false);
            // ç§»é™¤æˆç¸¾è¦–è¦ºåŒ–æ¨¡æ…‹æ¡†ç›¸é—œç‹€æ…‹

            // æ–°å¢æœƒè©±å®Œæˆç‹€æ…‹
            const [showCompletionMessage, setShowCompletionMessage] = useState(false);


            // æ–°å¢ç‹€æ…‹ç®¡ç†æ—¥æœŸã€è€ƒç”Ÿã€è€ƒå®˜é¸æ“‡ (è€ƒå®˜é è¨­å¸¶å…¥)
            const getTodayDateString = () => {
                const today = new Date();
                return today.toISOString().split('T')[0];
            };
            const [selectedDate, setSelectedDate] = useState(getTodayDateString());
            const [selectedCandidateId, setSelectedCandidateId] = useState(""); // åˆå§‹ç„¡é¸æ“‡
            // è‡ªå‹•å¸¶å…¥è€ƒå®˜ID
            const [selectedExaminerId, setSelectedExaminerId] = useState(initialDashboardData.examinerId);
            const [allCandidates, setAllCandidates] = useState(mockCandidates); // ç”¨æ–¼å„²å­˜è€ƒç”ŸåŠå…¶è©•åˆ†ç‹€æ…‹

            // è¨ˆç®—å·²è©•è€ƒç”Ÿæ•¸é‡
            const calculateScoredCandidates = useCallback(() => {
                return allCandidates.filter(c => c.scored).length;
            }, [allCandidates]);


            // æ ¹æ“šé¸æ“‡çš„è€ƒç”Ÿæ›´æ–°è©•åˆ†é¢æ¿é¡¯ç¤º
            useEffect(() => {
                const selectedCandidate = allCandidates.find(c => c.id === selectedCandidateId);
                if (selectedCandidate) {
                    setDashboardData(prevData => ({
                        ...prevData,
                        currentCandidate: {
                            id: selectedCandidate.id,
                            name: selectedCandidate.name,
                            ticket: selectedCandidate.ticket,
                            scores: selectedCandidate.savedScores || Array(prevData.rubric.length).fill(null),
                            comment: selectedCandidate.savedComment || "",
                            itemNotes: selectedCandidate.savedItemNotes || Array(prevData.rubric.length).fill(""),
                        }
                    }));
                    setOverallComment(selectedCandidate.savedComment || "");
                    setOverallScore(selectedCandidate.savedOverallScore || null);
                    setItemNotes(selectedCandidate.savedItemNotes || Array(dashboardData.rubric.length).fill(""));
                    setCurrentScores(selectedCandidate.savedScores || Array(dashboardData.rubric.length).fill(null));
                    setExaminerFeedback(selectedCandidate.savedExaminerFeedback || "");
                    setStandardizedPatientFeedback(selectedCandidate.savedStandardizedPatientFeedback || "");
                } else {
                    setDashboardData(prevData => ({
                        ...prevData,
                        currentCandidate: null
                    }));
                    setOverallComment("");
                    setOverallScore(null);
                    setItemNotes(Array(dashboardData.rubric.length).fill(""));
                    setCurrentScores(Array(dashboardData.rubric.length).fill(null));
                    setExaminerFeedback("");
                    setStandardizedPatientFeedback("");
                }
            }, [selectedCandidateId, dashboardData.rubric.length, allCandidates]);

            // è¨ˆç®—å ´æ¬¡å‰©é¤˜æ™‚é–“
            useEffect(() => {
                const sessionEndTime = new Date(dashboardData.station.sessionEnd).getTime();
                const calculateTimeLeft = () => {
                    const now = new Date().getTime();
                    const timeLeft = Math.max(0, Math.floor((sessionEndTime - now) / 1000));
                    setSessionTimeLeft(timeLeft);
                };

                calculateTimeLeft(); // åˆæ¬¡è¨ˆç®—
                const timer = setInterval(calculateTimeLeft, 1000); // æ¯ç§’æ›´æ–°

                return () => clearInterval(timer); // æ¸…ç†å®šæ™‚å™¨
            }, [dashboardData.station.sessionEnd]);

            // æ ¼å¼åŒ–æ™‚é–“ï¼Œç•¶å€’æ•¸åˆ° 00:00 æ™‚ä¸å†é¡¯ç¤º
            const formatTime = (totalSeconds) => {
                if (totalSeconds <= 0) {
                    return ""; // ä¸é¡¯ç¤ºä»»ä½•æ–‡å­—
                }
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            // è™•ç†è©•åˆ†é …åˆ†æ•¸æ”¹è®Š (é‡å° Radio Button)
            const handleScoreChange = (index, value) => {
                const newScores = [...currentScores];
                newScores[index] = parseInt(value, 10);
                setCurrentScores(newScores);
            };

            // è™•ç†è€ƒå®˜è¨»è§£æ”¹è®Š
            const handleItemNoteChange = (index, value) => {
                const newNotes = [...itemNotes];
                newNotes[index] = value;
                setItemNotes(newNotes);
            };

            // è¨ˆç®—ç¸½åˆ†
            const calculateTotalScore = useCallback(() => {
                return currentScores.reduce((sum, score) => sum + (score !== null ? score : 0), 0);
            }, [currentScores]);


            // æäº¤è€ƒç”Ÿè©•åˆ†
            const handleSubmitCandidateScore = () => {
                // æª¢æŸ¥åŸºæœ¬é¸æ“‡å™¨æ˜¯å¦å·²é¸
                if (!selectedDate || !selectedCandidateId) { // è€ƒå®˜IDå·²è‡ªå‹•å¸¶å…¥ï¼Œç„¡éœ€æª¢æŸ¥
                    setErrorMessage("è«‹å…ˆé¸æ“‡æ¸¬é©—æ—¥æœŸåŠè€ƒç”Ÿï¼");
                    setShowErrorModal(true);
                    return;
                }

                // æª¢æŸ¥æ•´é«”è¡¨ç¾æ˜¯å¦è©•åˆ†
                if (overallScore === null) {
                    setErrorMessage("è«‹é¸æ“‡è€ƒç”Ÿæ•´é«”è¡¨ç¾çš„è©•åˆ†ï¼");
                    setShowErrorModal(true);
                    return;
                }

                // æª¢æŸ¥æ‰€æœ‰é¡Œç›®æ˜¯å¦éƒ½å·²è©•åˆ†ï¼Œä¸¦æ”¶é›†æœªè©•çš„é¡Œç›®
                const unscoredItems = [];
                currentScores.forEach((score, index) => {
                    if (score === null) {
                        unscoredItems.push(dashboardData.rubric[index].item);
                    }
                });

                if (unscoredItems.length > 0) {
                    setErrorMessage(`å°šæœ‰é¡Œç›®æœªè©•åˆ†ï¼Œè«‹æª¢æŸ¥ï¼š\n${unscoredItems.map((item, idx) => `${idx + 1}. ${item}`).join('\n')}`);
                    setShowErrorModal(true);
                    return;
                }

                // è¨ˆç®—ç•¶å‰è€ƒç”Ÿçš„ç¸½åˆ†
                const currentCandidateTotalScore = calculateTotalScore();

                // é€™è£¡æ‡‰å°‡æ‰€æœ‰æ•¸æ“šæäº¤è‡³å¾Œç«¯
                console.log("æäº¤è€ƒç”Ÿè©•åˆ†:", {
                    examDate: selectedDate,
                    examinerId: selectedExaminerId,
                    candidateId: selectedCandidateId,
                    stationId: dashboardData.station.stationId,
                    scores: currentScores,
                    overallScore: overallScore, // æ•´é«”è¡¨ç¾è©•åˆ†
                    overallComment: overallComment, // æ•´é«”ç¸½è©•æ–‡å­— (ç¾åœ¨ä¸æ˜¯å¿…å¡«)
                    itemNotes: itemNotes,
                    totalScore: currentCandidateTotalScore, // ç¸½åˆ†
                    examinerFeedback: examinerFeedback, // è€ƒå®˜å›é¥‹å•å·
                    standardizedPatientFeedback: standardizedPatientFeedback // æ¨™æº–åŒ–ç—…äººå•å·
                });

                // æ›´æ–°è€ƒç”Ÿç‹€æ…‹ç‚ºå·²è©•åˆ†
                let updatedCandidates = [];
                setAllCandidates(prevCandidates => {
                    updatedCandidates = prevCandidates.map(c =>
                        c.id === selectedCandidateId
                            ? {
                                ...c,
                                scored: true,
                                savedScores: currentScores,
                                savedComment: overallComment,
                                savedOverallScore: overallScore,
                                savedItemNotes: itemNotes,
                                savedExaminerFeedback: examinerFeedback,
                                savedStandardizedPatientFeedback: standardizedPatientFeedback,
                                totalScore: currentCandidateTotalScore // Save total score
                            }
                            : c
                    );
                    return updatedCandidates;
                });

                // åˆ¤æ–·æ˜¯å¦æ‰€æœ‰è€ƒç”Ÿéƒ½å·²è©•åˆ†
                // ä½¿ç”¨æ–°çš„ updatedCandidates ä¾†åˆ¤æ–·æ˜¯å¦æ‰€æœ‰è€ƒç”Ÿéƒ½å·²è©•åˆ†
                const areAllCandidatesNowScored = updatedCandidates.every(c => c.scored);

                if (areAllCandidatesNowScored) {
                    // æ‰€æœ‰è€ƒç”Ÿéƒ½å·²è©•åˆ†ï¼Œæº–å‚™è§¸ç™¼æœ€çµ‚å•å·æ¨¡æ…‹æ¡†
                    setSelectedCandidateId(""); // æ¸…ç©ºç•¶å‰è©•åˆ†é¢æ¿
                    setOverallComment("");
                    setOverallScore(null);
                    setItemNotes(Array(dashboardData.rubric.length).fill(""));
                    setCurrentScores(Array(dashboardData.rubric.length).fill(null));
                    // è‡ªå‹•å½ˆå‡ºå•å·è¦–çª—
                    setShowFinalQuestionnairesModal(true);
                } else {
                    // è‡ªå‹•åˆ‡æ›åˆ°ä¸‹ä¸€ä½æœªè©•åˆ†çš„è€ƒç”Ÿ (å¦‚æœé‚„æœ‰)
                    const currentCandidateIndex = updatedCandidates.findIndex(c => c.id === selectedCandidateId); // Use updatedCandidates
                    let nextCandidate = null;
                    // å¾ç•¶å‰è€ƒç”Ÿä¹‹å¾Œå°‹æ‰¾æœªè©•åˆ†çš„è€ƒç”Ÿ
                    for (let i = currentCandidateIndex + 1; i < updatedCandidates.length; i++) { // Use updatedCandidates
                        if (!updatedCandidates[i].scored) { // Use updatedCandidates
                            nextCandidate = updatedCandidates[i];
                            break;
                        }
                    }
                    // å¦‚æœå¾Œé¢æ²’æœ‰ï¼Œå‰‡å¾é ­é–‹å§‹å°‹æ‰¾æœªè©•åˆ†çš„è€ƒç”Ÿ
                    if (!nextCandidate) { // Fix: Changed from !nextCandidates to !nextCandidate
                        for (let i = 0; i < updatedCandidates.length; i++) { // Use updatedCandidates
                            if (!updatedCandidates[i].scored) { // Use updatedCandidates
                                nextCandidate = updatedCandidates[i];
                                break;
                            }
                        }
                    }

                    if (nextCandidate) {
                        setSelectedCandidateId(nextCandidate.id);
                    } else {
                        // This case should ideally not be reached if `areAllCandidatesNowScored` logic is correct
                        setDashboardData(prevData => ({ ...prevData, currentCandidate: null }));
                        setSelectedCandidateId("");
                    }

                    // é‡ç½®è©•åˆ†é¢æ¿ç‹€æ…‹ï¼Œç‚ºä¸‹ä¸€ä½è€ƒç”Ÿæº–å‚™
                    setOverallComment("");
                    setOverallScore(null);
                    setItemNotes(Array(dashboardData.rubric.length).fill(""));
                    setCurrentScores(Array(dashboardData.rubric.length).fill(null)); // é‡ç½®ç‚º null å¾…è©•
                }

                console.log("è€ƒç”Ÿè©•åˆ†å·²æäº¤ï¼");
            };

            // è™•ç†æœ€çµ‚å®Œæˆæœ¬æ¬¡æ¸¬é©—è©•åˆ† (é»æ“Š"å®Œæˆæœ¬æ¬¡æ¸¬é©—è©•åˆ†"æŒ‰éˆ•)
            const handleFinalSubmitSessionTrigger = () => {
                // é¦–å…ˆæª¢æŸ¥æ‰€æœ‰è€ƒç”Ÿæ˜¯å¦çœŸçš„éƒ½è©•åˆ†äº†
                if (calculateScoredCandidates() !== allCandidates.length) {
                    setErrorMessage("ä»æœ‰è€ƒç”Ÿæœªå®Œæˆè©•åˆ†ï¼è«‹å®Œæˆæ‰€æœ‰è€ƒç”Ÿè©•åˆ†å¾Œå†é»æ“Šæ­¤æŒ‰éˆ•ã€‚");
                    setShowErrorModal(true);
                    return;
                }
                // å¦‚æœæ‰€æœ‰è€ƒç”Ÿéƒ½å·²è©•åˆ†ï¼Œå‰‡å½ˆå‡ºå•å·æ¨¡æ…‹æ¡†
                setShowFinalQuestionnairesModal(true);
            };

            // åœ¨æœ€çµ‚å•å·æ¨¡æ…‹æ¡†ä¸­æäº¤å•å·
            const handleQuestionnairesSubmit = () => {
                if (!examinerFeedback.trim() || !standardizedPatientFeedback.trim()) {
                    setErrorMessage("è«‹å¡«å¯«æ‰€æœ‰å›é¥‹å•å·æ‰èƒ½å®Œæˆæœ¬æ¬¡æ¸¬é©—ï¼");
                    setShowErrorModal(true);
                    return;
                }
                // æ‰€æœ‰æ¢ä»¶éƒ½å·²æ»¿è¶³ï¼Œé¡¯ç¤ºå®Œæˆè¨Šæ¯
                setShowFinalQuestionnairesModal(false); // é—œé–‰å•å·æ¨¡æ…‹æ¡†
                setShowCompletionMessage(true); // é¡¯ç¤ºæœ€çµ‚æ„Ÿè¬ç•«é¢
                console.log("æœ¬æ¬¡æ¸¬é©—è©•åˆ†å…¨éƒ¨å®Œæˆï¼");
            };


            // å®šç¾©ä¸»è‰²èª¿æ·±ç´«è‰²
            const highlightPurple = '#6B468C'; // è€ƒå®˜åœ–ç¤ºçš„ç´«è‰² (ç”¨æ–¼æŒ‰éˆ•å’Œé‚Šæ¡†)

            // æ–°å¢çš„æŒ‰éˆ•æŸ”å’Œé¡è‰² (åŠ æ·±è™•ç†)
            const darkerSoftBlue = '#4A7CA1'; // è¼ƒæ·±çš„è—è‰²
            const darkerSoftOrange = '#D18765'; // è¼ƒæ·±çš„æ©˜è‰²
            const darkerSoftGreen = '#82B498'; // è¼ƒæ·±çš„ç¶ è‰²


            const overallScoreDescriptions = {
                1: "å·®",
                2: "å¾…åŠ å¼·",
                3: "æ™®é€š",
                4: "è‰¯å¥½",
                5: "å„ªç§€"
            };

            const currentExaminerName = mockExaminers.find(e => e.id === selectedExaminerId)?.name || 'è€ƒå®˜';

            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-800 flex flex-col" style={{ fontFamily: 'Inter', sansSerif: 'sans-serif' }}>
                    {/* å®Œæˆæ¸¬é©—çš„æ„Ÿè¬ç•«é¢ */}
                    {showCompletionMessage && (
                        <div className="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
                            <div className="text-9xl mb-8 animate-bounce">ğŸ˜Š</div> {/* å¤§ç¬‘è‡‰å‹•ç•« */}
                            <p className="text-4xl font-bold text-gray-800 mb-4">æ„Ÿè¬æ‚¨å®Œæˆæœ¬æ¬¡ OSCE æ¸¬é©—è©•åˆ†ï¼</p>
                            <p className="text-xl text-gray-600">æ‚¨çš„è²¢ç»å°æˆ‘å€‘è‡³é—œé‡è¦ã€‚</p>
                        </div>
                    )}

                    {/* é ‚éƒ¨å°è¦½åˆ— - åƒç…§è€ƒç”Ÿé é¢æ¨£å¼ */}
                    <header className="text-white shadow-md p-4 sticky top-0 z-10" style={{ backgroundColor: highlightPurple }}>
                        <div className="max-w-7xl mx-auto flex justify-between items-center w-full">
                            {/* å·¦å´å¤§æ¨™é¡Œ */}
                            <h1 className="text-2xl font-bold">å¥‡ç¾é†«é™¢ OSCE è€ƒå®˜è©•åˆ†å„€è¡¨æ¿</h1>

                            {/* å³å´è€ƒå®˜è³‡è¨Šèˆ‡æ™‚é–“ */}
                            <div className="flex items-center space-x-4 text-base md:text-lg">
                                <span className="font-semibold">{currentExaminerName} ä½ å¥½</span>
                                <span>{new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' })}</span>
                                <span>{new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                        </div>
                    </header>

                    {/* ä¸»è¦å…§å®¹å€å¡Š - é¡ä¼¼è€ƒç”Ÿé é¢çš„å¯¬åº¦ */}
                    <main className="flex-1 max-w-7xl mx-auto py-6 px-4 md:px-6 lg:px-8">

                        {/* é ‚éƒ¨ç™½åº•è³‡è¨Šæ¡† */}
                        <div className="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4" style={{ borderColor: highlightPurple }}>
                            {/* æ¸¬é©—æ—¥æœŸã€è€ƒç”Ÿé¸æ“‡ */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6 mb-4">
                                <div className="flex flex-col">
                                    <label htmlFor="exam-date-main" className="font-semibold text-gray-700 mb-1">æ¸¬é©—æ—¥æœŸ:</label>
                                    <input
                                        type="date"
                                        id="exam-date-main"
                                        value={selectedDate}
                                        onChange={(e) => setSelectedDate(e.target.value)}
                                        className="p-2 rounded-md border border-gray-300 text-gray-800 bg-white w-full"
                                    />
                                </div>
                                <div className="flex flex-col">
                                    <label htmlFor="candidate-select-main" className="font-semibold text-gray-700 mb-1">è€ƒç”Ÿ:</label>
                                    <select
                                        id="candidate-select-main"
                                        value={selectedCandidateId}
                                        onChange={(e) => setSelectedCandidateId(e.target.value)}
                                        className="p-2 rounded-md border border-gray-300 text-gray-800 bg-white w-full"
                                    >
                                        <option value="">è«‹é¸æ“‡è€ƒç”Ÿ</option>
                                        {allCandidates.map(candidate => (
                                            <option key={candidate.id} value={candidate.id}>
                                                {candidate.name} ({candidate.ticket}) {candidate.scored ? '(å·²è©•)' : ''}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            {/* ç›®å‰çš„ç«™åˆ¥ã€å·²è©•è€ƒç”Ÿæ•¸ã€å‰©é¤˜æ™‚é–“ */}
                            <div className="flex flex-wrap items-center gap-x-6 gap-y-2 pt-4 border-t border-gray-200">
                                <span className="font-extrabold text-xl text-gray-800">ç›®å‰ç«™åˆ¥: Station {dashboardData.station.stationId} ({dashboardData.station.title})</span> {/* Enlarged text */}
                                <span className="font-semibold text-gray-800">å·²è©•è€ƒç”Ÿ: {calculateScoredCandidates()} / {allCandidates.length}</span>
                                {sessionTimeLeft > 0 && ( /* Removed "å·²çµæŸ" text */
                                    <span className={`font-semibold px-2 py-0.5 rounded-full ${sessionTimeLeft <= 300 ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`}>
                                    æœ¬å ´æ¬¡å‰©é¤˜ï¼š{formatTime(sessionTimeLeft)}
                                    </span>
                                )}
                            </div>

                            {/* æ•™æ¡ˆæŒ‡å¼•æŒ‰éˆ• (å·²è©•æ ¸å­¸å“¡æ‰€æœ‰æˆç¸¾è¦–è¦ºåŒ– æŒ‰éˆ•å·²ç§»é™¤) */}
                            <div className="flex flex-wrap justify-start gap-4 pt-4 mt-4 border-t border-gray-200">
                                <button
                                    onClick={() => setShowTeachingGuideModal(true)}
                                    className="flex-1 min-w-[150px] max-w-[200px] text-white py-2 rounded-lg hover:opacity-90 transition duration-200 ease-in-out text-lg font-bold shadow-md"
                                    style={{ backgroundColor: darkerSoftBlue }}
                                >
                                    æ•™æ¡ˆæŒ‡å¼•
                                </button>
                            </div>

                            {/* å·²è©•æ ¸è€ƒç”Ÿæˆç¸¾ä¿®æ”¹æŒ‰éˆ• */}
                            <div className="flex justify-end pt-4 border-t border-gray-200 mt-4">
                                <button
                                    onClick={() => setShowCandidateListModal(true)}
                                    className="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm font-medium"
                                >
                                    å·²è©•æ ¸è€ƒç”Ÿæˆç¸¾ä¿®æ”¹
                                </button>
                            </div>
                        </div>


                        {/* è©•åˆ†é¢æ¿ */}
                        <section className="bg-white p-6 rounded-lg shadow-xl flex flex-col space-y-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                                è©•åˆ†é¢æ¿ - è€ƒç”Ÿ: {dashboardData.currentCandidate?.name || "è«‹é¸æ“‡è€ƒç”Ÿ"} ({dashboardData.currentCandidate?.ticket || "N/A"})
                            </h2>

                            {(!selectedCandidateId) ? ( // Check only selectedCandidateId
                                <p className="text-center text-gray-600 text-lg mt-8">è«‹å…ˆé¸æ“‡æ¸¬é©—æ—¥æœŸåŠè€ƒç”Ÿé–‹å§‹è©•åˆ†ã€‚</p>
                            ) : (
                                <>
                                    {/* è©•åˆ†é …ç›® (ä½¿ç”¨ Radio Button å’Œè€ƒå®˜è¨»è§£) */}
                                    <div className="space-y-4">
                                        {/* è©•åˆ†é¸é …æ¨™é¡Œ */}
                                        <div className="grid grid-cols-12 gap-2 mb-2 text-sm font-semibold text-gray-600 border-b pb-2">
                                            <div className="col-span-5 md:col-span-4"></div>
                                            <div className="col-span-3 md:col-span-3 text-center">
                                                <div className="flex justify-around items-center w-full"> {/* Use w-full for full width */}
                                                    <span className="w-1/3 text-nowrap">æ²’æœ‰åšåˆ° 0åˆ†</span>
                                                    <span className="w-1/3 text-nowrap">éƒ¨åˆ†åšåˆ° 1åˆ†</span>
                                                    <span className="w-1/3 text-nowrap">å®Œå…¨åšåˆ° 2åˆ†</span>
                                                </div>
                                            </div>
                                            <div className="col-span-4 md:col-span-5 text-center">è€ƒå®˜è¨»è§£</div>
                                        </div>
                                        {dashboardData.rubric.map((item, index) => (
                                            <div key={index} className="grid grid-cols-12 items-center p-3 bg-gray-50 rounded-md relative">
                                                {/* é¡Œç›®åç¨± */}
                                                <label htmlFor={`score-${index}`} className="text-base font-medium text-gray-700 col-span-5 md:col-span-4 flex items-center">
                                                    {index + 1}. {item.item}
                                                    {/* æç¤ºç¬¦è™Ÿ */}
                                                    {item.description && (
                                                        <div className="relative group ml-2">
                                                            <span className="text-blue-500 cursor-help text-lg">â“˜</span> {/* Info icon */}
                                                            {/* Tooltip on hover */}
                                                            <div className="absolute left-full ml-2 top-1/2 -translate-y-1/2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20 whitespace-normal pointer-events-none">
                                                                <p className="font-bold mb-1">éƒ¨åˆ†åšåˆ° (1åˆ†):</p>
                                                                <p className="mb-2">{item.description["1"]}</p>
                                                                <p className="font-bold mb-1">å®Œå…¨åšåˆ° (2åˆ†):</p>
                                                                <p>{item.description["2"]}</p>
                                                            </div>
                                                        </div>
                                                    )}
                                                </label>

                                                {/* Radio Buttons - å„ªåŒ–é–“è· */}
                                                <div className="col-span-3 md:col-span-3 flex justify-around items-center w-full"> {/* Use w-full for full width */}
                                                    <label className="flex items-center space-x-1 cursor-pointer p-1">
                                                        <input
                                                            type="radio"
                                                            id={`score-${index}-0`}
                                                            name={`rubric-item-${index}`}
                                                            value="0"
                                                            checked={currentScores[index] === 0}
                                                            onChange={(e) => handleScoreChange(index, e.target.value)}
                                                            className="form-radio h-5 w-5 text-blue-600"
                                                        />
                                                        <span className="text-sm"></span>
                                                    </label>
                                                    <label className="flex items-center space-x-1 cursor-pointer p-1">
                                                        <input
                                                            type="radio"
                                                            id={`score-${index}-1`}
                                                            name={`rubric-item-${index}`}
                                                            value="1"
                                                            checked={currentScores[index] === 1}
                                                            onChange={(e) => handleScoreChange(index, e.target.value)}
                                                            className="form-radio h-5 w-5 text-blue-600"
                                                        />
                                                        <span className="text-sm"></span>
                                                    </label>
                                                    <label className="flex items-center space-x-1 cursor-pointer p-1">
                                                        <input
                                                            type="radio"
                                                            id={`score-${index}-2`}
                                                            name={`rubric-item-${index}`}
                                                            value="2"
                                                            checked={currentScores[index] === 2}
                                                            onChange={(e) => handleScoreChange(index, e.target.value)}
                                                            className="form-radio h-5 w-5 text-blue-600"
                                                        />
                                                        <span className="text-sm"></span>
                                                    </label>
                                                </div>
                                                {/* è€ƒå®˜è¨»è§£ */}
                                                <div className="col-span-4 md:col-span-5">
                                                    <textarea
                                                        rows="1"
                                                        className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                                        placeholder="è€ƒå®˜è¨»è§£ (é¸å¡«)"
                                                        value={itemNotes[index]}
                                                        onChange={(e) => handleItemNoteChange(index, e.target.value)}
                                                    ></textarea>
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    {/* æ•´é«”ç¸½è©•å€å¡Š */}
                                    <div className="mt-8 pt-6 border-t border-gray-200">
                                        <div className="flex justify-between items-end mb-4">
                                            <p className="block text-lg font-bold text-gray-800 mb-0">
                                                æ‚¨èªç‚ºè€ƒç”Ÿæ•´é«”è¡¨ç¾å¦‚ä½•ï¼š
                                            </p>
                                            {/* ç¸½åˆ†é¡¯ç¤º */}
                                            <div className="flex items-baseline space-x-2">
                                                <span className="text-2xl font-bold text-gray-900">ç¸½åˆ†:</span>
                                                <span className="text-4xl font-extrabold" style={{ color: highlightPurple }}>{calculateTotalScore()}</span>
                                                <span className="text-2xl font-bold text-gray-900">åˆ†</span>
                                            </div>
                                        </div>

                                        {/* è€ƒç”Ÿæ•´é«”è¡¨ç¾è©•åˆ† - å„ªåŒ–ä½ˆå±€ */}
                                        <div className="mb-4 grid grid-cols-5 gap-0 border border-gray-200 rounded-md p-0 overflow-hidden" style={{ borderColor: highlightPurple }}> {/* Apply border to container, set gap to 0 */}
                                            {[1, 2, 3, 4, 5].map(score => (
                                                <label key={score} className="flex flex-col items-center justify-center cursor-pointer p-2 hover:bg-gray-100 transition-colors duration-150 relative border-r last:border-r-0" style={{ borderColor: highlightPurple }}> {/* Add right border */}
                                                    <span className="text-base font-medium text-gray-700 mb-1">
                                                        {overallScoreDescriptions[score]}
                                                    </span>
                                                    <div className="flex items-center space-x-1">
                                                        <input
                                                            type="radio"
                                                            name="overall-performance"
                                                            value={score}
                                                            checked={overallScore === score}
                                                            onChange={(e) => setOverallScore(parseInt(e.target.value))}
                                                            className="form-radio h-5 w-5 text-purple-600"
                                                        />
                                                        <span className="text-base text-gray-700">{score}åˆ†</span>
                                                    </div>
                                                </label>
                                            ))}
                                        </div>

                                        <p className="block text-lg font-bold text-gray-800 mb-2">
                                            è©•èªï¼š
                                        </p>
                                        <textarea
                                            id="overall-comment"
                                            rows="4"
                                            className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="è«‹è¼¸å…¥æ•´é«”ç¸½è©•èª (é¸å¡«)..."
                                            value={overallComment}
                                            onChange={(e) => setOverallComment(e.target.value)}
                                        ></textarea>
                                    </div>

                                    {/* æäº¤æŒ‰éˆ• */}
                                    {calculateScoredCandidates() === allCandidates.length ? (
                                        <button
                                            onClick={handleFinalSubmitSessionTrigger} // Changed to trigger the final questionnaire modal first
                                            className="w-full text-white py-3 mt-6 rounded-lg hover:opacity-90 transition duration-200 ease-in-out text-lg font-bold shadow-lg"
                                            style={{ backgroundColor: highlightPurple }}
                                        >
                                            å®Œæˆæœ¬æ¬¡æ¸¬é©—è©•åˆ†
                                        </button>
                                    ) : (
                                        <button
                                            onClick={handleSubmitCandidateScore}
                                            className="w-full text-white py-3 mt-6 rounded-lg hover:opacity-90 transition duration-200 ease-in-out text-lg font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                            style={{ backgroundColor: highlightPurple }}
                                            disabled={!selectedCandidateId}
                                        >
                                            æäº¤ {dashboardData.currentCandidate?.ticket || "è€ƒç”Ÿ"} è©•åˆ†
                                        </button>
                                    )}
                                </>
                            )}
                        </section>
                    </main>

                    {/* è‡ªå®šç¾©éŒ¯èª¤æç¤ºæ¨¡æ…‹æ¡† */}
                    {showErrorModal && (
                        <div className="fixed inset-0 bg-red-600 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
                                <h3 className="text-xl font-bold mb-4 text-red-700">éŒ¯èª¤æç¤º</h3>
                                <p className="mb-6 text-gray-700 whitespace-pre-wrap">
                                    {errorMessage}
                                </p>
                                <button
                                    onClick={() => setShowErrorModal(false)}
                                    className="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition duration-150 ease-in-out"
                                >
                                    ç¢ºå®š
                                </button>
                            </div>
                        </div>
                    )}

                    {/* å·²è©•æ ¸è€ƒç”Ÿæˆç¸¾ä¿®æ”¹åˆ—è¡¨æ¨¡æ…‹æ¡† */}
                    {showCandidateListModal && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full text-left">
                                <h3 className="text-xl font-bold mb-4 text-gray-800 border-b pb-2">é¸æ“‡è€ƒç”Ÿé€²è¡Œä¿®æ”¹</h3>
                                <p className="mb-4 text-gray-700">é»æ“Šè€ƒç”Ÿå§“åå³å¯è¼‰å…¥å…¶è©•åˆ†æ•¸æ“šé€²è¡Œä¿®æ”¹ã€‚</p>
                                <div className="max-h-96 overflow-y-auto border border-gray-200 rounded-md p-2">
                                    {allCandidates.map(candidate => (
                                        <div
                                            key={candidate.id}
                                            className={`flex items-center justify-between p-3 my-1 rounded-md cursor-pointer transition duration-150 ease-in-out ${
                                                candidate.id === selectedCandidateId ? 'bg-blue-100 border-blue-500' : 'bg-gray-50 hover:bg-gray-100'
                                            }`}
                                            onClick={() => {
                                                setSelectedCandidateId(candidate.id);
                                                setShowCandidateListModal(false); // é¸æ“‡å¾Œé—œé–‰æ¨¡æ…‹æ¡†
                                            }}
                                        >
                                            <span className="font-medium text-lg text-gray-800">
                                                {candidate.name} ({candidate.ticket})
                                            </span>
                                            {candidate.scored ? (
                                                <span className="text-green-600 font-semibold text-sm ml-2">
                                                    (å·²è©• - ç¸½åˆ†: {candidate.totalScore !== undefined ? candidate.totalScore : 'N/A'})
                                                </span>
                                            ) : (
                                                <span className="text-gray-500 text-sm">æœªè©•åˆ†</span>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-6 flex justify-end">
                                    <button
                                        onClick={() => setShowCandidateListModal(false)}
                                        className="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out"
                                    >
                                        é—œé–‰
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* æ•™æ¡ˆæŒ‡å¼•æ¨¡æ…‹æ¡† */}
                    {showTeachingGuideModal && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-8 rounded-lg shadow-xl max-w-4xl w-full h-5/6 flex flex-col">
                                <h3 className="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">{teachingGuideContent.title}</h3>
                                <div className="overflow-y-auto flex-1 pr-4"> {/* Added pr-4 for scrollbar space */}
                                    {teachingGuideContent.sections.map((section, index) => (
                                        <div key={index} className="mb-6">
                                            <h4 className="text-xl font-semibold text-gray-700 mb-2" style={{ color: highlightPurple }}>{section.heading}</h4>
                                            <p className="text-gray-700 whitespace-pre-wrap">{section.content}</p>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-6 flex justify-end border-t pt-4">
                                    <button
                                        onClick={() => setShowTeachingGuideModal(false)}
                                        className="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out"
                                    >
                                        é—œé–‰
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* è€ƒå®˜å›é¥‹å•å· & è©•æ ¸æ¨™æº–åŒ–ç—…äººå•å·çš„æ•´åˆæ¨¡æ…‹æ¡† */}
                    {showFinalQuestionnairesModal && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-8 rounded-lg shadow-xl max-w-3xl w-full flex flex-col">
                                <h3 className="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">å®Œæˆæ¸¬é©—å‰è«‹å¡«å¯«å›é¥‹å•å·</h3>
                                <div className="overflow-y-auto flex-1 pr-4 space-y-6">
                                    {/* è€ƒå®˜å›é¥‹å•å· */}
                                    <div>
                                        <label htmlFor="examiner-feedback-final" className="block text-lg font-bold text-gray-800 mb-2">
                                            è€ƒå®˜å›é¥‹å•å·ï¼š
                                        </label>
                                        <textarea
                                            id="examiner-feedback-final"
                                            rows="8"
                                            className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="è«‹è¼¸å…¥è€ƒå®˜å°æœ¬æ¬¡è€ƒè©¦çš„å›é¥‹å…§å®¹..."
                                            value={examinerFeedback}
                                            onChange={(e) => setExaminerFeedback(e.target.value)}
                                        ></textarea>
                                    </div>
                                    {/* è©•æ ¸æ¨™æº–åŒ–ç—…äººå•å· */}
                                    <div>
                                        <label htmlFor="standardized-patient-feedback-final" className="block text-lg font-bold text-gray-800 mb-2">
                                            è©•æ ¸æ¨™æº–åŒ–ç—…äººå•å·ï¼š
                                        </label>
                                        <textarea
                                            id="standardized-patient-feedback-final"
                                            rows="8"
                                            className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="è«‹è¼¸å…¥æ‚¨å°æ¨™æº–åŒ–ç—…äººçš„è©•æ ¸å…§å®¹..."
                                            value={standardizedPatientFeedback}
                                            onChange={(e) => setStandardizedPatientFeedback(e.target.value)}
                                        ></textarea>
                                    </div>
                                </div>
                                <div className="mt-6 flex justify-end border-t pt-4">
                                    <button
                                        onClick={handleQuestionnairesSubmit}
                                        className="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-150 ease-in-out font-bold"
                                    >
                                        æäº¤å•å·ä¸¦å®Œæˆæ¸¬é©—
                                    </button>
                                    <button
                                        onClick={() => setShowFinalQuestionnairesModal(false)}
                                        className="ml-4 bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out"
                                    >
                                        ç¨å¾Œå†å¡«å¯« (é—œé–‰)
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Render the App component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

