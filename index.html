<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奇美醫院臨床技能中心OSCE問卷滿意度成效儀表板</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* Bauhaus Theme Variables */
        :root {
            --bauhaus-red: #D03328;
            --bauhaus-yellow: #EAB936;
            --bauhaus-blue: #1C4E8C;
            --bauhaus-white: #FCFBF9;
            --bauhaus-black: #1A1A1A;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bauhaus-white);
            color: var(--bauhaus-black);
            background-image: radial-gradient(var(--bauhaus-black) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Utility Classes */
        .bauhaus-border {
            border: 3px solid var(--bauhaus-black);
        }
        .bauhaus-shadow {
            box-shadow: 6px 6px 0px 0px var(--bauhaus-black);
        }
        .bauhaus-shadow-sm {
            box-shadow: 3px 3px 0px 0px var(--bauhaus-black);
        }
        .bauhaus-shadow-hover:hover {
            box-shadow: 8px 8px 0px 0px var(--bauhaus-black);
            transform: translate(-2px, -2px);
        }
        
        /* Sidebar Link Active State */
        .nav-link {
            cursor: pointer;
            text-decoration: none; /* For a tags */
        }
        .nav-link.active {
            background-color: var(--bauhaus-yellow);
            color: var(--bauhaus-black);
            border-color: var(--bauhaus-black);
            font-weight: 900;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
            transform: translateY(-4px);
        }
        .nav-link:hover:not(.active) {
            background-color: #333;
            border-color: white;
            color: white;
        }

        /* View Switching Animations */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #1A1A1A;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Tag Styles for Keywords */
        .keyword-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: bold;
            border: 2px solid #1A1A1A;
            margin: 2px;
        }
        .keyword-pos { background-color: #EAB936; color: black; }
        .keyword-neg { background-color: #D03328; color: white; }
    </style>
</head>
<body class="overflow-hidden h-screen w-screen">

    <!-- Modal (Hidden by default) -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white border-[4px] border-black w-full max-w-md p-6 bauhaus-shadow relative transform transition-all scale-95 opacity-0" id="modal-content">
            <button onclick="closeModal()" class="absolute top-2 right-2 p-1 hover:bg-gray-100 border-2 border-transparent hover:border-black rounded-full">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <div class="flex items-center gap-4 mb-4">
                <div class="bg-[#EAB936] p-3 border-[3px] border-black rounded-full">
                    <i data-lucide="info" class="w-6 h-6 text-black"></i>
                </div>
                <h3 class="text-xl font-black uppercase tracking-wide">System Notice</h3>
            </div>
            
            <p id="modal-message" class="text-lg font-bold mb-6">Message goes here...</p>
            
            <button onclick="closeModal()" class="w-full bg-[#1C4E8C] text-white font-bold py-3 border-[3px] border-black hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-none shadow-[4px_4px_0px_0px_black] transition-all">
                UNDERSTOOD
            </button>
        </div>
    </div>

    <!-- Configuration Alert (Shows if URL is missing) -->
    <div id="config-alert" class="hidden fixed top-0 left-0 w-full bg-[#D03328] text-white p-2 text-center font-bold z-[70] border-b-4 border-black animate-pulse">
        ⚠️ 請在程式碼中設定正確的 GAS_API_URL 才能讀取真實數據！
    </div>

    <!-- Main Flex Container -->
    <div class="flex h-screen flex-col">

        <!-- Header -->
        <header class="bg-[#1C4E8C] text-white border-b-[4px] border-black z-50 flex-shrink-0">
            <div class="w-full px-4 py-3 flex justify-between items-center relative overflow-hidden">
                <!-- Decorative Circle -->
                <div class="absolute top-[-20px] left-[-20px] w-20 h-20 bg-[#EAB936] rounded-full border-[3px] border-black z-0"></div>
                
                <div class="flex items-center gap-4 z-10 pl-8">
                    <div class="bg-white p-1.5 border-[3px] border-black shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]">
                        <img src="https://www.chimei.org.tw/main/cmh_department/59012/mag/202111/images/logo.png" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2ZmZiIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5DTSBIb3NwaXRhbDwvdGV4dD48L3N2Zz4='"
                             alt="Logo" class="h-6 md:h-8 w-auto object-contain">
                    </div>
                    <div>
                        <h1 class="text-lg md:text-2xl font-black tracking-wide leading-none">臨床技能中心</h1>
                        <p class="text-[10px] md:text-xs font-bold text-[#EAB936] tracking-widest uppercase">OSCE Dashboard System</p>
                    </div>
                </div>

                <div class="flex items-center gap-3 z-10">
                    <div class="hidden md:flex items-center bg-black px-3 py-1 rounded-full border border-white">
                        <span id="system-status-dot" class="w-2 h-2 bg-yellow-500 rounded-full mr-2 animate-pulse"></span>
                        <span id="system-status-text" class="text-xs font-mono">Connecting...</span>
                    </div>
                    <button class="md:hidden p-2 bg-black border-2 border-white rounded-md" onclick="toggleSidebar()">
                        <i data-lucide="menu" class="w-5 h-5 text-white"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Body Container -->
        <div class="flex flex-1 overflow-hidden relative">
            
            <!-- Left Sidebar -->
            <aside id="sidebar" class="absolute md:relative w-64 bg-[#1A1A1A] text-white border-r-[4px] border-black flex flex-col h-full z-40 shadow-[4px_0_10px_rgba(0,0,0,0.5)] transform -translate-x-full md:translate-x-0 transition-transform duration-300">
                
                <!-- Filter Section -->
                <div class="p-5 border-b-2 border-gray-800 bg-[#222]">
                    <h3 class="text-[#EAB936] text-xs font-bold uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i data-lucide="filter" class="w-3 h-3"></i> 篩選條件 Filters
                    </h3>
                    
                    <div class="space-y-3">
                        <!-- Year Filter -->
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">年度 Year</label>
                            <div class="relative">
                                <select id="year-filter" onchange="updateDateOptions(); applyGlobalFilters();" class="w-full bg-black border-2 border-gray-600 text-white text-sm p-2 outline-none focus:border-[#EAB936] appearance-none rounded-none cursor-pointer">
                                    <option value="all">全部年度 All</option>
                                    <option value="2025">2025 年度</option>
                                    <option value="2024">2024 年度</option>
                                    <option value="2023">2023 年度</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Session/Date Filter -->
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">場次 Session</label>
                            <div class="relative">
                                <select id="date-filter" onchange="applyGlobalFilters()" class="w-full bg-black border-2 border-gray-600 text-white text-sm p-2 outline-none focus:border-[#EAB936] appearance-none rounded-none cursor-pointer">
                                    <option value="all">全部場次 All</option>
                                    <!-- Populated by JS -->
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Profession Filter (Only for SP Analysis) -->
                        <div id="prof-filter-container">
                            <label class="text-xs text-gray-400 block mb-1">職類 Profession</label>
                            <div class="relative">
                                <select id="profession-filter" onchange="applyGlobalFilters()" class="w-full bg-black border-2 border-gray-600 text-white text-sm p-2 outline-none focus:border-[#EAB936] appearance-none rounded-none cursor-pointer">
                                    <option value="all">全部職類 All</option>
                                    <option value="西醫">西醫</option>
                                    <option value="牙醫">牙醫</option>
                                    <option value="中醫">中醫</option>
                                    <option value="護理">護理</option>
                                    <option value="藥師">藥師</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="p-4 space-y-8 flex-1 overflow-y-auto custom-scroll">
                    
                    <!-- Group 1: Dashboard -->
                    <div>
                        <h3 class="text-gray-500 text-xs font-bold uppercase tracking-widest mb-3 pl-2 border-l-2 border-[#1C4E8C]">
                            儀表板 Dashboard
                        </h3>
                        <div class="space-y-2">
                            <div onclick="switchView('dashboard')" id="nav-dashboard" class="nav-link active block p-3 border-2 transition-all">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                                    <span class="font-bold text-sm">綜合分析總覽</span>
                                </div>
                            </div>

                            <div onclick="switchView('examiner-sp-analysis')" id="nav-examiner-sp-analysis" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all opacity-70 hover:opacity-100">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="clipboard-check" class="w-4 h-4"></i>
                                    <span class="font-bold text-sm">考官評核 SP 分析</span>
                                </div>
                            </div>

                            <div onclick="switchView('examiner-analysis')" id="nav-examiner-analysis" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all opacity-70 hover:opacity-100">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
                                    <span class="font-bold text-sm">考官回饋分析</span>
                                    <span class="text-[10px] bg-[#EAB936] text-black px-1 ml-auto font-bold rounded">NEW</span>
                                </div>
                            </div>

                            <div onclick="switchView('student-analysis')" id="nav-student-analysis" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all opacity-70 hover:opacity-100">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="graduation-cap" class="w-4 h-4"></i>
                                    <span class="font-bold text-sm">考生回饋分析</span>
                                </div>
                            </div>

                            <div onclick="switchView('sp-analysis')" id="nav-sp-analysis" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all opacity-70 hover:opacity-100">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="smile" class="w-4 h-4"></i>
                                    <span class="font-bold text-sm">標準化病人回饋分析</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Group 2: Survey Entry -->
                    <div>
                        <h3 class="text-gray-500 text-xs font-bold uppercase tracking-widest mb-3 pl-2 border-l-2 border-[#D03328]">
                            問卷填寫 Survey Entry
                        </h3>
                        <div class="space-y-2">
                            <a href="https://luyun1224.github.io/ChimeiOSCE/SP-Assessment-Examiner.html" target="_blank" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all group">
                                <div class="flex items-center justify-between">
                                    <span class="font-bold text-sm">考官評核 SP</span>
                                    <i data-lucide="external-link" class="w-3 h-3 group-hover:text-[#EAB936] transition-colors"></i>
                                </div>
                            </a>
                        </div>
                    </div>

                </nav>

                <!-- Footer Info -->
                <div class="p-4 text-[10px] text-gray-500 text-center border-t-2 border-gray-800">
                    <p>v2.1.0 (Dual Insight Engine)</p>
                    <p>Designed for Chimei</p>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto bg-[#FCFBF9] relative custom-scroll">
                
                <!-- Close sidebar overlay for mobile -->
                <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

                <!-- VIEW 1: DASHBOARD (Landing) -->
                <div id="view-dashboard" class="p-4 md:p-8 animate-fade-in block">
                     <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8 border-b-2 border-black pb-4">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-black flex flex-col md:flex-row md:items-center gap-3 leading-tight">
                                <div class="flex items-center gap-3">
                                    <span class="w-4 h-8 bg-[#D03328] border-2 border-black block flex-shrink-0"></span>
                                    <span>奇美醫院臨床技能中心</span>
                                </div>
                                <span>OSCE成效儀表板</span>
                            </h2>
                            <p class="text-gray-500 font-bold mt-1 ml-7">OSCE Effectiveness & Insight Dashboard</p>
                        </div>
                         <div class="text-right flex gap-2">
                             <button onclick="fetchAllData()" class="bg-black text-white px-4 py-2 text-xs font-bold hover:bg-[#EAB936] hover:text-black transition-colors border border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)]">
                                <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i> REFRESH ALL
                            </button>
                        </div>
                    </div>

                    <div class="bg-white border-[3px] border-black p-8 bauhaus-shadow flex flex-col items-center justify-center text-gray-400 min-h-[300px]">
                        <div class="bg-[#EAB936] p-4 rounded-full border-[3px] border-black mb-4">
                            <i data-lucide="bar-chart-2" class="w-12 h-12 text-black"></i>
                        </div>
                        <h3 class="text-2xl font-black text-black mb-2 text-center">歡迎使用成效分析系統</h3>
                        <p class="text-sm max-w-md text-center mb-6 text-gray-600">本系統提供多面向的數據視覺化與 AI 行動建議。請從左側選單選擇您欲分析的模組。</p>
                        <div class="flex gap-4">
                            <button onclick="switchView('examiner-sp-analysis')" class="bg-[#1C4E8C] text-white px-6 py-3 font-bold border-[3px] border-black shadow-[4px_4px_0px_0px_black] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_black] transition-all flex items-center gap-2">
                                <span>考官評核 SP 分析</span>
                            </button>
                             <button onclick="switchView('examiner-analysis')" class="bg-[#D03328] text-white px-6 py-3 font-bold border-[3px] border-black shadow-[4px_4px_0px_0px_black] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_black] transition-all flex items-center gap-2">
                                <span>考官回饋分析</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: EXAMINER SP ANALYSIS (Restored Original) -->
                <div id="view-examiner-sp-analysis" class="p-4 md:p-8 animate-fade-in hidden">
                    <!-- Title Section -->
                    <div class="flex justify-between items-end border-b-2 border-black pb-4 mb-8">
                        <div>
                            <h2 class="text-3xl font-black flex items-center gap-3">
                                <span class="w-4 h-8 bg-[#1C4E8C] border-2 border-black block"></span>
                                考官評核 SP 分析
                            </h2>
                            <p class="text-gray-500 font-bold mt-1 ml-7">Examiner Assessment: 8 Dimensions & Insights</p>
                        </div>
                        <div class="text-right hidden md:block">
                             <div class="text-xs text-gray-400 font-bold">DATA SOURCE</div>
                             <div class="font-mono text-sm">SP Assessment Sheet</div>
                        </div>
                    </div>

                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white border-[3px] border-black p-5 bauhaus-shadow relative overflow-hidden group">
                            <div class="absolute right-[-10px] top-[-10px] w-20 h-20 bg-gray-100 rounded-full z-0 group-hover:bg-[#EAB936] transition-colors"></div>
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">總問卷樣本數</p>
                                <h3 class="text-4xl font-black" id="sp-stat-total">--</h3>
                                <div class="w-8 h-1 bg-black mt-2"></div>
                            </div>
                        </div>
                        <div class="bg-[#1A1A1A] text-white border-[3px] border-black p-5 bauhaus-shadow relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-400 uppercase tracking-widest mb-1">平均總體得分</p>
                                <h3 class="text-4xl font-black text-[#EAB936]" id="sp-stat-avg">--</h3>
                                <p class="text-[10px] text-gray-500 mt-1">(反向題 Q2, Q3 已校正)</p>
                            </div>
                        </div>
                        <div class="bg-[#D03328] text-white border-[3px] border-black p-5 bauhaus-shadow relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-white/80 uppercase tracking-widest mb-1">Q1 可靠一致性</p>
                                <h3 class="text-4xl font-black text-white" id="sp-stat-q1">--</h3>
                                <p class="text-[10px] text-white/60 mt-1">Core Competency</p>
                            </div>
                        </div>
                        <div class="bg-white border-[3px] border-black p-5 bauhaus-shadow relative overflow-hidden">
                             <div class="absolute right-[-10px] top-[-10px] w-20 h-20 bg-blue-50 rounded-full z-0"></div>
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">Q8 專業態度</p>
                                <h3 class="text-4xl font-black text-[#1C4E8C]" id="sp-stat-q8">--</h3>
                                <p class="text-[10px] text-gray-400 mt-1">Higher is Better</p>
                            </div>
                        </div>
                    </div>

                    <!-- Main Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold border-l-4 border-[#1C4E8C] pl-3">八大面向能力分析</h3>
                                <span class="bg-gray-100 text-xs font-bold px-2 py-1 rounded border border-gray-300">Radar Chart</span>
                            </div>
                            <div class="flex-1 min-h-[320px] relative">
                                <canvas id="chart-sp-radar"></canvas>
                            </div>
                        </div>

                        <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold border-l-4 border-[#EAB936] pl-3">各職類評分差異</h3>
                                <span class="bg-gray-100 text-xs font-bold px-2 py-1 rounded border border-gray-300">Bar Chart</span>
                            </div>
                            <div class="flex-1 min-h-[320px] relative">
                                <canvas id="chart-sp-bar"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Insight Engine (SP) -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <div class="lg:col-span-2 bg-white border-[3px] border-black p-6 bauhaus-shadow">
                            <div class="flex items-center gap-2 mb-6 border-b-2 border-gray-100 pb-2">
                                <div class="bg-black text-white p-1.5"><i data-lucide="message-square" class="w-4 h-4"></i></div>
                                <h3 class="text-xl font-bold">考官質性回饋與關鍵字</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">高頻關鍵字 (Top Keywords)</h4>
                                    <div id="sp-keyword-cloud" class="flex flex-wrap gap-2 min-h-[100px] content-start">
                                        <span class="text-gray-400 italic text-sm">Analyzing text...</span>
                                    </div>
                                </div>
                                <div class="border-l-2 border-gray-100 pl-4">
                                    <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">最新評語 (Latest Comments)</h4>
                                    <div id="sp-comments-list" class="space-y-3 max-h-[200px] overflow-y-auto custom-scroll pr-2"></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-[#1A1A1A] text-white border-[3px] border-black p-6 bauhaus-shadow relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-[#2a2a2a] rounded-bl-full -z-0"></div>
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex items-center gap-2 mb-4 border-b border-gray-700 pb-2">
                                    <div class="bg-[#EAB936] text-black p-1.5"><i data-lucide="zap" class="w-4 h-4"></i></div>
                                    <h3 class="text-xl font-bold">品質改善行動</h3>
                                </div>
                                <div class="flex-1">
                                    <div class="mb-4">
                                        <h4 class="text-xs font-bold text-[#EAB936] uppercase tracking-wider mb-1">優先改善面向 (Priority)</h4>
                                        <div id="sp-action-priority" class="text-lg font-bold">--</div>
                                    </div>
                                    <div class="mb-4">
                                        <h4 class="text-xs font-bold text-[#D03328] uppercase tracking-wider mb-2 flex items-center gap-1">
                                            <i data-lucide="alert-circle" class="w-3 h-3"></i> 需關注 SP 名單
                                        </h4>
                                        <ul id="sp-watchlist" class="text-sm space-y-2 bg-[#222] p-2 rounded border border-gray-700">
                                            <li class="text-gray-400 italic">分析中...</li>
                                        </ul>
                                    </div>
                                    <div class="mb-2">
                                        <h4 class="text-xs font-bold text-[#EAB936] uppercase tracking-wider mb-1">AI 建議行動</h4>
                                        <p id="sp-action-suggestion" class="text-xs text-gray-300 leading-relaxed">...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow">
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold border-l-4 border-gray-400 pl-3">詳細數據列表</h3>
                            <button onclick="exportCSV('sp')" class="text-xs font-bold underline hover:text-[#1C4E8C]">匯出 CSV</button>
                        </div>
                        <div class="overflow-x-auto max-h-[300px] custom-scroll">
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-black text-white sticky top-0">
                                    <tr>
                                        <th class="p-3">日期</th><th class="p-3">SP姓名</th><th class="p-3">考官</th><th class="p-3">站號</th>
                                        <th class="p-3">分數(Q1-Q8)</th><th class="p-3 min-w-[200px]">文字評語</th>
                                    </tr>
                                </thead>
                                <tbody id="sp-table-body">
                                    <tr><td colspan="6" class="p-8 text-center text-gray-400">Loading data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW 3: EXAMINER FEEDBACK ANALYSIS (NEW & Enhanced) -->
                <div id="view-examiner-analysis" class="p-4 md:p-8 animate-fade-in hidden">
                    
                    <!-- Title Section -->
                    <div class="flex justify-between items-end border-b-2 border-black pb-4 mb-8">
                        <div>
                            <h2 class="text-3xl font-black flex items-center gap-3">
                                <span class="w-4 h-8 bg-[#EAB936] border-2 border-black block"></span>
                                考官回饋分析
                            </h2>
                            <p class="text-gray-500 font-bold mt-1 ml-7">Feedback from Examiners: Satisfaction & Insights</p>
                        </div>
                        <div class="text-right flex gap-2">
                             <div class="hidden md:block text-right mr-2">
                                 <div class="text-xs text-gray-400 font-bold">DATA SOURCE</div>
                                 <div class="font-mono text-sm">Examiner Feedback Sheet</div>
                             </div>
                        </div>
                    </div>

                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                         <!-- Total -->
                         <div class="bg-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <p class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">回饋樣本數</p>
                            <h3 class="text-4xl font-black" id="ex-stat-count">--</h3>
                            <div class="w-8 h-1 bg-[#1C4E8C] mt-2"></div>
                        </div>
                        <!-- Avg -->
                        <div class="bg-[#1A1A1A] text-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <p class="text-xs font-black text-gray-400 uppercase tracking-widest mb-1">平均滿意度 (Q1-Q8)</p>
                            <h3 class="text-4xl font-black text-[#EAB936]" id="ex-stat-avg">--</h3>
                            <p class="text-[10px] text-gray-500 mt-1">Scale: 1-5 (Higher is Better)</p>
                        </div>
                        <!-- Lowest Dimension -->
                        <div class="bg-[#D03328] text-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <p class="text-xs font-black text-white/80 uppercase tracking-widest mb-1">需關注面向</p>
                            <h3 class="text-2xl font-black text-white mt-1" id="ex-stat-low">--</h3>
                            <p class="text-[10px] text-white/60 mt-1">Lowest scoring question</p>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <!-- Chart: Questions -->
                        <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold border-l-4 border-[#1C4E8C] pl-3">八大面向滿意度分析</h3>
                            </div>
                            <div class="flex-1 min-h-[300px] relative">
                                <canvas id="chart-ex-questions"></canvas>
                            </div>
                        </div>
                        <!-- Chart: Stations -->
                        <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold border-l-4 border-[#EAB936] pl-3">各測驗站滿意度比較</h3>
                                <div class="text-xs text-gray-500">找出問題站點</div>
                            </div>
                            <div class="flex-1 min-h-[300px] relative">
                                <canvas id="chart-ex-stations"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Insight Engine (Examiner) -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <!-- Left: Qualitative Keywords -->
                        <div class="lg:col-span-2 bg-white border-[3px] border-black p-6 bauhaus-shadow">
                            <div class="flex items-center gap-2 mb-6 border-b-2 border-gray-100 pb-2">
                                <div class="bg-black text-white p-1.5"><i data-lucide="book-open" class="w-4 h-4"></i></div>
                                <h3 class="text-xl font-bold">考題與整體回饋關鍵字</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">高頻建議 (Top Keywords)</h4>
                                    <div id="ex-keyword-cloud" class="flex flex-wrap gap-2 min-h-[100px] content-start">
                                        <span class="text-gray-400 italic text-sm">Analyzing...</span>
                                    </div>
                                </div>
                                <div class="border-l-2 border-gray-100 pl-4">
                                    <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">最新回饋 (Latest Feedback)</h4>
                                    <div id="ex-comments-list" class="space-y-3 max-h-[200px] overflow-y-auto custom-scroll pr-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Action Plan -->
                        <div class="bg-[#1A1A1A] text-white border-[3px] border-black p-6 bauhaus-shadow relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-[#333] rounded-bl-full -z-0"></div>
                            
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex items-center gap-2 mb-4 border-b border-gray-700 pb-2">
                                    <div class="bg-[#EAB936] text-black p-1.5"><i data-lucide="zap" class="w-4 h-4"></i></div>
                                    <h3 class="text-xl font-bold">品質改善行動 (Action)</h3>
                                </div>

                                <div class="flex-1">
                                    <div class="mb-4">
                                        <h4 class="text-xs font-bold text-[#EAB936] uppercase tracking-wider mb-1">優先改善面向 (Priority)</h4>
                                        <div id="ex-action-priority" class="text-lg font-bold">--</div>
                                    </div>

                                    <div class="mb-2">
                                        <h4 class="text-xs font-bold text-[#EAB936] uppercase tracking-wider mb-1">AI 建議行動</h4>
                                        <p id="ex-action-suggestion" class="text-xs text-gray-300 leading-relaxed">...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- Data Table -->
                    <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow">
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold border-l-4 border-gray-400 pl-3">詳細數據列表</h3>
                            <button onclick="exportCSV('ex')" class="text-xs font-bold underline hover:text-[#1C4E8C]">匯出 CSV</button>
                        </div>
                        <div class="overflow-x-auto max-h-[300px] custom-scroll">
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-black text-white sticky top-0">
                                    <tr>
                                        <th class="p-3">日期</th><th class="p-3">考官</th><th class="p-3">站號</th>
                                        <th class="p-3">Q1-Q8評分</th><th class="p-3 min-w-[200px]">考題建議(Q9)</th><th class="p-3 min-w-[200px]">整體建議(Q10)</th>
                                    </tr>
                                </thead>
                                <tbody id="ex-table-body">
                                    <tr><td colspan="6" class="p-8 text-center text-gray-400">Loading data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>

                <!-- Other Views (Placeholders) -->
                <div id="view-student-analysis" class="p-8 hidden"><div class="text-center text-gray-400 mt-20">考生回饋分析 - 建置中</div></div>
                <div id="view-sp-analysis" class="p-8 hidden"><div class="text-center text-gray-400 mt-20">SP 回饋分析 - 建置中</div></div>

            </main>
        </div>
    </div>

    <!-- Initialization & Logic -->
    <script>
        // --- CONFIGURATION ---
        const SP_API_URL = "https://script.google.com/macros/s/AKfycbzAZfDJS21_o7WIrXCpW0w-Hx8i_DtHQVSvIhj1nsIyge752nhDP_7caE1VzZvvEMtP/exec"; 
        const EXAMINER_API_URL = "https://script.google.com/macros/s/AKfycbz-SVriuVdvHuqdwBV25N1INoeaSoF2VHrob_gZ7aBpxX_XqlfsEdzmmRgNAf4kRhAy/exec";
        
        // --- Global State ---
        let globalSpData = [];
        let globalExaminerData = [];
        let globalSpMap = {}; 
        let currentView = 'dashboard';
        let charts = {};

        // --- Initialization ---
        lucide.createIcons();
        fetchAllData();

        // --- FETCH ALL ---
        async function fetchAllData() {
            updateSystemStatus('Fetching Data...', 'yellow');
            try {
                await Promise.all([fetchSPData(), fetchExaminerData()]);
                updateSystemStatus('System Online', 'green');
            } catch (error) {
                console.error(error);
                updateSystemStatus('Partial Error', 'orange');
            }
        }

        // --- SP DATA LOGIC (Restored Original) ---
        async function fetchSPData() {
            try {
                const response = await fetch(SP_API_URL);
                const data = await response.json();
                if(data.error) throw new Error(data.error);
                globalSpData = data;
                populateDateFilter(globalSpData); // Original logic populates filter from SP data
                if(currentView === 'examiner-sp-analysis') applyGlobalFilters();
            } catch (error) {
                console.error("SP Fetch Error:", error);
                showToast("SP 資料讀取失敗", "error");
            }
        }

        function generateSPMap(data) {
            const nameMap = {};
            const usedDisplayNames = {};
            const uniqueNames = [...new Set(data.map(r => r.spName || r.SPName || "未知SP"))];
            uniqueNames.forEach(name => {
                if(name === "未知SP") { nameMap[name] = name; return; }
                let masked = (name.length <= 2) ? name.charAt(0)+"○" : name.charAt(0)+"○"+name.slice(-1);
                if (usedDisplayNames[masked]) {
                    usedDisplayNames[masked]++;
                    masked = `${masked} (${usedDisplayNames[masked]})`;
                } else {
                    usedDisplayNames[masked] = 1;
                }
                nameMap[name] = masked;
            });
            return nameMap;
        }

        function processSPData(data) {
            if (Object.keys(globalSpMap).length === 0) globalSpMap = generateSPMap(globalSpData);

            const total = data.length;
            let totalSum=0, q1Sum=0, q8Sum=0, count=0;
            let qSums = {q1:0, q2:0, q3:0, q4:0, q5:0, q6:0, q7:0, q8:0};
            let profStats = {};
            let spPerformance = {};
            let allComments = [];

            data.forEach(row => {
                const s = row.scores || {};
                const q1 = Number(s.q1)||0; const q2 = Number(s.q2)||0; const q3 = Number(s.q3)||0; const q4 = Number(s.q4)||0;
                const q5 = Number(s.q5)||0; const q6 = Number(s.q6)||0; const q7 = Number(s.q7)||0; const q8 = Number(s.q8)||0;

                // Invert Q2, Q3
                let adjQ2 = (q2>0)?(6-q2):0;
                let adjQ3 = (q3>0)?(6-q3):0;
                
                let rowAvg = (q1+adjQ2+adjQ3+q4+q5+q6+q7+q8)/8;
                totalSum += rowAvg; count++;
                q1Sum += q1; q8Sum += q8;

                qSums.q1+=q1; qSums.q2+=adjQ2; qSums.q3+=adjQ3; qSums.q4+=q4;
                qSums.q5+=q5; qSums.q6+=q6; qSums.q7+=q7; qSums.q8+=q8;

                const p = row.profession || "其他";
                if(!profStats[p]) profStats[p] = {sum:0, count:0};
                profStats[p].sum += rowAvg; profStats[p].count++;

                let rawName = row.spName || row.SPName || "未知SP";
                let masked = globalSpMap[rawName] || rawName;
                if(!spPerformance[masked]) spPerformance[masked] = {sum:0, count:0};
                spPerformance[masked].sum += rowAvg; spPerformance[masked].count++;

                if(row.generalComment) allComments.push(row.generalComment);
            });

            // Update DOM
            document.getElementById('sp-stat-total').innerText = total;
            document.getElementById('sp-stat-avg').innerText = count ? (totalSum/count).toFixed(2) : "-";
            document.getElementById('sp-stat-q1').innerText = count ? (q1Sum/count).toFixed(2) : "-";
            document.getElementById('sp-stat-q8').innerText = count ? (q8Sum/count).toFixed(2) : "-";

            if (total > 0) {
                renderRadarChart(qSums, total);
                renderProfessionChart(profStats);
                renderSPInsights(qSums, total, allComments, spPerformance);
            }
            renderSPTable(data);
        }

        // --- EXAMINER DATA LOGIC (New) ---
        async function fetchExaminerData() {
            try {
                const response = await fetch(EXAMINER_API_URL);
                const data = await response.json();
                if(data.error) throw new Error(data.error);
                globalExaminerData = data;
                if(currentView === 'examiner-analysis') applyGlobalFilters();
            } catch (error) {
                console.error("Examiner Fetch Error:", error);
                showToast("考官回饋讀取失敗", "error");
            }
        }

        function processExaminerData(data) {
            const total = data.length;
            let qSums = Array(8).fill(0);
            let stationStats = {};
            let allComments = [];

            data.forEach(row => {
                // Parse scores Q1-Q8
                const scores = [row.q1, row.q2, row.q3, row.q4, row.q5, row.q6, row.q7, row.q8].map(v => Number(v)||0);
                scores.forEach((v, i) => qSums[i] += v);

                // Station stats
                const st = row.stationNumber || "Unk";
                if(!stationStats[st]) stationStats[st] = {sum:0, count:0};
                let rowAvg = scores.reduce((a,b)=>a+b,0)/8;
                stationStats[st].sum += rowAvg;
                stationStats[st].count++;

                // Collect qualitative
                if(row.q9) allComments.push(row.q9); // 考題建議
                if(row.q10) allComments.push(row.q10); // 整體建議
            });

            const qAvgs = qSums.map(s => total > 0 ? (s/total).toFixed(2) : 0);
            const totalAvg = total > 0 ? (qSums.reduce((a,b)=>a+b,0) / (total * 8)).toFixed(2) : 0;

             // Find Lowest Dimension
            const qLabels = ["Q1 測驗內容", "Q2 評核項目", "Q3 評分說明", "Q4 試題指引", "Q5 測驗時間", "Q6 動線規劃", "Q7 廣播鈴聲", "Q8 試務流程"];
            let minVal = 6, minIdx = -1;
            qAvgs.forEach((v, i) => { if(Number(v) < minVal && Number(v) > 0) { minVal = Number(v); minIdx = i; }});
            const lowestDim = minIdx >= 0 ? qLabels[minIdx] : "無資料";

            // Update DOM
            document.getElementById('ex-stat-count').innerText = total;
            document.getElementById('ex-stat-avg').innerText = totalAvg;
            document.getElementById('ex-stat-low').innerText = lowestDim;

            // Render
            if(total > 0) {
                renderExaminerCharts(qLabels, qAvgs, stationStats);
                renderExaminerInsights(qAvgs, allComments, lowestDim, minIdx);
            }
            renderExaminerTable(data);
        }

        // --- RENDER FUNCTIONS (Charts & Insights) ---
        
        function renderRadarChart(qSums, total) {
            // SP Radar
            const ctx = document.getElementById('chart-sp-radar').getContext('2d');
            const data = [qSums.q1, qSums.q2, qSums.q3, qSums.q4, qSums.q5, qSums.q6, qSums.q7, qSums.q8].map(s => s/total);
            if(charts.spRadar) charts.spRadar.destroy();
            charts.spRadar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ["Q1一致", "Q2無操弄", "Q3無質疑", "Q4真實", "Q5表情", "Q6肢體", "Q7自然", "Q8專業"],
                    datasets: [{ label: 'Score', data: data, backgroundColor: 'rgba(234, 185, 54, 0.5)', borderColor: '#EAB936', borderWidth: 2 }]
                },
                options: { scales: { r: { min: 3, max: 5 } }, maintainAspectRatio: false }
            });
        }

        function renderProfessionChart(stats) {
            const ctx = document.getElementById('chart-sp-bar').getContext('2d');
            const labels = Object.keys(stats);
            const data = labels.map(k => stats[k].sum/stats[k].count);
            if(charts.spBar) charts.spBar.destroy();
            charts.spBar = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Score', data, backgroundColor: '#1C4E8C' }] },
                options: { scales: { y: { min: 3, max: 5 } }, maintainAspectRatio: false }
            });
        }

        function renderExaminerCharts(labels, data, stationStats) {
            // Examiner Bar (Questions)
            const ctxQ = document.getElementById('chart-ex-questions').getContext('2d');
            if(charts.exQ) charts.exQ.destroy();
            charts.exQ = new Chart(ctxQ, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: '滿意度', data: data, backgroundColor: data.map(v=>v<4?'#D03328':'#1C4E8C') }]
                },
                options: { indexAxis: 'y', scales: { x: { min: 3, max: 5 } }, maintainAspectRatio: false }
            });

            // Examiner Bar (Stations)
            const stLabels = Object.keys(stationStats).sort((a,b)=>Number(a)-Number(b));
            const stData = stLabels.map(k => stationStats[k].sum/stationStats[k].count);
            const ctxS = document.getElementById('chart-ex-stations').getContext('2d');
            if(charts.exS) charts.exS.destroy();
            charts.exS = new Chart(ctxS, {
                type: 'bar',
                data: { labels: stLabels.map(s=>`第${s}站`), datasets: [{ label: '滿意度', data: stData, backgroundColor: '#EAB936' }] },
                options: { scales: { y: { min: 3, max: 5 } }, maintainAspectRatio: false }
            });
        }

        // --- INSIGHT ENGINES ---

        // 1. SP Insight Engine (Original Logic)
        function renderSPInsights(qSums, total, comments, spPerformance) {
            // Keywords
            const stopWords = ["無", "沒有", "sp", "的", "很", "表現", "學生", "good", "ok"];
            let wordCounts = {};
            comments.forEach(c => {
                c.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()。，、！]/g," ").split(/\s+/).forEach(w => {
                    if(w.length > 1 && !stopWords.includes(w.toLowerCase())) wordCounts[w] = (wordCounts[w]||0)+1;
                });
            });
            const sortedWords = Object.entries(wordCounts).sort((a,b)=>b[1]-a[1]).slice(0, 8);
            
            const cloud = document.getElementById('sp-keyword-cloud');
            cloud.innerHTML = '';
            sortedWords.forEach(([w, c]) => {
                const isNeg = ["小聲","矛盾","過度","差"].some(n=>w.includes(n));
                cloud.innerHTML += `<span class="keyword-tag ${isNeg?'keyword-neg':'keyword-pos'}">${w}(${c})</span>`;
            });

            // Comments List
            document.getElementById('sp-comments-list').innerHTML = comments.slice(-5).reverse().map(c=>`<div class="text-xs border-b pb-1 mb-1 text-gray-600">"${c}"</div>`).join('');

            // Watchlist
            const watchlist = Object.entries(spPerformance).map(([n, d])=>({name:n, avg:d.sum/d.count, count:d.count})).sort((a,b)=>a.avg-b.avg).slice(0,3);
            document.getElementById('sp-watchlist').innerHTML = watchlist.map(s=>`<li class="flex justify-between text-xs text-gray-300"><span>${s.name}</span><span class="${s.avg<4?'text-red-400':''}">${s.avg.toFixed(1)}</span></li>`).join('');

            // Action
            const labels = ["Q1 角色一致", "Q2 避免操弄", "Q3 避免質疑", "Q4 身體表現", "Q5 表情眼神", "Q6 肢體動作", "Q7 回答自然", "Q8 專業態度"];
            const scores = [qSums.q1, qSums.q2, qSums.q3, qSums.q4, qSums.q5, qSums.q6, qSums.q7, qSums.q8].map(s=>s/total);
            let minS = 6, minI = -1;
            scores.forEach((s,i)=>{if(s<minS){minS=s; minI=i}});
            
            const actions = {
                0: "建議加強標準化劇本的背誦與角色背景故事的內化訓練。",
                1: "SP 可能過度引導學生。建議舉辦工作坊，練習「被動反應」技巧。",
                2: "SP 對學生展現過多攻擊性。需調整角色情緒設定，強調教學目標。",
                3: "身體症狀（如疼痛）模擬不足。建議引入影片教學或由醫師示範。",
                4: "眼神接觸或表情不到位。建議安排「鏡子練習」或表演指導。",
                5: "肢體語言與口語不一致。需加強非語言溝通的一致性訓練。",
                6: "回答過於生硬。建議練習口語化表達，減少專業術語使用。",
                7: "需強調考場紀律與角色沉浸感，避免考場內閒聊。"
            };
            document.getElementById('sp-action-priority').innerText = labels[minI] || "無";
            document.getElementById('sp-action-suggestion').innerText = actions[minI] || "表現良好，持續保持。";
        }

        // 2. Examiner Insight Engine (NEW)
        function renderExaminerInsights(qAvgs, comments, lowestDim, lowestIdx) {
            // Keywords
            const stopWords = ["無", "沒有", "建議", "考題", "的", "覺得", "尚可", "良好", "ok", "good"];
            let wordCounts = {};
            comments.forEach(c => {
                 // Ensure c is a string
                String(c).replace(/[.,\/#!$%\^&\*;:{}=\-_`~()。，、！]/g," ").split(/\s+/).forEach(w => {
                    if(w.length > 1 && !stopWords.includes(w.toLowerCase())) wordCounts[w] = (wordCounts[w]||0)+1;
                });
            });
            const sortedWords = Object.entries(wordCounts).sort((a,b)=>b[1]-a[1]).slice(0, 8);
            
            const cloud = document.getElementById('ex-keyword-cloud');
            cloud.innerHTML = '';
            if(sortedWords.length === 0) cloud.innerHTML = '<span class="text-gray-400 text-xs">無足夠關鍵字</span>';
            sortedWords.forEach(([w, c]) => {
                const isNeg = ["不足","太短","吵","動線","難"].some(n=>w.includes(n));
                cloud.innerHTML += `<span class="keyword-tag ${isNeg?'keyword-neg':'keyword-pos'}">${w}(${c})</span>`;
            });

            // Comments List
            const listEl = document.getElementById('ex-comments-list');
            listEl.innerHTML = '';
            const validComments = comments.filter(c => c && String(c).trim() !== "");
            if(validComments.length === 0) listEl.innerHTML = '<div class="text-xs text-gray-400">無文字回饋</div>';
            else {
                validComments.slice(-5).reverse().forEach(c => {
                    listEl.innerHTML += `<div class="text-xs border-b pb-1 mb-1 text-gray-600">"${c}"</div>`;
                });
            }

            // Action Plan
            document.getElementById('ex-action-priority').innerText = lowestDim + (lowestIdx >= 0 ? ` (${qAvgs[lowestIdx]})` : "");
            
            const actions = {
                0: "建議重新審視考題鑑別度與難易度分佈，或召開共識會議調整評分標準。",
                1: "評分項目可能過於繁瑣或模糊，建議簡化評核表或具體化行為指標。",
                2: "評分說明可能不夠明確，建議在考官共識營中加強說明或提供範例影片。",
                3: "試題指引資訊可能不足，建議增加考生端或考官端的背景資訊說明。",
                4: "測驗時間安排可能過於緊湊，建議檢視考題份量或考慮調整考試時間。",
                5: "動線規劃可能有改進空間，建議檢視考場標示或人員引導配置。",
                6: "廣播或鈴聲系統可能有干擾，建議檢查硬體設備或調整音量設定。",
                7: "試務流程有優化空間，建議加強試務人員培訓或標準化作業程序。"
            };
            document.getElementById('ex-action-suggestion').innerText = actions[lowestIdx] || "目前各面向滿意度良好，請持續保持。";
        }

        // --- TABLES ---
        function renderSPTable(data) {
            const tbody = document.getElementById('sp-table-body');
            tbody.innerHTML = data.slice(0,50).map(r => {
                let s = r.scores||{};
                let rawName = r.spName || r.SPName || "未知SP";
                let masked = globalSpMap[rawName] || rawName;
                let scoresStr = [s.q1, s.q2, s.q3, s.q4, s.q5, s.q6, s.q7, s.q8].join(',');
                return `<tr class="border-b text-xs hover:bg-gray-50">
                    <td class="p-2">${(r.examDate||'').substring(0,10)}</td>
                    <td class="p-2 text-[#1C4E8C] font-bold">${masked}</td>
                    <td class="p-2">${r.examinerName||'-'}</td>
                    <td class="p-2 font-bold">${r.stationNumber}</td>
                    <td class="p-2 font-mono text-gray-500">${scoresStr}</td>
                    <td class="p-2 truncate max-w-[150px]">${r.generalComment||'-'}</td>
                </tr>`;
            }).join('');
        }

        function renderExaminerTable(data) {
            const tbody = document.getElementById('ex-table-body');
            tbody.innerHTML = data.slice(0,50).map(r => {
                let scoresStr = [r.q1, r.q2, r.q3, r.q4, r.q5, r.q6, r.q7, r.q8].join(',');
                return `<tr class="border-b text-xs hover:bg-gray-50">
                    <td class="p-2">${(r.date||r.examDate||'').substring(0,10)}</td>
                    <td class="p-2 font-bold">${r.examinerName||'-'}</td>
                    <td class="p-2 font-bold">${r.stationNumber}</td>
                    <td class="p-2 font-mono text-gray-500">${scoresStr}</td>
                    <td class="p-2 truncate max-w-[150px]">${r.q9||'-'}</td>
                    <td class="p-2 truncate max-w-[150px]">${r.q10||'-'}</td>
                </tr>`;
            }).join('');
        }

        // --- SHARED UTILS ---
        function populateDateFilter(data) {
            const sel = document.getElementById('date-filter');
            sel.innerHTML = '<option value="all">全部場次 All</option>';
            [...new Set(data.map(d=>(d.examDate||'').substring(0,10)))].filter(Boolean).sort().reverse().forEach(d=>{
                sel.innerHTML+=`<option value="${d}">${d}</option>`;
            });
        }

        function applyGlobalFilters() {
            // Apply to SP
            const year = document.getElementById('year-filter').value;
            const date = document.getElementById('date-filter').value;
            const prof = document.getElementById('profession-filter').value;

            // Filter SP Data
            let filteredSP = globalSpData.filter(d => {
                 let dStr = (d.examDate||'').substring(0,10);
                 if(year!=='all' && !dStr.includes(year)) return false;
                 if(date!=='all' && dStr!==date) return false;
                 if(prof!=='all' && d.profession!==prof) return false;
                 return true;
            });
            processSPData(filteredSP);

            // Filter Examiner Data
            let filteredEx = globalExaminerData.filter(d => {
                let dStr = (d.date||d.examDate||'').substring(0,10);
                if(year!=='all' && !dStr.includes(year)) return false;
                if(date!=='all' && dStr!==date) return false;
                // Profession filter NA for examiner sheet usually, but we keep logic clean
                return true; 
            });
            processExaminerData(filteredEx);
        }

        function switchView(v) {
            currentView = v;
            ['dashboard','examiner-sp-analysis','examiner-analysis','student-analysis','sp-analysis'].forEach(id=>{
                document.getElementById('view-'+id).classList.add('hidden');
                document.getElementById('view-'+id).classList.remove('block');
                const nav = document.getElementById('nav-'+id);
                if(nav) { nav.classList.remove('active'); nav.classList.add('opacity-70', 'border-transparent'); }
            });
            document.getElementById('view-'+v).classList.remove('hidden');
            document.getElementById('view-'+v).classList.add('block');
            const active = document.getElementById('nav-'+v);
            if(active) { active.classList.add('active'); active.classList.remove('opacity-70', 'border-transparent'); }
            
            if(v === 'examiner-sp-analysis' || v === 'examiner-analysis') applyGlobalFilters();

            // Toggle Profession Filter Visibility (Only relevant for SP)
            const profFilter = document.getElementById('prof-filter-container');
            if(v === 'examiner-sp-analysis') profFilter.classList.remove('hidden');
            else profFilter.classList.add('hidden');

            if(window.innerWidth < 768) toggleSidebar();
        }

        function updateSystemStatus(msg, color) {
            const d = document.getElementById('system-status-dot');
            const t = document.getElementById('system-status-text');
            d.className = `w-2 h-2 rounded-full mr-2 bg-${color==='yellow'?'yellow-500':color==='green'?'green-500':'red-600'} ${color==='yellow'?'animate-pulse':''}`;
            t.innerText = msg;
        }

        function updateDateOptions() { /* Placeholder */ }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); }
        function closeModal() { document.getElementById('modal-content').classList.add('scale-95', 'opacity-0'); setTimeout(()=>document.getElementById('modal-overlay').classList.add('hidden'), 200); }
        function showToast(msg, type) { 
            document.getElementById('modal-message').innerText = msg;
            if(type==='error') {
                 document.getElementById('modal-overlay').classList.remove('hidden');
                 setTimeout(() => { document.getElementById('modal-content').classList.remove('scale-95', 'opacity-0'); document.getElementById('modal-content').classList.add('scale-100', 'opacity-100'); }, 10);
            }
        }
        function exportCSV(type) {
            let csv = "";
            if(type==='sp') {
                csv = "日期,SP姓名,考官,站號,Q1,Q2,Q3,Q4,Q5,Q6,Q7,Q8,評語\n";
                globalSpData.forEach(r => {
                    let s = r.scores||{};
                    let name = globalSpMap[r.spName||r.SPName||"未知"] || r.spName;
                    csv += `${(r.examDate||'').substring(0,10)},${name},${r.examinerName},${r.stationNumber},${s.q1},${s.q2},${s.q3},${s.q4},${s.q5},${s.q6},${s.q7},${s.q8},"${(r.generalComment||'').replace(/"/g,'""')}"\n`;
                });
            } else {
                csv = "日期,考官,站號,Q1,Q2,Q3,Q4,Q5,Q6,Q7,Q8,考題建議,整體建議\n";
                globalExaminerData.forEach(r => {
                    csv += `${(r.date||'').substring(0,10)},${r.examinerName},${r.stationNumber},${r.q1},${r.q2},${r.q3},${r.q4},${r.q5},${r.q6},${r.q7},${r.q8},"${(r.q9||'').replace(/"/g,'""')}","${(r.q10||'').replace(/"/g,'""')}"\n`;
                });
            }
            const blob = new Blob(["\uFEFF"+csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `osce_${type}_data.csv`;
            link.click();
        }
    </script>
</body>
</html>
