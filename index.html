<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥‡ç¾é†«é™¢è‡¨åºŠæŠ€èƒ½ä¸­å¿ƒOSCEå•å·æ»¿æ„åº¦æˆæ•ˆå„€è¡¨æ¿</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* Bauhaus Theme Variables */
        :root {
            --bauhaus-red: #D03328;
            --bauhaus-yellow: #EAB936;
            --bauhaus-blue: #1C4E8C;
            --bauhaus-white: #FCFBF9;
            --bauhaus-black: #1A1A1A;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bauhaus-white);
            color: var(--bauhaus-black);
            background-image: radial-gradient(var(--bauhaus-black) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Utility Classes */
        .bauhaus-border {
            border: 3px solid var(--bauhaus-black);
        }
        .bauhaus-shadow {
            box-shadow: 6px 6px 0px 0px var(--bauhaus-black);
        }
        .bauhaus-shadow-sm {
            box-shadow: 3px 3px 0px 0px var(--bauhaus-black);
        }
        .bauhaus-shadow-hover:hover {
            box-shadow: 8px 8px 0px 0px var(--bauhaus-black);
            transform: translate(-2px, -2px);
        }
        
        /* Sidebar Link Active State */
        .nav-link {
            cursor: pointer;
            text-decoration: none; /* For a tags */
        }
        .nav-link.active {
            background-color: var(--bauhaus-yellow);
            color: var(--bauhaus-black);
            border-color: var(--bauhaus-black);
            font-weight: 900;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
            transform: translateY(-4px);
        }
        .nav-link:hover:not(.active) {
            background-color: #333;
            border-color: white;
            color: white;
        }

        /* View Switching Animations */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #1A1A1A;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Tag Styles for Keywords */
        .keyword-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: bold;
            border: 2px solid #1A1A1A;
            margin: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .keyword-tag:hover {
            transform: scale(1.05);
        }
        .keyword-pos { background-color: #EAB936; color: black; }
        .keyword-neg { background-color: #D03328; color: white; }
    </style>
</head>
<body class="overflow-hidden h-screen w-screen">

    <!-- Modal (Hidden by default) -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white border-[4px] border-black w-full max-w-md p-6 bauhaus-shadow relative transform transition-all scale-95 opacity-0" id="modal-content">
            <button onclick="closeModal()" class="absolute top-2 right-2 p-1 hover:bg-gray-100 border-2 border-transparent hover:border-black rounded-full">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <div class="flex items-center gap-4 mb-4">
                <div class="bg-[#EAB936] p-3 border-[3px] border-black rounded-full">
                    <i data-lucide="info" class="w-6 h-6 text-black"></i>
                </div>
                <h3 class="text-xl font-black uppercase tracking-wide">System Notice</h3>
            </div>
            
            <p id="modal-message" class="text-lg font-bold mb-6">Message goes here...</p>
            
            <button onclick="closeModal()" class="w-full bg-[#1C4E8C] text-white font-bold py-3 border-[3px] border-black hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-none shadow-[4px_4px_0px_0px_black] transition-all">
                UNDERSTOOD
            </button>
        </div>
    </div>

    <!-- Configuration Alert (Shows if URL is missing) -->
    <div id="config-alert" class="hidden fixed top-0 left-0 w-full bg-[#D03328] text-white p-2 text-center font-bold z-[70] border-b-4 border-black animate-pulse">
        âš ï¸ è«‹åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šæ­£ç¢ºçš„ GAS_API_URL æ‰èƒ½è®€å–çœŸå¯¦æ•¸æ“šï¼
    </div>

    <!-- Main Flex Container -->
    <div class="flex h-screen flex-col">

        <!-- Header -->
        <header class="bg-[#1C4E8C] text-white border-b-[4px] border-black z-50 flex-shrink-0">
            <div class="w-full px-4 py-3 flex justify-between items-center relative overflow-hidden">
                <!-- Decorative Circle -->
                <div class="absolute top-[-20px] left-[-20px] w-20 h-20 bg-[#EAB936] rounded-full border-[3px] border-black z-0"></div>
                
                <div class="flex items-center gap-4 z-10 pl-8">
                    <div class="bg-white p-1.5 border-[3px] border-black shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]">
                        <img src="https://www.chimei.org.tw/main/cmh_department/59012/mag/202111/images/logo.png" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2ZmZiIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5DTSBIb3NwaXRhbDwvdGV4dD48L3N2Zz4='"
                             alt="Logo" class="h-6 md:h-8 w-auto object-contain">
                    </div>
                    <div>
                        <h1 class="text-lg md:text-2xl font-black tracking-wide leading-none">è‡¨åºŠæŠ€èƒ½ä¸­å¿ƒ</h1>
                        <p class="text-[10px] md:text-xs font-bold text-[#EAB936] tracking-widest uppercase">OSCE Dashboard System</p>
                    </div>
                </div>

                <div class="flex items-center gap-3 z-10">
                    <div class="hidden md:flex items-center bg-black px-3 py-1 rounded-full border border-white">
                        <span id="system-status-dot" class="w-2 h-2 bg-yellow-500 rounded-full mr-2 animate-pulse"></span>
                        <span id="system-status-text" class="text-xs font-mono">Connecting...</span>
                    </div>
                    <button class="md:hidden p-2 bg-black border-2 border-white rounded-md" onclick="toggleSidebar()">
                        <i data-lucide="menu" class="w-5 h-5 text-white"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Body Container -->
        <div class="flex flex-1 overflow-hidden relative">
            
            <!-- Left Sidebar -->
            <aside id="sidebar" class="absolute md:relative w-64 bg-[#1A1A1A] text-white border-r-[4px] border-black flex flex-col h-full z-40 shadow-[4px_0_10px_rgba(0,0,0,0.5)] transform -translate-x-full md:translate-x-0 transition-transform duration-300">
                
                <!-- Filter Section -->
                <div id="filters-panel" class="p-5 border-b-2 border-gray-800 bg-[#222]">
                    <h3 class="text-[#EAB936] text-xs font-bold uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i data-lucide="filter" class="w-3 h-3"></i> ç¯©é¸æ¢ä»¶ Filters
                    </h3>
                    
                    <div class="space-y-3">
                        <!-- Year Filter -->
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">å¹´åº¦ Year</label>
                            <div class="relative">
                                <select id="global-year-filter" onchange="handleGlobalFilterChange()" class="w-full bg-black border-2 border-gray-600 text-white text-sm p-2 outline-none focus:border-[#EAB936] appearance-none rounded-none cursor-pointer">
                                    <option value="all">å…¨éƒ¨å¹´åº¦ All</option>
                                    <option value="2025">2025 å¹´åº¦</option>
                                    <option value="2024">2024 å¹´åº¦</option>
                                    <option value="2023">2023 å¹´åº¦</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Session/Date Filter -->
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">å ´æ¬¡ Session</label>
                            <div class="relative">
                                <select id="global-date-filter" onchange="handleGlobalFilterChange()" class="w-full bg-black border-2 border-gray-600 text-white text-sm p-2 outline-none focus:border-[#EAB936] appearance-none rounded-none cursor-pointer">
                                    <option value="all">å…¨éƒ¨å ´æ¬¡ All</option>
                                    <!-- Populated by JS -->
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Profession Filter (For SP Analysis) -->
                        <div id="filter-group-profession">
                            <label class="text-xs text-gray-400 block mb-1">è·é¡ Profession</label>
                            <div class="relative">
                                <select id="global-profession-filter" onchange="handleGlobalFilterChange()" class="w-full bg-black border-2 border-gray-600 text-white text-sm p-2 outline-none focus:border-[#EAB936] appearance-none rounded-none cursor-pointer">
                                    <option value="all">å…¨éƒ¨è·é¡ All</option>
                                    <option value="è¥¿é†«">è¥¿é†«</option>
                                    <option value="ç‰™é†«">ç‰™é†«</option>
                                    <option value="ä¸­é†«">ä¸­é†«</option>
                                    <option value="è­·ç†">è­·ç†</option>
                                    <option value="è—¥å¸«">è—¥å¸«</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Station Filter (For Feedback Analysis & SP Feedback Analysis) -->
                        <div id="filter-group-station" class="hidden">
                            <label class="text-xs text-gray-400 block mb-1">æ¸¬é©—ç«™ Station</label>
                            <div class="relative">
                                <select id="global-station-filter" onchange="handleGlobalFilterChange()" class="w-full bg-black border-2 border-gray-600 text-white text-sm p-2 outline-none focus:border-[#EAB936] appearance-none rounded-none cursor-pointer">
                                    <option value="all">å…¨éƒ¨ç«™é» All</option>
                                    <option value="1">ç¬¬ 1 ç«™</option><option value="2">ç¬¬ 2 ç«™</option><option value="3">ç¬¬ 3 ç«™</option>
                                    <option value="4">ç¬¬ 4 ç«™</option><option value="5">ç¬¬ 5 ç«™</option><option value="6">ç¬¬ 6 ç«™</option>
                                    <option value="7">ç¬¬ 7 ç«™</option><option value="8">ç¬¬ 8 ç«™</option><option value="9">ç¬¬ 9 ç«™</option>
                                    <option value="10">ç¬¬ 10 ç«™</option><option value="11">ç¬¬ 11 ç«™</option><option value="12">ç¬¬ 12 ç«™</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="p-4 space-y-8 flex-1 overflow-y-auto custom-scroll">
                    
                    <!-- Group 1: Dashboard -->
                    <div>
                        <h3 class="text-gray-500 text-xs font-bold uppercase tracking-widest mb-3 pl-2 border-l-2 border-[#1C4E8C]">
                            å„€è¡¨æ¿ Dashboard
                        </h3>
                        <div class="space-y-2">
                            <div onclick="switchView('dashboard')" id="nav-dashboard" class="nav-link active block p-3 border-2 transition-all">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                                    <span class="font-bold text-sm">ç¶œåˆåˆ†æç¸½è¦½</span>
                                </div>
                            </div>

                            <div onclick="switchView('examiner-sp-analysis')" id="nav-examiner-sp-analysis" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all opacity-70 hover:opacity-100">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="clipboard-check" class="w-4 h-4"></i>
                                    <span class="font-bold text-sm">è€ƒå®˜è©•æ ¸ SP åˆ†æ</span>
                                </div>
                            </div>

                            <div onclick="switchView('examiner-analysis')" id="nav-examiner-analysis" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all opacity-70 hover:opacity-100">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
                                    <span class="font-bold text-sm">è€ƒå®˜å›é¥‹åˆ†æ</span>
                                </div>
                            </div>

                            <div onclick="switchView('student-analysis')" id="nav-student-analysis" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all opacity-70 hover:opacity-100">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="graduation-cap" class="w-4 h-4"></i>
                                    <span class="font-bold text-sm">è€ƒç”Ÿå›é¥‹åˆ†æ</span>
                                </div>
                            </div>

                            <div onclick="switchView('sp-analysis')" id="nav-sp-analysis" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all opacity-70 hover:opacity-100">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="smile" class="w-4 h-4"></i>
                                    <span class="font-bold text-sm">æ¨™æº–åŒ–ç—…äººå›é¥‹åˆ†æ</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Group 2: Survey Entry -->
                    <div>
                        <h3 class="text-gray-500 text-xs font-bold uppercase tracking-widest mb-3 pl-2 border-l-2 border-[#D03328]">
                            å•å·å¡«å¯« Survey Entry
                        </h3>
                        <div class="space-y-2">
                            <a href="https://luyun1224.github.io/ChimeiOSCE/SP-Assessment-Examiner.html" target="_blank" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all group">
                                <div class="flex items-center justify-between">
                                    <span class="font-bold text-sm">è€ƒå®˜è©•æ ¸ SP</span>
                                    <i data-lucide="external-link" class="w-3 h-3 group-hover:text-[#EAB936] transition-colors"></i>
                                </div>
                            </a>
                            <a href="https://luyun1224.github.io/ChimeiOSCE/Examiner-Feedback.html" target="_blank" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all group">
                                <div class="flex items-center justify-between">
                                    <span class="font-bold text-sm">è€ƒå®˜å›é¥‹å•å·</span>
                                    <i data-lucide="external-link" class="w-3 h-3 group-hover:text-[#EAB936] transition-colors"></i>
                                </div>
                            </a>
                            <a href="https://luyun1224.github.io/ChimeiOSCE/Student-Feedback.html" target="_blank" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all group">
                                <div class="flex items-center justify-between">
                                    <span class="font-bold text-sm">è€ƒç”Ÿå›é¥‹å•å·</span>
                                    <i data-lucide="external-link" class="w-3 h-3 group-hover:text-[#EAB936] transition-colors"></i>
                                </div>
                            </a>
                            <!-- NEW LINK -->
                            <a href="https://luyun1224.github.io/ChimeiOSCE/SP-Feedback.html" target="_blank" class="nav-link block p-3 border-2 border-transparent hover:border-white transition-all group">
                                <div class="flex items-center justify-between">
                                    <span class="font-bold text-sm">æ¨™æº–åŒ–ç—…äººå›é¥‹å•å·</span>
                                    <i data-lucide="external-link" class="w-3 h-3 group-hover:text-[#EAB936] transition-colors"></i>
                                </div>
                            </a>
                        </div>
                    </div>

                </nav>

                <!-- Footer Info -->
                <div class="p-4 text-[10px] text-gray-500 text-center border-t-2 border-gray-800">
                    <p>v2.0.0 (All Fixed)</p>
                    <p>Designed for Chimei</p>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto bg-[#FCFBF9] relative custom-scroll">
                
                <!-- Close sidebar overlay for mobile -->
                <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

                <!-- VIEW 1: DASHBOARD (Landing) -->
                <div id="view-dashboard" class="p-4 md:p-8 animate-fade-in block">
                     <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8 border-b-2 border-black pb-4">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-black flex flex-col md:flex-row md:items-center gap-3 leading-tight">
                                <div class="flex items-center gap-3">
                                    <span class="w-4 h-8 bg-[#D03328] border-2 border-black block flex-shrink-0"></span>
                                    <span>å¥‡ç¾é†«é™¢è‡¨åºŠæŠ€èƒ½ä¸­å¿ƒ</span>
                                </div>
                                <span>OSCEæˆæ•ˆå„€è¡¨æ¿</span>
                            </h2>
                            <p class="text-gray-500 font-bold mt-1 ml-7">OSCE Effectiveness & Insight Dashboard</p>
                        </div>
                        <div class="text-right">
                             <button onclick="fetchAllData()" class="bg-black text-white px-4 py-2 text-xs font-bold hover:bg-[#EAB936] hover:text-black transition-colors border border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)]">
                                <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i> REFRESH ALL DATA
                            </button>
                        </div>
                    </div>

                    <div class="bg-white border-[3px] border-black p-8 bauhaus-shadow flex flex-col items-center justify-center text-gray-400 min-h-[300px]">
                        <div class="bg-[#EAB936] p-4 rounded-full border-[3px] border-black mb-4">
                            <i data-lucide="bar-chart-2" class="w-12 h-12 text-black"></i>
                        </div>
                        <h3 class="text-2xl font-black text-black mb-2 text-center">æ­¡è¿ä½¿ç”¨æˆæ•ˆåˆ†æç³»çµ±</h3>
                        <p class="text-sm max-w-md text-center mb-6 text-gray-600">æœ¬ç³»çµ±æä¾›æ•¸æ“šè¦–è¦ºåŒ–èˆ‡è¡Œå‹•å»ºè­°ã€‚è«‹å¾å·¦å´é¸å–®é¸æ“‡ä¸åŒçš„åˆ†æè¦–åœ–ä»¥æŸ¥çœ‹è©³ç´°é›·é”åœ–èˆ‡æ”¹å–„å»ºè­°ã€‚</p>
                        <div class="flex flex-wrap justify-center gap-4">
                            <button onclick="switchView('examiner-sp-analysis')" class="bg-[#1C4E8C] text-white px-6 py-3 font-bold border-[3px] border-black shadow-[4px_4px_0px_0px_black] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[1px_1px_0px_0px_black] transition-all">
                                è€ƒå®˜è©•æ ¸ SP åˆ†æ
                            </button>
                            <button onclick="switchView('examiner-analysis')" class="bg-[#D03328] text-white px-6 py-3 font-bold border-[3px] border-black shadow-[4px_4px_0px_0px_black] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[1px_1px_0px_0px_black] transition-all">
                                è€ƒå®˜å›é¥‹åˆ†æ
                            </button>
                            <button onclick="switchView('student-analysis')" class="bg-[#EAB936] text-black px-6 py-3 font-bold border-[3px] border-black shadow-[4px_4px_0px_0px_black] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[1px_1px_0px_0px_black] transition-all">
                                è€ƒç”Ÿå›é¥‹åˆ†æ
                            </button>
                            <button onclick="switchView('sp-analysis')" class="bg-black text-white px-6 py-3 font-bold border-[3px] border-white shadow-[4px_4px_0px_0px_gray] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[1px_1px_0px_0px_gray] transition-all">
                                SP å›é¥‹åˆ†æ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: EXAMINER SP ANALYSIS (Main Analysis) -->
                <div id="view-examiner-sp-analysis" class="p-4 md:p-8 animate-fade-in hidden">
                    <!-- Title -->
                    <div class="flex justify-between items-end border-b-2 border-black pb-4 mb-8">
                        <div>
                            <h2 class="text-3xl font-black flex items-center gap-3">
                                <span class="w-4 h-8 bg-[#1C4E8C] border-2 border-black block"></span>
                                è€ƒå®˜è©•æ ¸ SP åˆ†æ
                            </h2>
                            <p class="text-gray-500 font-bold mt-1 ml-7">Examiner Assessment: 8 Dimensions & Insights</p>
                        </div>
                        <div class="text-right hidden md:block">
                             <div class="text-xs text-gray-400 font-bold">DATA SOURCE</div>
                             <div class="font-mono text-sm">Live Google Sheet</div>
                        </div>
                    </div>
                    
                    <!-- Content unchanged for brevity, but still present -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white border-[3px] border-black p-5 bauhaus-shadow relative overflow-hidden group">
                            <div class="absolute right-[-10px] top-[-10px] w-20 h-20 bg-gray-100 rounded-full z-0 group-hover:bg-[#EAB936] transition-colors"></div>
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">ç¸½å•å·æ¨£æœ¬æ•¸</p>
                                <h3 class="text-4xl font-black" id="stat-total-records">--</h3>
                                <div class="w-8 h-1 bg-black mt-2"></div>
                            </div>
                        </div>
                        <div class="bg-[#1A1A1A] text-white border-[3px] border-black p-5 bauhaus-shadow relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-400 uppercase tracking-widest mb-1">å¹³å‡ç¸½é«”å¾—åˆ†</p>
                                <h3 class="text-4xl font-black text-[#EAB936]" id="stat-avg-score">--</h3>
                                <p class="text-[10px] text-gray-500 mt-1">(åå‘é¡Œ Q2, Q3 å·²æ ¡æ­£)</p>
                            </div>
                        </div>
                        <div class="bg-[#D03328] text-white border-[3px] border-black p-5 bauhaus-shadow relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-white/80 uppercase tracking-widest mb-1">Q1 å¯é ä¸€è‡´æ€§</p>
                                <h3 class="text-4xl font-black text-white" id="stat-q1-score">--</h3>
                                <p class="text-[10px] text-white/60 mt-1">Core Competency</p>
                            </div>
                        </div>
                        <div class="bg-white border-[3px] border-black p-5 bauhaus-shadow relative overflow-hidden">
                             <div class="absolute right-[-10px] top-[-10px] w-20 h-20 bg-blue-50 rounded-full z-0"></div>
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">Q8 å°ˆæ¥­æ…‹åº¦</p>
                                <h3 class="text-4xl font-black text-[#1C4E8C]" id="stat-q8-score">--</h3>
                                <p class="text-[10px] text-gray-400 mt-1">Higher is Better (Scale: 1-5)</p>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold border-l-4 border-[#1C4E8C] pl-3">å…«å¤§é¢å‘èƒ½åŠ›åˆ†æ</h3>
                            </div>
                            <div class="flex-1 min-h-[320px] relative"><canvas id="chart-radar"></canvas></div>
                        </div>
                        <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold border-l-4 border-[#EAB936] pl-3">å„è·é¡è©•åˆ†å·®ç•°</h3>
                            </div>
                            <div class="flex-1 min-h-[320px] relative"><canvas id="chart-profession"></canvas></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <div class="lg:col-span-2 bg-white border-[3px] border-black p-6 bauhaus-shadow">
                            <div class="flex items-center gap-2 mb-6 border-b-2 border-gray-100 pb-2">
                                <div class="bg-black text-white p-1.5"><i data-lucide="message-square" class="w-4 h-4"></i></div>
                                <h3 class="text-xl font-bold">è€ƒå®˜è³ªæ€§å›é¥‹èˆ‡é—œéµå­—</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">é«˜é »é—œéµå­—</h4>
                                    <div id="keyword-cloud" class="flex flex-wrap gap-2 min-h-[100px] content-start"></div>
                                </div>
                                <div class="border-l-2 border-gray-100 pl-4">
                                    <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">æœ€æ–°è©•èª</h4>
                                    <div id="recent-comments-list" class="space-y-3 max-h-[200px] overflow-y-auto custom-scroll pr-2"></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-[#1A1A1A] text-white border-[3px] border-black p-6 bauhaus-shadow relative overflow-hidden">
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex items-center gap-2 mb-4 border-b border-gray-700 pb-2">
                                    <div class="bg-[#EAB936] text-black p-1.5"><i data-lucide="zap" class="w-4 h-4"></i></div>
                                    <h3 class="text-xl font-bold">å“è³ªæ”¹å–„è¡Œå‹•</h3>
                                </div>
                                <div class="flex-1">
                                    <div class="mb-4">
                                        <h4 class="text-xs font-bold text-[#EAB936] uppercase tracking-wider mb-1">å„ªå…ˆæ”¹å–„é¢å‘</h4>
                                        <div id="action-priority" class="text-lg font-bold">--</div>
                                    </div>
                                    <div class="mb-4">
                                        <h4 class="text-xs font-bold text-[#D03328] uppercase tracking-wider mb-2">éœ€é—œæ³¨ SP åå–®</h4>
                                        <ul id="sp-watchlist" class="text-sm space-y-2 bg-[#222] p-2 rounded border border-gray-700"></ul>
                                    </div>
                                    <div class="mb-2">
                                        <h4 class="text-xs font-bold text-[#EAB936] uppercase tracking-wider mb-1">AI å»ºè­°è¡Œå‹•</h4>
                                        <p id="action-suggestion" class="text-xs text-gray-300 leading-relaxed">...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold border-l-4 border-gray-400 pl-3">è©³ç´°æ•¸æ“šåˆ—è¡¨</h3>
                            <button onclick="exportCSV()" class="text-xs font-bold underline hover:text-[#1C4E8C]">åŒ¯å‡º CSV</button>
                        </div>
                        <div class="overflow-x-auto max-h-[400px] custom-scroll">
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-black text-white sticky top-0">
                                    <tr>
                                        <th class="p-3 whitespace-nowrap">æ—¥æœŸ</th>
                                        <th class="p-3 whitespace-nowrap">SPå§“å</th>
                                        <th class="p-3 whitespace-nowrap">è€ƒå®˜</th>
                                        <th class="p-3 whitespace-nowrap">ç«™è™Ÿ</th>
                                        <th class="p-3 whitespace-nowrap">è·é¡</th>
                                        <th class="p-3">Q1</th><th class="p-3 text-red-300">Q2(å)</th><th class="p-3 text-red-300">Q3(å)</th>
                                        <th class="p-3">Q4</th><th class="p-3">Q5</th><th class="p-3">Q6</th><th class="p-3">Q7</th><th class="p-3">Q8</th>
                                        <th class="p-3 min-w-[200px]">æ–‡å­—è©•èª</th>
                                    </tr>
                                </thead>
                                <tbody id="table-comments-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW 3: EXAMINER FEEDBACK ANALYSIS -->
                <div id="view-examiner-analysis" class="p-4 md:p-8 animate-fade-in hidden">
                    <div class="flex flex-col xl:flex-row justify-between items-end border-b-2 border-black pb-4 mb-6 gap-4">
                        <div>
                             <h2 class="text-3xl font-black flex items-center gap-3">
                                <span class="w-4 h-8 bg-[#EAB936] border-2 border-black block"></span>
                                è€ƒå®˜å›é¥‹åˆ†æ
                            </h2>
                            <p class="text-gray-500 font-bold mt-1 ml-7">Examiner Feedback Dashboard</p>
                        </div>
                        <div>
                             <button onclick="fetchFeedbackData()" class="bg-black text-white px-3 py-1.5 text-xs font-bold hover:bg-[#EAB936] hover:text-black transition-colors border border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)]">
                                <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i> RELOAD
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <p class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">å›é¥‹æ¨£æœ¬æ•¸</p>
                            <h3 class="text-4xl font-black" id="fb-stat-count">--</h3>
                            <div class="w-8 h-1 bg-[#1C4E8C] mt-2"></div>
                        </div>
                        <div class="bg-[#1A1A1A] text-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <p class="text-xs font-black text-gray-400 uppercase tracking-widest mb-1">å¹³å‡æ»¿æ„åº¦ (Q1-Q8)</p>
                            <h3 class="text-4xl font-black text-[#EAB936]" id="fb-stat-avg">--</h3>
                        </div>
                        <div class="bg-[#D03328] text-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <p class="text-xs font-black text-white/80 uppercase tracking-widest mb-1">éœ€é—œæ³¨é¢å‘ (Lowest)</p>
                            <h3 class="text-2xl font-black text-white mt-1" id="fb-stat-low">--</h3>
                            <p class="text-[10px] text-white/60 mt-1" id="fb-stat-low-score">Score: --</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold border-l-4 border-[#1C4E8C] pl-3">å…«å¤§é¢å‘æ»¿æ„åº¦</h3>
                            </div>
                            <div class="flex-1 min-h-[300px] relative"><canvas id="fb-chart-questions"></canvas></div>
                        </div>
                        <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold border-l-4 border-[#EAB936] pl-3">å„æ¸¬é©—ç«™æ»¿æ„åº¦</h3>
                            </div>
                            <div class="flex-1 min-h-[300px] relative"><canvas id="fb-chart-stations"></canvas></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <div class="lg:col-span-2 bg-white border-[3px] border-black p-6 bauhaus-shadow">
                            <div class="flex items-center gap-2 mb-6 border-b-2 border-gray-100 pb-2">
                                <h3 class="text-xl font-bold">æ–‡å­—å›é¥‹é—œéµå­—èˆ‡åˆ—è¡¨</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><div id="fb-keyword-cloud" class="flex flex-wrap gap-2 min-h-[100px] content-start"></div></div>
                                <div class="border-l-2 border-gray-100 pl-4"><div id="fb-comments-list" class="space-y-3 max-h-[200px] overflow-y-auto custom-scroll pr-2"></div></div>
                            </div>
                        </div>
                        <div class="bg-[#1A1A1A] text-white border-[3px] border-black p-6 bauhaus-shadow relative overflow-hidden">
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex items-center gap-2 mb-4 border-b border-gray-700 pb-2">
                                    <h3 class="text-xl font-bold">å“è³ªæ”¹å–„è¡Œå‹•</h3>
                                </div>
                                <div class="flex-1">
                                    <div class="mb-4">
                                        <h4 class="text-xs font-bold text-[#EAB936] uppercase tracking-wider mb-1">å„ªå…ˆæ”¹å–„é¢å‘</h4>
                                        <div id="fb-action-priority" class="text-lg font-bold">--</div>
                                    </div>
                                    <div class="mb-2">
                                        <h4 class="text-xs font-bold text-[#EAB936] uppercase tracking-wider mb-1">AI å»ºè­°è¡Œå‹•</h4>
                                        <p id="fb-action-suggestion" class="text-xs text-gray-300 leading-relaxed">...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold border-l-4 border-gray-400 pl-3">è©³ç´°æ•¸æ“šåˆ—è¡¨</h3>
                            <button onclick="exportFeedbackCSV()" class="text-xs font-bold underline hover:text-[#1C4E8C]">åŒ¯å‡º CSV</button>
                        </div>
                        <div class="overflow-x-auto max-h-[500px] custom-scroll">
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-black text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="p-3 whitespace-nowrap">æ—¥æœŸ</th><th class="p-3 whitespace-nowrap">è€ƒå®˜</th><th class="p-3 text-center">ç«™è™Ÿ</th>
                                        <th class="p-3 text-center">Q1</th><th class="p-3 text-center">Q2</th><th class="p-3 text-center">Q3</th><th class="p-3 text-center">Q4</th>
                                        <th class="p-3 text-center">Q5</th><th class="p-3 text-center">Q6</th><th class="p-3 text-center">Q7</th><th class="p-3 text-center">Q8</th>
                                        <th class="p-3 min-w-[200px]">è€ƒé¡Œå»ºè­°</th><th class="p-3 min-w-[200px]">æ•´é«”å»ºè­°</th>
                                    </tr>
                                </thead>
                                <tbody id="fb-data-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW 4: STUDENT FEEDBACK ANALYSIS -->
                <div id="view-student-analysis" class="p-4 md:p-8 animate-fade-in hidden">
                    <div class="flex flex-col md:flex-row justify-between items-end border-b-2 border-black pb-4 mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-black flex items-center gap-3">
                                <span class="w-4 h-8 bg-[#EAB936] border-2 border-black block"></span>
                                è€ƒç”Ÿå›é¥‹åˆ†æ
                            </h2>
                            <p class="text-gray-500 font-bold mt-1 ml-7">Student Feedback Analytics</p>
                        </div>
                        <div>
                             <button onclick="fetchStudentData()" class="bg-black text-white px-3 py-1.5 text-xs font-bold hover:bg-[#EAB936] hover:text-black transition-colors border border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)]">
                                <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i> RELOAD
                            </button>
                        </div>
                    </div>

                    <!-- Top Stats Row -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white border-[3px] border-black p-5 bauhaus-shadow relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">ç¸½å•å·ä»½æ•¸</p>
                                <h3 class="text-4xl font-black" id="stu-stat-count">--</h3>
                                <div class="w-8 h-1 bg-black mt-2"></div>
                            </div>
                        </div>
                        <div class="bg-[#1A1A1A] text-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-400 uppercase tracking-widest mb-1">å¹³å‡æ»¿æ„åº¦ (Q1-Q9)</p>
                                <h3 class="text-4xl font-black text-[#EAB936]" id="stu-stat-avg">--</h3>
                                <p class="text-[10px] text-gray-500 mt-1">æ»¿åˆ† 5.0</p>
                            </div>
                        </div>
                        <div class="bg-[#D03328] text-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-white/80 uppercase tracking-widest mb-1">SP æ¼”å‡ºçœŸå¯¦åº¦ (Q6)</p>
                                <h3 class="text-4xl font-black text-white" id="stu-stat-sp-score">--</h3>
                                <p class="text-[10px] text-white/60 mt-1">Target: > 4.5</p>
                            </div>
                        </div>
                        <div class="bg-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">é›£åº¦æ„ŸçŸ¥çœ¾æ•¸</p>
                                <h3 class="text-2xl font-black text-[#1C4E8C] mt-2 truncate" id="stu-stat-difficulty-mode">--</h3>
                                <p class="text-[10px] text-gray-400 mt-1">Q10 çµæœåˆ†ä½ˆ</p>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <div class="lg:col-span-2 bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6 border-b-2 border-gray-100 pb-2">
                                <h3 class="text-xl font-bold border-l-4 border-[#1C4E8C] pl-3">å„é¢å‘æ»¿æ„åº¦åˆ†æ (Q1-Q9)</h3>
                            </div>
                            <div class="flex-1 min-h-[350px] relative">
                                <canvas id="stu-chart-radar"></canvas>
                            </div>
                        </div>
                        <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6 border-b-2 border-gray-100 pb-2">
                                <h3 class="text-xl font-bold border-l-4 border-[#EAB936] pl-3">é›£åº¦åˆ†ä½ˆ (Q10)</h3>
                            </div>
                            <div class="flex-1 min-h-[300px] relative flex items-center justify-center">
                                <canvas id="stu-chart-difficulty"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Insights Row (Modified for Split Comments) -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col h-full">
                            <div class="flex items-center gap-2 mb-6 border-b-2 border-gray-100 pb-2">
                                <div class="bg-black text-white p-1.5"><i data-lucide="message-square" class="w-4 h-4"></i></div>
                                <h3 class="text-xl font-bold">è€ƒé¡Œèˆ‡æ•´é«”å»ºè­°</h3>
                            </div>
                            
                            <div class="mb-6">
                                <h4 class="text-sm font-bold text-[#1C4E8C] uppercase mb-2">ğŸ”¥ é«˜é »é—œéµå­—</h4>
                                <div id="stu-keyword-cloud" class="flex flex-wrap gap-2 min-h-[60px] content-start p-3 bg-gray-50 border border-gray-200"></div>
                            </div>

                            <!-- Split Comments Area -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1 overflow-hidden">
                                <div class="flex flex-col h-full">
                                    <h4 class="text-sm font-bold text-[#1C4E8C] uppercase mb-2 flex items-center gap-1">
                                        <i data-lucide="file-question" class="w-3 h-3"></i> Q11 è€ƒé¡Œå»ºè­°
                                    </h4>
                                    <div id="stu-comments-exam" class="space-y-2 flex-1 overflow-y-auto custom-scroll pr-2 bg-blue-50/50 p-2 border border-blue-100 min-h-[200px]"></div>
                                </div>
                                <div class="flex flex-col h-full">
                                    <h4 class="text-sm font-bold text-[#D03328] uppercase mb-2 flex items-center gap-1">
                                        <i data-lucide="messages-square" class="w-3 h-3"></i> Q12 æ•´é«”å»ºè­°
                                    </h4>
                                    <div id="stu-comments-general" class="space-y-2 flex-1 overflow-y-auto custom-scroll pr-2 bg-red-50/50 p-2 border border-red-100 min-h-[200px]"></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-[#1A1A1A] text-white border-[3px] border-black p-6 bauhaus-shadow relative overflow-hidden flex flex-col">
                            <div class="relative z-10">
                                <div class="flex items-center gap-2 mb-6 border-b border-gray-700 pb-2">
                                    <div class="bg-[#EAB936] text-black p-1.5"><i data-lucide="zap" class="w-4 h-4"></i></div>
                                    <h3 class="text-xl font-bold">å“è³ªæ”¹å–„å»ºè­° (AI Insights)</h3>
                                </div>
                                <div class="space-y-6">
                                    <div class="bg-[#222] p-4 border border-gray-700 rounded">
                                        <h4 class="text-xs font-bold text-[#D03328] uppercase tracking-wider mb-2">ğŸ”» æœ€ä½åˆ†é¢å‘</h4>
                                        <div class="flex items-end gap-3">
                                            <span id="stu-insight-lowest-dim" class="text-xl font-black text-white">--</span>
                                            <span id="stu-insight-lowest-score" class="text-sm font-bold text-gray-400 mb-1">Score: --</span>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-bold text-[#EAB936] uppercase tracking-wider mb-2">âš¡ å»ºè­°è¡Œå‹•æ–¹æ¡ˆ</h4>
                                        <p id="stu-insight-action" class="text-sm text-gray-300 leading-relaxed bg-black/50 p-4 border-l-4 border-[#EAB936]">
                                            ç­‰å¾…è³‡æ–™åˆ†æ...
                                        </p>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-2">ğŸ“Š é›£åº¦æ„ŸçŸ¥è§£è®€</h4>
                                        <p id="stu-insight-difficulty" class="text-sm text-gray-300 leading-relaxed">
                                            ç­‰å¾…è³‡æ–™åˆ†æ...
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold border-l-4 border-black pl-3">åŸå§‹æ•¸æ“šåˆ—è¡¨</h3>
                            <button onclick="exportStudentCSV()" class="text-xs font-bold underline hover:text-[#1C4E8C] flex items-center gap-1">
                                <i data-lucide="download" class="w-3 h-3"></i> åŒ¯å‡º CSV
                            </button>
                        </div>
                        <div class="overflow-x-auto max-h-[500px] custom-scroll">
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-black text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="p-3 whitespace-nowrap">æ™‚é–“</th><th class="p-3 whitespace-nowrap">å§“å</th><th class="p-3 whitespace-nowrap">æ—¥æœŸ</th>
                                        <th class="p-3 text-center">Q1</th><th class="p-3 text-center">Q2</th><th class="p-3 text-center">Q3</th>
                                        <th class="p-3 text-center">Q4</th><th class="p-3 text-center">Q5</th><th class="p-3 text-center">Q6</th>
                                        <th class="p-3 text-center">Q7</th><th class="p-3 text-center">Q8</th><th class="p-3 text-center">Q9</th>
                                        <th class="p-3 whitespace-nowrap">Q10</th><th class="p-3 min-w-[200px]">Q11</th><th class="p-3 min-w-[200px]">Q12</th>
                                    </tr>
                                </thead>
                                <tbody id="stu-data-table-body">
                                    <tr><td colspan="15" class="p-8 text-center text-gray-400">Loading data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW 5: SP FEEDBACK ANALYSIS (NEW INTEGRATION) -->
                <div id="view-sp-analysis" class="p-4 md:p-8 animate-fade-in hidden">
                    <div class="flex flex-col md:flex-row justify-between items-end border-b-2 border-black pb-4 mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-black flex items-center gap-3">
                                <span class="w-4 h-8 bg-black border-2 border-white block"></span>
                                æ¨™æº–åŒ–ç—…äºº(SP) å›é¥‹åˆ†æ
                            </h2>
                            <p class="text-gray-500 font-bold mt-1 ml-7">SP Feedback & Workload Analysis</p>
                        </div>
                        <div>
                             <button onclick="fetchSpFeedbackData()" class="bg-black text-white px-3 py-1.5 text-xs font-bold hover:bg-[#EAB936] hover:text-black transition-colors border border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)]">
                                <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i> RELOAD DATA
                            </button>
                        </div>
                    </div>

                    <!-- Top Stats Row -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white border-[3px] border-black p-5 bauhaus-shadow relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">SP å›é¥‹ä»½æ•¸</p>
                                <h3 class="text-4xl font-black" id="sp-stat-count">--</h3>
                                <div class="w-8 h-1 bg-black mt-2"></div>
                            </div>
                        </div>
                        <div class="bg-[#1A1A1A] text-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-400 uppercase tracking-widest mb-1">å¹³å‡æ»¿æ„åº¦ (Q1-Q6)</p>
                                <h3 class="text-4xl font-black text-[#EAB936]" id="sp-stat-avg">--</h3>
                                <p class="text-[10px] text-gray-500 mt-1">æ»¿åˆ† 5.0</p>
                            </div>
                        </div>
                        <div class="bg-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">å¹³å‡å¯¦éš›æ¼”å‡ºæ¬¡æ•¸</p>
                                <h3 class="text-4xl font-black text-[#1C4E8C]" id="sp-stat-avg-plays">--</h3>
                                <p class="text-[10px] text-gray-400 mt-1">Q4-1</p>
                            </div>
                        </div>
                        <div class="bg-[#D03328] text-white border-[3px] border-black p-5 bauhaus-shadow relative">
                            <div class="relative z-10">
                                <p class="text-xs font-black text-white/80 uppercase tracking-widest mb-1">è² æ“”æŒ‡æ•¸ (å¯¦éš›/å»ºè­°)</p>
                                <h3 class="text-4xl font-black text-white" id="sp-stat-workload">--</h3>
                                <p class="text-[10px] text-white/60 mt-1">> 100% è¡¨ç¤ºè¶…è¼‰</p>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <div class="lg:col-span-2 bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6 border-b-2 border-gray-100 pb-2">
                                <h3 class="text-xl font-bold border-l-4 border-black pl-3">å„é¢å‘æ»¿æ„åº¦åˆ†æ (Q1-Q6)</h3>
                            </div>
                            <div class="flex-1 min-h-[350px] relative">
                                <canvas id="sp-chart-radar"></canvas>
                            </div>
                        </div>
                        <div class="bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex justify-between items-center mb-6 border-b-2 border-gray-100 pb-2">
                                <h3 class="text-xl font-bold border-l-4 border-[#EAB936] pl-3">æ¼”å‡ºæ¬¡æ•¸åˆ†æ (Actual vs Ideal)</h3>
                            </div>
                            <div class="flex-1 min-h-[300px] relative flex items-center justify-center">
                                <canvas id="sp-chart-workload"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Comments & Table -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <div class="lg:col-span-1 bg-white border-[3px] border-black p-6 bauhaus-shadow flex flex-col">
                            <div class="flex items-center gap-2 mb-6 border-b-2 border-gray-100 pb-2">
                                <div class="bg-black text-white p-1.5"><i data-lucide="message-square" class="w-4 h-4"></i></div>
                                <h3 class="text-xl font-bold">SP å»ºè­°äº‹é … (Q7)</h3>
                            </div>
                            <div class="mb-4">
                                <h4 class="text-xs font-bold text-[#1C4E8C] uppercase mb-2">é—œéµå­—</h4>
                                <div id="sp-keyword-cloud" class="flex flex-wrap gap-2 min-h-[50px] content-start p-2 bg-gray-50 border border-gray-200"></div>
                            </div>
                            <div id="sp-comments-list" class="space-y-2 flex-1 overflow-y-auto custom-scroll pr-2 bg-gray-50 p-2 border border-gray-100 min-h-[200px]"></div>
                        </div>

                        <div class="lg:col-span-2 bg-white border-[3px] border-black p-6 bauhaus-shadow">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold border-l-4 border-black pl-3">SP å›é¥‹åŸå§‹æ•¸æ“š</h3>
                                <button onclick="exportSpCSV()" class="text-xs font-bold underline hover:text-[#1C4E8C] flex items-center gap-1">
                                    <i data-lucide="download" class="w-3 h-3"></i> åŒ¯å‡º CSV
                                </button>
                            </div>
                            <div class="overflow-x-auto max-h-[400px] custom-scroll">
                                <table class="w-full text-left text-sm border-collapse">
                                    <thead class="bg-black text-white sticky top-0 z-10">
                                        <tr>
                                            <th class="p-3 whitespace-nowrap">æ—¥æœŸ</th><th class="p-3 whitespace-nowrap">SPå§“å</th><th class="p-3 text-center">ç«™è™Ÿ</th>
                                            <th class="p-3 text-center">Q1</th><th class="p-3 text-center">Q2</th><th class="p-3 text-center">Q3</th>
                                            <th class="p-3 text-center">Q4</th><th class="p-3 text-center">Q4å¯¦éš›</th><th class="p-3 text-center">Q4å»ºè­°</th>
                                            <th class="p-3 text-center">Q5</th><th class="p-3 text-center">Q6</th>
                                            <th class="p-3 min-w-[200px]">å»ºè­°äº‹é … (Q7)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sp-data-table-body">
                                        <tr><td colspan="12" class="p-8 text-center text-gray-400">Waiting for data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Initialization & Logic -->
    <script>
        // --- CONFIGURATION ---
        const SP_API_URL = "https://script.google.com/macros/s/AKfycbzAZfDJS21_o7WIrXCpW0w-Hx8i_DtHQVSvIhj1nsIyge752nhDP_7caE1VzZvvEMtP/exec"; 
        const FEEDBACK_API_URL = "https://script.google.com/macros/s/AKfycbz-SVriuVdvHuqdwBV25N1INoeaSoF2VHrob_gZ7aBpxX_XqlfsEdzmmRgNAf4kRhAy/exec";
        const STUDENT_API_URL = "https://script.google.com/macros/s/AKfycbyOmRVnOcm7iwHjuQbww22k9g-MJ9Uzjn9obNli4x6SSpRko7nHottjxkGM-cR2euSfPA/exec";
        const SP_FEEDBACK_API_URL = "https://script.google.com/macros/s/AKfycbxHu6so82suf2dJofxzUtjw8opQSAElYkIK9YHHpzijgHV_thbBRIR3YYMb6_3A9DARVg/exec";
        
        let currentView = 'dashboard';
        
        // Data Stores
        let globalData = [];
        let globalSpMap = {}; 
        let rawFeedbackData = [];
        let rawStudentData = [];
        let rawSpFeedbackData = [];

        // Chart Instances
        let radarChartInstance = null;
        let barChartInstance = null;
        let feedbackCharts = {};
        let studentCharts = {};
        let spCharts = {};

        // Initialize Icons
        lucide.createIcons();
        
        // Initial Fetch
        checkConfigAndFetch();

        function checkConfigAndFetch() {
            fetchAllData();
        }

        // --- GLOBAL FETCH WRAPPER ---
        function fetchAllData() {
            fetchData();
            fetchFeedbackData();
            fetchStudentData();
            fetchSpFeedbackData();
        }

        // --- UNIFIED FILTER LOGIC ---
        function handleGlobalFilterChange() {
            if (currentView === 'examiner-sp-analysis') filterData();
            else if (currentView === 'examiner-analysis') applyFeedbackFilters();
            else if (currentView === 'student-analysis') applyStudentFilters();
            else if (currentView === 'sp-analysis') applySpFilters();
        }

        function updateDateDropdownForView(viewName) {
            const dateSelect = document.getElementById('global-date-filter');
            dateSelect.innerHTML = '<option value="all">å…¨éƒ¨å ´æ¬¡ All Sessions</option>';
            
            let dataArr = [];
            if (viewName === 'examiner-sp-analysis') dataArr = globalData;
            else if (viewName === 'examiner-analysis') dataArr = rawFeedbackData;
            else if (viewName === 'student-analysis') {
                dataArr = rawStudentData.map(r => ({ date: r[2] })); 
            }
            else if (viewName === 'sp-analysis') {
                dataArr = rawSpFeedbackData.map(item => ({ date: item.date || item.timestamp }));
            }

            const uniqueDates = [...new Set(dataArr.map(item => {
                let d = item.examDate || item.date;
                if(!d) return "";
                if(typeof d === 'string' && d.length >= 10) d = d.substring(0, 10);
                return d;
            }))].filter(d => d).sort().reverse();

            uniqueDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                dateSelect.appendChild(option);
            });
        }

        /* =========================================
           PART 1: SP ANALYSIS LOGIC
           ========================================= */
        async function fetchData() {
            try {
                const response = await fetch(SP_API_URL);
                const data = await response.json();
                if(data.error) throw new Error(data.error);
                globalData = data;
                if (currentView === 'dashboard' || currentView === 'examiner-sp-analysis') {
                    updateDateDropdownForView('examiner-sp-analysis');
                    filterData();
                }
                updateStatus("System Online", "green");
            } catch (error) {
                console.error("SP Fetch Error:", error);
                updateStatus("SP API Error", "red");
            }
        }

        function generateSPMap(data) {
            const uniqueNames = [...new Set(data.map(r => r.spName || r.SPName || "æœªçŸ¥SP"))];
            const nameMap = {};
            const usedDisplayNames = {}; 
            uniqueNames.forEach(name => {
                if(name === "æœªçŸ¥SP") { nameMap[name] = name; return; }
                let masked = (name.length <= 2) ? name.charAt(0) + "â—‹" : name.charAt(0) + "â—‹" + name.slice(-1);
                if (usedDisplayNames[masked]) { usedDisplayNames[masked]++; masked = `${masked} (${usedDisplayNames[masked]})`; } 
                else { usedDisplayNames[masked] = 1; }
                nameMap[name] = masked;
            });
            return nameMap;
        }

        function filterData() {
            const prof = document.getElementById('global-profession-filter').value;
            const year = document.getElementById('global-year-filter').value;
            const date = document.getElementById('global-date-filter').value;
            let filtered = globalData.filter(d => {
                if(prof !== 'all' && !d.profession.includes(prof)) return false;
                let dStr = (d.examDate && d.examDate.length > 10) ? d.examDate.substring(0, 10) : d.examDate;
                if(year !== 'all' && (!dStr || !dStr.includes(year))) return false;
                if(date !== 'all' && dStr !== date) return false;
                return true;
            });
            processData(filtered);
        }

        function processData(data) {
            if (Object.keys(globalSpMap).length === 0) globalSpMap = generateSPMap(globalData);
            const total = data.length;
            let totalSum = 0; let q1Sum = 0; let q8Sum = 0; let count = 0;
            let qSums = {q1:0, q2:0, q3:0, q4:0, q5:0, q6:0, q7:0, q8:0};
            let profStats = {}; let spPerformance = {}; let allComments = [];

            data.forEach(row => {
                const s = row.scores || {};
                const q1=s.q1||0; const q2=s.q2||0; const q3=s.q3||0; const q4=s.q4||0;
                const q5=s.q5||0; const q6=s.q6||0; const q7=s.q7||0; const q8=s.q8||0;
                let rowAvg = (q1+(q2>0?6-q2:0)+(q3>0?6-q3:0)+q4+q5+q6+q7+q8)/8; 
                totalSum += rowAvg; q1Sum += q1; q8Sum += q8; count++;
                qSums.q1+=q1; qSums.q2+=(6-q2); qSums.q3+=(6-q3); qSums.q4+=q4;
                qSums.q5+=q5; qSums.q6+=q6; qSums.q7+=q7; qSums.q8+=q8;

                const p = row.profession || "å…¶ä»–";
                if(!profStats[p]) profStats[p] = {sum:0, count:0};
                profStats[p].sum += rowAvg; profStats[p].count += 1;

                let sp = globalSpMap[row.spName||row.SPName||"æœªçŸ¥SP"];
                if(!spPerformance[sp]) spPerformance[sp] = {sum:0, count:0};
                spPerformance[sp].sum += rowAvg; spPerformance[sp].count += 1;
                if(row.generalComment) allComments.push(row.generalComment);
            });

            document.getElementById('stat-total-records').innerText = total;
            document.getElementById('stat-avg-score').innerText = count ? (totalSum / count).toFixed(1) : "-";
            document.getElementById('stat-q1-score').innerText = count ? (q1Sum / count).toFixed(1) : "-";
            document.getElementById('stat-q8-score').innerText = count ? (q8Sum / count).toFixed(1) : "-";

            if (total > 0 && currentView === 'examiner-sp-analysis') {
                renderRadarChart(qSums, total);
                renderProfessionChart(profStats);
                renderInsights(qSums, total, allComments, spPerformance);
            }
            renderTable(data);
        }

        // Restored renderRadarChart
        function renderRadarChart(qSums, total) {
            const ctx = document.getElementById('chart-radar').getContext('2d');
            const avgs = [
                qSums.q1/total, qSums.q2/total, qSums.q3/total, qSums.q4/total,
                qSums.q5/total, qSums.q6/total, qSums.q7/total, qSums.q8/total
            ].map(v => v.toFixed(2));

            if(radarChartInstance) radarChartInstance.destroy();
            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ["Q1 è§’è‰²", "Q2 é¿å…æ“å¼„", "Q3 é¿å…è³ªç–‘", "Q4 èº«é«”", "Q5 è¡¨æƒ…", "Q6 è‚¢é«”", "Q7 å›ç­”", "Q8 æ…‹åº¦"],
                    datasets: [{
                        label: 'å¹³å‡å¾—åˆ†',
                        data: avgs,
                        backgroundColor: 'rgba(28, 78, 140, 0.2)',
                        borderColor: '#1C4E8C',
                        pointBackgroundColor: '#EAB936',
                        borderWidth: 3
                    }]
                },
                options: {
                    scales: { r: { min: 1, max: 5, ticks: { stepSize: 1 } } },
                    maintainAspectRatio: false
                }
            });
        }

        // Restored renderProfessionChart
        function renderProfessionChart(profStats) {
            const ctx = document.getElementById('chart-profession').getContext('2d');
            const labels = Object.keys(profStats);
            const data = labels.map(k => (profStats[k].sum / profStats[k].count).toFixed(2));
            
            if(barChartInstance) barChartInstance.destroy();
            barChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å¹³å‡è©•åˆ†',
                        data: data,
                        backgroundColor: '#EAB936',
                        borderColor: '#000',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: { y: { min: 0, max: 5 } },
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Restored renderInsights
        function renderInsights(qSums, total, comments, spPerformance) {
            // Keywords
            const stopWords = ["ç„¡", "æ²’æœ‰", "sp", "çš„", "å¾ˆ", "ä¹Ÿ", "äº†", "æœ‰", "è¡¨ç¾", "å­¸ç”Ÿ", "è€ƒç”Ÿ", "good", "ok", "å°šå¯"];
            let wordCounts = {};
            comments.forEach(c => {
                const words = String(c).replace(/[.,\/#!$%\^&\*;:{}=\-_`~()ã€‚ï¼Œã€ï¼]/g," ").split(/\s+/);
                words.forEach(w => {
                    if(w.length > 1 && !stopWords.includes(w.toLowerCase())) {
                        wordCounts[w] = (wordCounts[w] || 0) + 1;
                    }
                });
            });
            const sortedWords = Object.entries(wordCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
            
            const cloudContainer = document.getElementById('keyword-cloud');
            cloudContainer.innerHTML = '';
            sortedWords.forEach(([word, count]) => {
                const tag = document.createElement('span');
                const isNeg = ["å°è²", "çŸ›ç›¾", "ä¸è‡ªç„¶", "éåº¦", "å·®"].some(n => word.includes(n));
                tag.className = `keyword-tag ${isNeg ? 'keyword-neg' : 'keyword-pos'}`;
                tag.textContent = `${word} (${count})`;
                cloudContainer.appendChild(tag);
            });

            // Comments
            const listContainer = document.getElementById('recent-comments-list');
            listContainer.innerHTML = '';
            comments.slice(-6).reverse().forEach(c => {
                const div = document.createElement('div');
                div.className = "text-xs border-b border-gray-100 pb-1 mb-1 text-gray-600";
                div.innerText = `"${c}"`;
                listContainer.appendChild(div);
            });

            // SP Watchlist
            const sortedSPs = Object.entries(spPerformance)
                .map(([name, data]) => ({name, avg: data.sum/data.count, count: data.count}))
                .sort((a,b) => a.avg - b.avg).slice(0, 3);
            
            const spListEl = document.getElementById('sp-watchlist');
            spListEl.innerHTML = '';
            if(sortedSPs.length > 0) {
                sortedSPs.forEach(sp => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center text-xs";
                    const colorClass = sp.avg < 3.5 ? "text-red-400 font-bold" : "text-gray-300";
                    li.innerHTML = `<span>${sp.name}</span> <span class="${colorClass}">${sp.avg.toFixed(1)} <span class="text-[10px] text-gray-500">(${sp.count}ç­†)</span></span>`;
                    spListEl.appendChild(li);
                });
            } else {
                spListEl.innerHTML = '<li class="text-gray-500">ç„¡è¶³å¤ æ•¸æ“š</li>';
            }

            // Action Plan
            const avgs = { "Q1 è§’è‰²": qSums.q1/total, "Q2 é¿å…æ“å¼„": qSums.q2/total, "Q3 é¿å…è³ªç–‘": qSums.q3/total, "Q4 èº«é«”": qSums.q4/total, "Q5 è¡¨æƒ…": qSums.q5/total, "Q6 è‚¢é«”": qSums.q6/total, "Q7 å›ç­”": qSums.q7/total, "Q8 æ…‹åº¦": qSums.q8/total };
            let minScore = 6; let weakPoint = "";
            for (const [key, val] of Object.entries(avgs)) { if(val < minScore) { minScore = val; weakPoint = key; } }
            document.getElementById('action-priority').innerText = weakPoint + ` (Score: ${minScore.toFixed(1)})`;
            document.getElementById('action-suggestion').innerText = `é‡å°ã€Œ${weakPoint}ã€é¢å‘ï¼Œå»ºè­°å®‰æ’ SP é€²è¡Œå·¥ä½œåŠå›è¨“æˆ–å€‹åˆ¥æŒ‡å°ã€‚`;
        }

        function renderTable(data) {
             const tbody = document.getElementById('table-comments-body'); tbody.innerHTML = '';
             data.slice(0, 50).forEach(row => {
                 let sp = globalSpMap[row.spName||row.SPName||"æœªçŸ¥SP"];
                 let tr = document.createElement('tr');
                 tr.className = "border-b border-gray-200 text-xs hover:bg-gray-50";
                 tr.innerHTML = `<td class="p-3">${row.examDate}</td><td class="p-3 font-bold">${sp}</td><td class="p-3">${row.examinerName}</td><td class="p-3">${row.stationNumber}</td><td class="p-3">${row.profession}</td><td class="p-3">${row.scores.q1}</td><td class="p-3 text-red-500">${row.scores.q2}</td><td class="p-3 text-red-500">${row.scores.q3}</td><td class="p-3">${row.scores.q4}</td><td class="p-3">${row.scores.q5}</td><td class="p-3">${row.scores.q6}</td><td class="p-3">${row.scores.q7}</td><td class="p-3">${row.scores.q8}</td><td class="p-3 truncate max-w-[200px]">${row.generalComment||'-'}</td>`;
                 tbody.appendChild(tr);
             });
        }

        /* =========================================
           PART 2: EXAMINER FEEDBACK LOGIC
           ========================================= */
        async function fetchFeedbackData() {
            try {
                const response = await fetch(FEEDBACK_API_URL);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                rawFeedbackData = data;
                if (currentView === 'examiner-analysis') {
                    updateDateDropdownForView('examiner-analysis');
                    applyFeedbackFilters();
                }
            } catch (error) { console.error("Feedback Error", error); }
        }

        function applyFeedbackFilters() {
            const year = document.getElementById('global-year-filter').value;
            const date = document.getElementById('global-date-filter').value;
            const station = document.getElementById('global-station-filter').value;
            const filtered = rawFeedbackData.filter(d => {
                let dStr = (d.date || d.examDate || '').substring(0, 10);
                if (year !== 'all' && !dStr.includes(year)) return false;
                if (date !== 'all' && dStr !== date) return false;
                if (station !== 'all' && String(d.stationNumber) !== station) return false;
                return true;
            });
            renderFeedbackDashboard(filtered);
        }

        function renderFeedbackDashboard(data) {
            const total = data.length;
            let qSums = Array(8).fill(0);
            let stationStats = {};
            let comments = [];
            data.forEach(row => {
                const scores = [row.q1, row.q2, row.q3, row.q4, row.q5, row.q6, row.q7, row.q8].map(v => Number(v) || 0);
                scores.forEach((v, i) => qSums[i] += v);
                const st = row.stationNumber || "Unk";
                if (!stationStats[st]) stationStats[st] = { sum: 0, count: 0 };
                const rowAvg = scores.reduce((a, b) => a + b, 0) / 8;
                stationStats[st].sum += rowAvg;
                stationStats[st].count++;
                if (row.q9) comments.push(row.q9);
                if (row.q10) comments.push(row.q10);
            });
            
            const qAvgs = qSums.map(s => total > 0 ? (s / total).toFixed(2) : 0);
            const totalAvg = total > 0 ? (qSums.reduce((a, b) => a + b, 0) / (total * 8)).toFixed(2) : 0;
            
            document.getElementById('fb-stat-count').innerText = total;
            document.getElementById('fb-stat-avg').innerText = totalAvg;
            
            let minVal = 6, minIdx = -1;
            qAvgs.forEach((v, i) => { if (Number(v) > 0 && Number(v) < minVal) { minVal = Number(v); minIdx = i; } });
            const labels = ["Q1 æ¸¬é©—å…§å®¹", "Q2 è©•æ ¸é …ç›®", "Q3 è©•åˆ†èªªæ˜", "Q4 è©¦é¡ŒæŒ‡å¼•", "Q5 æ¸¬é©—æ™‚é–“", "Q6 å‹•ç·šè¦åŠƒ", "Q7 å»£æ’­éˆ´è²", "Q8 è©¦å‹™æµç¨‹"];
            document.getElementById('fb-stat-low').innerText = minIdx >= 0 ? labels[minIdx] : "ç„¡";
            document.getElementById('fb-stat-low-score').innerText = minIdx >= 0 ? `Score: ${minVal.toFixed(2)}` : "--";

            if (currentView === 'examiner-analysis') {
                renderFeedbackCharts(labels, qAvgs, stationStats);
                renderFeedbackInsights(comments, minIdx, labels[minIdx]);
            }
            renderFeedbackTable(data);
        }
        function renderFeedbackCharts(labels, data, stationStats) {
             const ctxQ = document.getElementById('fb-chart-questions').getContext('2d');
             if (feedbackCharts.q) feedbackCharts.q.destroy();
             feedbackCharts.q = new Chart(ctxQ, { type: 'bar', data: { labels: labels, datasets: [{ label: 'æ»¿æ„åº¦', data: data, backgroundColor: '#1C4E8C' }] }, options: { indexAxis: 'y', maintainAspectRatio: false } });
             
             const stLabels = Object.keys(stationStats).sort((a,b)=>Number(a)-Number(b));
             const stData = stLabels.map(k=>(stationStats[k].sum/stationStats[k].count).toFixed(2));
             const ctxS = document.getElementById('fb-chart-stations').getContext('2d');
             if (feedbackCharts.s) feedbackCharts.s.destroy();
             feedbackCharts.s = new Chart(ctxS, { type: 'bar', data: { labels: stLabels.map(s=>`ç¬¬${s}ç«™`), datasets: [{ label: 'æ»¿æ„åº¦', data: stData, backgroundColor: '#EAB936' }] }, options: { maintainAspectRatio: false } });
        }
        
        // Restored renderFeedbackInsights
        function renderFeedbackInsights(comments, lowestIdx, lowestDim) {
            const stopWords = ["ç„¡", "æ²’æœ‰", "å»ºè­°", "è€ƒé¡Œ", "çš„", "è¦ºå¾—", "å°šå¯", "è‰¯å¥½", "ok", "good", "æ˜¯", "åœ¨"];
            let wordCounts = {};
            comments.forEach(c => {
                String(c).replace(/[.,\/#!$%\^&\*;:{}=\-_`~()ã€‚ï¼Œã€ï¼]/g, " ").split(/\s+/).forEach(w => {
                    if (w.length > 1 && !stopWords.includes(w.toLowerCase())) wordCounts[w] = (wordCounts[w] || 0) + 1;
                });
            });
            const sortedWords = Object.entries(wordCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            const cloud = document.getElementById('fb-keyword-cloud');
            cloud.innerHTML = '';
            if (sortedWords.length === 0) cloud.innerHTML = '<span class="text-gray-400 text-xs">ç„¡è¶³å¤ è³‡æ–™åˆ†æ</span>';
            sortedWords.forEach(([w, c]) => {
                const isNeg = ["ä¸è¶³", "å¤ªçŸ­", "åµ", "å‹•ç·š", "é›£", "ä¸ä½³"].some(n => w.includes(n));
                cloud.innerHTML += `<span class="keyword-tag ${isNeg ? 'keyword-neg' : 'keyword-pos'}">${w} (${c})</span>`;
            });

            const listEl = document.getElementById('fb-comments-list');
            listEl.innerHTML = '';
            comments.filter(c => c && String(c).trim() !== "").slice(-6).reverse().forEach(c => {
                listEl.innerHTML += `<div class="text-xs border-b border-gray-200 pb-2 mb-2 text-gray-700">"${c}"</div>`;
            });

            document.getElementById('fb-action-priority').innerText = lowestDim || "ç„¡é¡¯è‘—å•é¡Œ";
            const actions = {
                0: "å»ºè­°é‡æ–°å¯©è¦–è€ƒé¡Œé‘‘åˆ¥åº¦èˆ‡é›£æ˜“åº¦åˆ†ä½ˆï¼Œæˆ–å¬é–‹å…±è­˜æœƒè­°èª¿æ•´è©•åˆ†æ¨™æº–ã€‚",
                1: "è©•åˆ†é …ç›®å¯èƒ½éæ–¼ç¹ç‘£æˆ–æ¨¡ç³Šï¼Œå»ºè­°ç°¡åŒ–è©•æ ¸è¡¨æˆ–å…·é«”åŒ–è¡Œç‚ºæŒ‡æ¨™ã€‚",
                2: "è©•åˆ†èªªæ˜å¯èƒ½ä¸å¤ æ˜ç¢ºï¼Œå»ºè­°åœ¨è€ƒå®˜å…±è­˜ç‡Ÿä¸­åŠ å¼·èªªæ˜æˆ–æä¾›ç¯„ä¾‹å½±ç‰‡ã€‚",
                3: "è©¦é¡ŒæŒ‡å¼•è³‡è¨Šå¯èƒ½ä¸è¶³ï¼Œå»ºè­°å¢åŠ è€ƒç”Ÿç«¯æˆ–è€ƒå®˜ç«¯çš„èƒŒæ™¯è³‡è¨Šèªªæ˜ã€‚",
                4: "æ¸¬é©—æ™‚é–“å®‰æ’å¯èƒ½éæ–¼ç·Šæ¹Šï¼Œå»ºè­°æª¢è¦–è€ƒé¡Œä»½é‡æˆ–è€ƒæ…®èª¿æ•´è€ƒè©¦æ™‚é–“ã€‚",
                5: "å‹•ç·šè¦åŠƒå¯èƒ½æœ‰æ”¹é€²ç©ºé–“ï¼Œå»ºè­°æª¢è¦–è€ƒå ´æ¨™ç¤ºæˆ–äººå“¡å¼•å°é…ç½®ã€‚",
                6: "å»£æ’­æˆ–éˆ´è²ç³»çµ±å¯èƒ½æœ‰å¹²æ“¾ï¼Œå»ºè­°æª¢æŸ¥ç¡¬é«”è¨­å‚™æˆ–èª¿æ•´éŸ³é‡è¨­å®šã€‚",
                7: "è©¦å‹™æµç¨‹æœ‰å„ªåŒ–ç©ºé–“ï¼Œå»ºè­°åŠ å¼·è©¦å‹™äººå“¡åŸ¹è¨“æˆ–æ¨™æº–åŒ–ä½œæ¥­ç¨‹åºã€‚"
            };
            document.getElementById('fb-action-suggestion').innerText = actions[lowestIdx] || "ç›®å‰å„é¢å‘è¡¨ç¾è‰¯å¥½ï¼Œè«‹æŒçºŒä¿æŒç›£æ¸¬ã€‚";
        }

        // Restored renderFeedbackTable
        function renderFeedbackTable(data) {
            const tbody = document.getElementById('fb-data-table-body');
            tbody.innerHTML = '';
            const getCell = (val) => {
                const n = Number(val);
                let cls = "text-center p-3 font-mono";
                if (n <= 2) cls += " text-red-600 font-bold bg-red-50";
                else if (n >= 5) cls += " text-[#1C4E8C] font-bold";
                else cls += " text-gray-600";
                return `<td class="${cls}">${n || '-'}</td>`;
            };
            data.slice(0, 100).forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200 hover:bg-gray-50 text-xs transition-colors";
                const dateStr = (row.date || row.examDate || '').substring(0, 10);
                tr.innerHTML = `
                    <td class="p-3 font-mono text-gray-500">${dateStr}</td>
                    <td class="p-3 font-bold">${row.examinerName || '-'}</td>
                    <td class="p-3 text-center"><span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">${row.stationNumber}</span></td>
                    ${getCell(row.q1)}${getCell(row.q2)}${getCell(row.q3)}${getCell(row.q4)}
                    ${getCell(row.q5)}${getCell(row.q6)}${getCell(row.q7)}${getCell(row.q8)}
                    <td class="p-3 text-gray-600 truncate max-w-[150px]" title="${row.q9}">${row.q9 || '-'}</td>
                    <td class="p-3 text-gray-600 truncate max-w-[150px]" title="${row.q10}">${row.q10 || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        function exportFeedbackCSV() { /* ... */ }

        /* =========================================
           PART 3: STUDENT FEEDBACK LOGIC
           ========================================= */
        async function fetchStudentData() {
            try {
                const response = await fetch(STUDENT_API_URL);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                // Data format: Array of arrays. [Time, Name, Date, Q1...Q9, Q10, Q11, Q12]
                rawStudentData = data;
                if (currentView === 'student-analysis') {
                    updateDateDropdownForView('student-analysis');
                    applyStudentFilters();
                }
                console.log("Student Data Loaded:", data.length);
            } catch (error) {
                console.error("Student Fetch Error:", error);
            }
        }

        function applyStudentFilters() {
            const year = document.getElementById('global-year-filter').value;
            const date = document.getElementById('global-date-filter').value;
            
            const filtered = rawStudentData.filter(row => {
                let dStr = row[2]; // Index 2 is Date
                if (typeof dStr === 'string' && dStr.length > 10) dStr = dStr.substring(0, 10);
                if (year !== 'all' && !dStr.includes(year)) return false;
                if (date !== 'all' && dStr !== date) return false;
                return true;
            });
            renderStudentDashboard(filtered);
        }

        function renderStudentDashboard(data) {
            const total = data.length;
            let qSums = Array(9).fill(0);
            let difficultyCounts = {};
            let spScoreSum = 0; // Q6 is index 5 in qSums (Q1=0)
            let comments = [];

            data.forEach(row => {
                // Indices: 3=Q1, 4=Q2, ... 11=Q9
                for (let i=0; i<9; i++) {
                    let s = Number(row[i+3]) || 0;
                    qSums[i] += s;
                    if (i === 5) spScoreSum += s;
                }
                let diff = row[12] || "æœªå¡«ç­”";
                difficultyCounts[diff] = (difficultyCounts[diff] || 0) + 1;
                if (row[13]) comments.push({ text: row[13], type: 'è€ƒé¡Œ' });
                if (row[14]) comments.push({ text: row[14], type: 'æ•´é«”' });
            });

            const qAvgs = qSums.map(s => total > 0 ? (s / total).toFixed(2) : 0);
            const totalAvg = total > 0 ? (qSums.reduce((a,b)=>a+b,0)/(total*9)).toFixed(2) : 0;
            const spAvg = total > 0 ? (spScoreSum / total).toFixed(2) : 0;

            let maxCount = 0; let modeDiff = "ç„¡";
            for (let [k, v] of Object.entries(difficultyCounts)) { if(v > maxCount) { maxCount=v; modeDiff=k; } }

            document.getElementById('stu-stat-count').innerText = total;
            document.getElementById('stu-stat-avg').innerText = totalAvg;
            document.getElementById('stu-stat-sp-score').innerText = spAvg;
            document.getElementById('stu-stat-difficulty-mode').innerText = modeDiff;

            if (currentView === 'student-analysis') {
                renderStudentCharts(qAvgs, difficultyCounts);
                renderStudentInsights(comments, qAvgs, modeDiff);
            }
            renderStudentTable(data);
        }

        function renderStudentCharts(qAvgs, diffCounts) {
            // Radar
            const ctxR = document.getElementById('stu-chart-radar').getContext('2d');
            if (studentCharts.radar) studentCharts.radar.destroy();
            const labels = ["Q1 å…§å®¹", "Q2 å‹•ç·š", "Q3 æŒ‡å¼•", "Q4 SPæ™‚é–“", "Q5 SPé›£åº¦", "Q6 SPæ¼”å‡º", "Q7 æŠ€èƒ½æ™‚é–“", "Q8 æŠ€èƒ½é›£åº¦", "Q9 æµç¨‹"];
            studentCharts.radar = new Chart(ctxR, {
                type: 'radar',
                data: { labels: labels, datasets: [{ label: 'å¹³å‡æ»¿æ„åº¦', data: qAvgs, backgroundColor: 'rgba(28, 78, 140, 0.2)', borderColor: '#1C4E8C', borderWidth: 3 }] },
                options: { scales: { r: { min: 1, max: 5 } }, maintainAspectRatio: false }
            });

            // Difficulty Pie
            const ctxP = document.getElementById('stu-chart-difficulty').getContext('2d');
            if (studentCharts.pie) studentCharts.pie.destroy();
            const diffLabels = ["éå¸¸ç°¡å–®", "ç°¡å–®", "å‰›å¥½", "å›°é›£", "éå¸¸å›°é›£"];
            const diffColors = ['#1C4E8C', '#60A5FA', '#EAB936', '#F87171', '#D03328'];
            const diffData = diffLabels.map(l => diffCounts[l] || 0);
            studentCharts.pie = new Chart(ctxP, {
                type: 'doughnut',
                data: { labels: diffLabels, datasets: [{ data: diffData, backgroundColor: diffColors, borderColor: '#1A1A1A', borderWidth: 2 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        // Restored renderStudentInsights (with Action Plan)
        function renderStudentInsights(comments, qAvgs, modeDiff) {
            // Keywords
            const stopWords = ["ç„¡", "æ²’æœ‰", "å»ºè­°", "è¦ºå¾—", "çš„", "æ˜¯", "å¾ˆ", "æœ‰", "ä¹Ÿ", "äº†"];
            let wordCounts = {};
            comments.forEach(c => {
                String(c.text).replace(/[.,\/#!$%\^&\*;:{}=\-_`~()ã€‚ï¼Œã€ï¼ï¼Ÿ]/g, " ").split(/\s+/).forEach(w => {
                    if (w.length > 1 && !stopWords.includes(w)) wordCounts[w] = (wordCounts[w] || 0) + 1;
                });
            });
            const sorted = Object.entries(wordCounts).sort((a,b)=>b[1]-a[1]).slice(0, 10);
            const cloud = document.getElementById('stu-keyword-cloud'); cloud.innerHTML = '';
            sorted.forEach(([w, c]) => {
                cloud.innerHTML += `<span class="keyword-tag">${w} (${c})</span>`;
            });

            // Split Comments
            const examList = document.getElementById('stu-comments-exam'); 
            const generalList = document.getElementById('stu-comments-general');
            if(examList) examList.innerHTML = '';
            if(generalList) generalList.innerHTML = '';

            const examComments = comments.filter(c => c.type === 'è€ƒé¡Œ').reverse().slice(0, 20);
            const generalComments = comments.filter(c => c.type === 'æ•´é«”').reverse().slice(0, 20);

            if(examList) {
                if(examComments.length === 0) examList.innerHTML = '<div class="text-xs text-gray-400 text-center py-4">ç„¡è€ƒé¡Œå»ºè­°</div>';
                examComments.forEach(c => {
                    examList.innerHTML += `<div class="p-2 bg-white border-l-4 border-[#1C4E8C] text-xs text-gray-700 shadow-sm mb-2">${c.text}</div>`;
                });
            }

            if(generalList) {
                if(generalComments.length === 0) generalList.innerHTML = '<div class="text-xs text-gray-400 text-center py-4">ç„¡æ•´é«”å»ºè­°</div>';
                generalComments.forEach(c => {
                    generalList.innerHTML += `<div class="p-2 bg-white border-l-4 border-[#D03328] text-xs text-gray-700 shadow-sm mb-2">${c.text}</div>`;
                });
            }

            // Insights (Restored)
            let minScore = 6; 
            let minIdx = -1;
            qAvgs.forEach((s, i) => { 
                if(Number(s)>0 && Number(s)<minScore) { 
                    minScore=Number(s); 
                    minIdx=i; 
                } 
            });
            
            const labels = ["Q1 å…§å®¹", "Q2 å‹•ç·š", "Q3 æŒ‡å¼•", "Q4 SPæ™‚é–“", "Q5 SPé›£åº¦", "Q6 SPæ¼”å‡º", "Q7 æŠ€èƒ½æ™‚é–“", "Q8 æŠ€èƒ½é›£åº¦", "Q9 æµç¨‹"];
            const suggestions = [
                "æª¢è¦–è€ƒé¡Œèˆ‡å¹³æ—¥æ•™å­¸é€£çµåº¦ï¼ŒåŠ å¼·è€ƒå‰è¤‡ç¿’ã€‚", 
                "æª¢æŸ¥è€ƒå ´æ¨™ç¤ºæ˜¯å¦è„«è½ï¼Œå„ªåŒ–ç§»å‹•å‹•ç·šã€‚", 
                "å¢åŠ è©¦é¡ŒæŒ‡å¼•ç¯„ä¾‹ï¼Œç¢ºä¿è€ƒç”Ÿç†è§£é¡Œæ„ã€‚", 
                "è©•ä¼°SPç«™è€ƒé¡Œä»½é‡ï¼Œæˆ–è€ƒæ…®å»¶é•·æ™‚é–“ã€‚", 
                "èª¿æ•´SPåŠ‡æœ¬é›£åº¦ï¼Œé¿å…éæ–¼åˆé‘½ã€‚", 
                "åŠ å¼·SPæ¼”å‡ºè¨“ç·´ï¼Œç¢ºä¿è¡¨æ¼”ä¸€è‡´æ€§ã€‚", 
                "è©•ä¼°æŠ€èƒ½ç«™æ“ä½œç¹ç‘£åº¦ï¼Œç°¡åŒ–æµç¨‹ã€‚", 
                "æª¢è¦–æŠ€èƒ½è©•åˆ†æ¨™æº–ï¼Œé¿å…éæ–¼åš´è‹›ã€‚", 
                "åŠ å¼·è©¦å‹™äººå“¡è¨“ç·´ï¼Œç¶­æŒè€ƒå ´ç§©åºã€‚"
            ];
            
            document.getElementById('stu-insight-lowest-dim').innerText = minIdx >= 0 ? labels[minIdx] : "ç„¡";
            document.getElementById('stu-insight-lowest-score').innerText = minIdx >= 0 ? `Score: ${minScore.toFixed(2)}` : "--";
            document.getElementById('stu-insight-action').innerText = minIdx >= 0 ? suggestions[minIdx] : "å„é …æŒ‡æ¨™è¡¨ç¾è‰¯å¥½ã€‚";
            
            let diffMsg = "é›£åº¦é©ä¸­";
            if(modeDiff.includes("å›°é›£")) diffMsg = "å¤šæ•¸è€ƒç”Ÿæ„Ÿåˆ°å›°é›£ï¼Œå»ºè­°æª¢è¦–è©•åˆ†æ¨™æº–æˆ–æ•™å­¸å…§å®¹ã€‚";
            else if(modeDiff.includes("ç°¡å–®")) diffMsg = "å¤šæ•¸è€ƒç”Ÿèªç‚ºç°¡å–®ï¼Œå¯è€ƒæ…®å¢åŠ è€ƒé¡Œé‘‘åˆ¥åº¦ã€‚";
            document.getElementById('stu-insight-difficulty').innerText = diffMsg;
        }

        function renderStudentTable(data) {
            const tbody = document.getElementById('stu-data-table-body');
            tbody.innerHTML = '';
            data.slice(0, 50).forEach(row => {
                let dateStr = row[2];
                if(typeof dateStr === 'string' && dateStr.length > 10) dateStr = dateStr.substring(0, 10);
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200 text-xs hover:bg-gray-50";
                
                // Helper for score color
                const sc = (v) => {
                    let c = "text-center p-3 font-mono text-gray-600";
                    if(v<=2) c += " text-red-600 font-bold bg-red-50";
                    else if(v>=5) c += " text-[#1C4E8C] font-bold";
                    return `<td class="${c}">${v||'-'}</td>`;
                };

                tr.innerHTML = `
                    <td class="p-3 font-mono text-gray-400">${row[0]?new Date(row[0]).toLocaleTimeString():'-'}</td>
                    <td class="p-3 font-bold text-[#1C4E8C]">${row[1]||'-'}</td>
                    <td class="p-3 font-mono">${dateStr||'-'}</td>
                    ${sc(row[3])}${sc(row[4])}${sc(row[5])}${sc(row[6])}${sc(row[7])}
                    ${sc(row[8])}${sc(row[9])}${sc(row[10])}${sc(row[11])}
                    <td class="p-3 text-center font-bold">${row[12]||'-'}</td>
                    <td class="p-3 truncate max-w-[150px]">${row[13]||'-'}</td>
                    <td class="p-3 truncate max-w-[150px]">${row[14]||'-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportStudentCSV() { /* ... */ }

        /* =========================================
           PART 4: SP FEEDBACK LOGIC (NEW)
           ========================================= */
        async function fetchSpFeedbackData() {
            try {
                const response = await fetch(`${SP_FEEDBACK_API_URL}?t=${new Date().getTime()}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                if (!Array.isArray(data)) throw new Error("Format Error");
                
                rawSpFeedbackData = data;
                if (currentView === 'sp-analysis') {
                    updateDateDropdownForView('sp-analysis');
                    applySpFilters();
                }
                console.log("SP Feedback Data Loaded:", data.length);
            } catch (error) {
                console.error("SP Feedback Fetch Error:", error);
            }
        }

        function applySpFilters() {
            const year = document.getElementById('global-year-filter').value;
            const date = document.getElementById('global-date-filter').value;
            const station = document.getElementById('global-station-filter').value;

            const filtered = rawSpFeedbackData.filter(row => {
                let dStr = (row.date || row.timestamp || '').toString();
                if(dStr.length >= 10) dStr = dStr.substring(0, 10);

                if (year !== 'all' && !dStr.includes(year)) return false;
                if (date !== 'all' && dStr !== date) return false;
                if (station !== 'all' && String(row.stationNumber) !== station) return false;
                return true;
            });
            renderSpDashboard(filtered);
        }

        function renderSpDashboard(data) {
            const total = data.length;
            let qSums = Array(6).fill(0); // Q1-Q6
            let actualPlaysSum = 0;
            let idealPlaysSum = 0;
            let comments = [];
            
            data.forEach(row => {
                const scores = [row.q1, row.q2, row.q3, row.q4, row.q5, row.q6].map(v => Number(v) || 0);
                scores.forEach((v, i) => qSums[i] += v);
                
                actualPlaysSum += (Number(row.q4_1) || 0);
                idealPlaysSum += (Number(row.q4_2) || 0);
                
                if (row.q7_comment && String(row.q7_comment).trim() !== "") {
                    comments.push(row.q7_comment);
                }
            });

            const qAvgs = qSums.map(s => total > 0 ? (s / total).toFixed(2) : 0);
            const totalAvg = total > 0 ? (qSums.reduce((a,b)=>a+b,0) / (total * 6)).toFixed(2) : 0;
            const avgActual = total > 0 ? (actualPlaysSum / total).toFixed(1) : 0;
            const workloadIndex = (idealPlaysSum > 0) ? Math.round((actualPlaysSum / idealPlaysSum) * 100) : 0;

            document.getElementById('sp-stat-count').innerText = total;
            document.getElementById('sp-stat-avg').innerText = totalAvg;
            document.getElementById('sp-stat-avg-plays').innerText = avgActual;
            
            const workloadEl = document.getElementById('sp-stat-workload');
            workloadEl.innerText = workloadIndex + "%";
            workloadEl.className = workloadIndex > 110 ? "text-4xl font-black text-red-500" : "text-4xl font-black text-white";

            if (currentView === 'sp-analysis') {
                renderSpCharts(qAvgs, avgActual, (idealPlaysSum/total).toFixed(1));
                renderSpComments(comments);
            }
            renderSpTable(data);
        }

        function renderSpCharts(qAvgs, avgActual, avgIdeal) {
            // Radar
            const ctxR = document.getElementById('sp-chart-radar').getContext('2d');
            if (spCharts.radar) spCharts.radar.destroy();
            const labels = ["Q1 åŠ‡æœ¬æ¼”å‡º", "Q2 è€ƒå‰æ¼”ç·´", "Q3 åŠ‡æœ¬è¨Šæ¯", "Q4 è² æ“”æ„Ÿå—", "Q5 æ›å ´ä¼‘æ¯", "Q6 è¯ç¹«ä½œæ¥­"];
            spCharts.radar = new Chart(ctxR, {
                type: 'radar',
                data: { labels: labels, datasets: [{ label: 'å¹³å‡æ»¿æ„åº¦', data: qAvgs, backgroundColor: 'rgba(0, 0, 0, 0.2)', borderColor: '#000', borderWidth: 3, pointBackgroundColor: '#EAB936' }] },
                options: { scales: { r: { min: 1, max: 5, ticks: { stepSize: 1 } } }, maintainAspectRatio: false }
            });

            // Bar
            const ctxW = document.getElementById('sp-chart-workload').getContext('2d');
            if (spCharts.bar) spCharts.bar.destroy();
            spCharts.bar = new Chart(ctxW, {
                type: 'bar',
                data: { labels: ['å¯¦éš›æ¼”å‡ºæ¬¡æ•¸', 'å»ºè­°é©å®œæ¬¡æ•¸'], datasets: [{ label: 'æ¬¡æ•¸', data: [avgActual, avgIdeal], backgroundColor: ['#1C4E8C', '#EAB936'], borderWidth: 2, borderColor: '#000' }] },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }

        function renderSpComments(comments) {
            // Keywords
            const stopWords = ["ç„¡", "æ²’æœ‰", "å»ºè­°", "è¦ºå¾—", "çš„", "æ˜¯", "å¾ˆ", "åŠ", "èˆ‡", "åœ¨", "äº†"];
            let wordCounts = {};
            comments.forEach(text => {
                String(text).replace(/[.,\/#!$%\^&\*;:{}=\-_`~()ã€‚ï¼Œã€ï¼ï¼Ÿ]/g, " ").split(/\s+/).forEach(w => {
                    if (w.length > 1 && !stopWords.includes(w)) wordCounts[w] = (wordCounts[w] || 0) + 1;
                });
            });
            const sorted = Object.entries(wordCounts).sort((a,b)=>b[1]-a[1]).slice(0, 8);
            
            const cloud = document.getElementById('sp-keyword-cloud'); cloud.innerHTML = '';
            sorted.forEach(([w, c]) => { cloud.innerHTML += `<span class="keyword-tag">${w} (${c})</span>`; });

            const list = document.getElementById('sp-comments-list'); list.innerHTML = '';
            comments.slice(0, 30).forEach(c => {
                list.innerHTML += `<div class="p-2 bg-white border-l-4 border-black text-xs text-gray-700 shadow-sm mb-2">${c}</div>`;
            });
        }

        function renderSpTable(data) {
            const tbody = document.getElementById('sp-data-table-body');
            tbody.innerHTML = '';
            data.slice(0, 100).forEach(row => {
                let dStr = (row.date || '').toString();
                if(dStr.length >= 10) dStr = dStr.substring(0, 10);
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200 text-xs hover:bg-gray-50";
                
                const sc = (v) => {
                    let c = "text-center p-3 font-mono text-gray-600";
                    let val = Number(v);
                    if(val <= 2) c += " text-red-600 font-bold bg-red-50";
                    else if(val >= 5) c += " text-[#1C4E8C] font-bold";
                    return `<td class="${c}">${v||'-'}</td>`;
                };

                tr.innerHTML = `
                    <td class="p-3 font-mono text-gray-500">${dStr}</td>
                    <td class="p-3 font-bold">${row.spName || '-'}</td>
                    <td class="p-3 text-center">${row.stationNumber || '-'}</td>
                    ${sc(row.q1)}${sc(row.q2)}${sc(row.q3)}${sc(row.q4)}
                    <td class="p-3 text-center font-bold text-[#1C4E8C]">${row.q4_1||'-'}</td>
                    <td class="p-3 text-center font-bold text-[#EAB936]">${row.q4_2||'-'}</td>
                    ${sc(row.q5)}${sc(row.q6)}
                    <td class="p-3 truncate max-w-[200px]" title="${row.q7_comment || ''}">${row.q7_comment || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportSpCSV() {
             let csv = "æ—¥æœŸ,SPå§“å,ç«™è™Ÿ,Q1,Q2,Q3,Q4,å¯¦éš›æ¬¡æ•¸,å»ºè­°æ¬¡æ•¸,Q5,Q6,Q7å»ºè­°\n";
            rawSpFeedbackData.forEach(row => {
                let d = (row.date || '').toString();
                if(d.length >= 10) d = d.substring(0, 10);
                let comment = (row.q7_comment || '').replace(/"/g, '""');
                csv += `"${d}","${row.spName}","${row.stationNumber}",${row.q1},${row.q2},${row.q3},${row.q4},${row.q4_1},${row.q4_2},${row.q5},${row.q6},"${comment}"\n`;
            });
            const blob = new Blob(["\uFEFF"+csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "sp_feedback.csv";
            link.click();
        }

        // --- VIEW SWITCHING ---
        function switchView(viewName) {
            currentView = viewName;
            
            // Hide all views
            ['dashboard', 'examiner-sp-analysis', 'examiner-analysis', 'student-analysis', 'sp-analysis'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`view-${v}`).classList.remove('block');
                const nav = document.getElementById(`nav-${v}`);
                if(nav) {
                    nav.classList.remove('active', 'shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]', 'transform', '-translate-y-1');
                    nav.classList.add('opacity-70', 'border-transparent');
                }
            });

            // Show active view
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.getElementById(`view-${viewName}`).classList.add('block');
            const activeNav = document.getElementById(`nav-${viewName}`);
            if(activeNav) {
                activeNav.classList.add('active', 'shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]', 'transform', '-translate-y-1');
                activeNav.classList.remove('opacity-70', 'border-transparent');
            }

            // Filter Visibility Logic
            const filters = document.getElementById('filters-panel');
            const grpProf = document.getElementById('filter-group-profession');
            const grpStat = document.getElementById('filter-group-station');
            
            if (filters) {
                filters.classList.remove('hidden');
                grpProf.classList.add('hidden');
                grpStat.classList.add('hidden');

                if (viewName === 'examiner-sp-analysis') {
                    grpProf.classList.remove('hidden');
                    updateDateDropdownForView('examiner-sp-analysis');
                    filterData();
                } 
                else if (viewName === 'examiner-analysis') {
                    grpStat.classList.remove('hidden');
                    updateDateDropdownForView('examiner-analysis');
                    applyFeedbackFilters();
                }
                else if (viewName === 'student-analysis') {
                    updateDateDropdownForView('student-analysis');
                    applyStudentFilters();
                }
                else if (viewName === 'sp-analysis') {
                    grpStat.classList.remove('hidden'); // Show Station Filter
                    updateDateDropdownForView('sp-analysis');
                    applySpFilters();
                }
            }

            if(window.innerWidth < 768) toggleSidebar();
        }

        // --- HELPER FUNCTIONS ---
        function updateStatus(msg, color) {
            const dot = document.getElementById('system-status-dot');
            const text = document.getElementById('system-status-text');
            const colors = { green: 'bg-green-500', yellow: 'bg-yellow-500', red: 'bg-red-500' };
            dot.className = `w-2 h-2 rounded-full mr-2 ${colors[color]}`;
            text.innerText = msg;
        }
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        }
        function closeModal() {
             document.getElementById('modal-overlay').classList.add('hidden');
        }
        function showToast(msg) { /* Simple toast if needed */ }
        function exportCSV() { /* Global export wrapper if needed, handled individually */ }
    </script>
</body>
</html>
