(()=>{"use strict";const t={currentView:"dashboard",globalData:[],globalSpMap:{},rawFeedbackData:[],rawStudentData:[],rawSpFeedbackData:[],radarChartInstance:null,barChartInstance:null,feedbackCharts:{},studentCharts:{},spCharts:{}};function e(e,n){t[e]=n}const n="https://script.google.com/macros/s/AKfycbzAZfDJS21_o7WIrXCpW0w-Hx8i_DtHQVSvIhj1nsIyge752nhDP_7caE1VzZvvEMtP/exec",a="https://script.google.com/macros/s/AKfycbz-SVriuVdvHuqdwBV25N1INoeaSoF2VHrob_gZ7aBpxX_XqlfsEdzmmRgNAf4kRhAy/exec",o="https://script.google.com/macros/s/AKfycbyOmRVnOcm7iwHjuQbww22k9g-MJ9Uzjn9obNli4x6SSpRko7nHottjxkGM-cR2euSfPA/exec",s="https://script.google.com/macros/s/AKfycbxHu6so82suf2dJofxzUtjw8opQSAElYkIK9YHHpzijgHV_thbBRIR3YYMb6_3A9DARVg/exec";function r(t){const e=[...new Set(t.map(t=>t.spName||t.SPName||"未知SP"))],n={},a={};return e.forEach(t=>{if("未知SP"===t)return void(n[t]=t);let e=t.length<=2?t.charAt(0)+"○":t.charAt(0)+"○"+t.slice(-1);a[e]?(a[e]++,e=`${e} (${a[e]})`):a[e]=1,n[t]=e}),n}async function c(){try{const t=await fetch(n),a=await t.json();if(a.error)throw new Error(a.error);return e("globalData",a),a}catch(t){throw console.error("SP Fetch Error:",t),t}}async function l(){try{const t=await fetch(a),e=await t.json();if(e.error)throw new Error(e.error);return e}catch(t){throw console.error("Feedback Error",t),t}}async function d(){try{const t=await fetch(o),e=await t.json();if(e.error)throw new Error(e.error);return e}catch(t){throw console.error("Student Fetch Error:",t),t}}async function i(){try{const t=await fetch(`${s}?t=${(new Date).getTime()}`),e=await t.json();if(e.error)throw new Error(e.error);if(!Array.isArray(e))throw new Error("Format Error");return e}catch(t){throw console.error("SP Feedback Fetch Error:",t),t}}function m(t,e){const n=document.getElementById("system-status-dot"),a=document.getElementById("system-status-text");n&&(n.className=`w-2 h-2 rounded-full mr-2 ${{green:"bg-green-500",yellow:"bg-yellow-500",red:"bg-red-500"}[e]}`),a&&(a.innerText=t)}function u(){const t=document.getElementById("sidebar"),e=document.getElementById("sidebar-overlay");t&&t.classList.toggle("-translate-x-full"),e&&e.classList.toggle("hidden")}function g(t,e){const n=document.getElementById("global-date-filter");if(!n)return;n.innerHTML='<option value="all">全部場次 All Sessions</option>';[...new Set(e.map(t=>{let e=t.examDate||t.date;return e?("string"==typeof e&&e.length>=10&&(e=e.substring(0,10)),e):""}))].filter(t=>t).sort().reverse().forEach(t=>{const e=document.createElement("option");e.value=t,e.textContent=t,n.appendChild(e)})}function p(t,n){e("currentView",t);["dashboard","examiner-sp-analysis","examiner-analysis","student-analysis","sp-analysis"].forEach(t=>{const e=document.getElementById(`view-${t}`);e&&(e.classList.add("hidden"),e.classList.remove("block"));const n=document.getElementById(`nav-${t}`);n&&(n.classList.remove("active","shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]","transform","-translate-y-1"),n.classList.add("opacity-70","border-transparent"))});const a=document.getElementById(`view-${t}`);a&&(a.classList.remove("hidden"),a.classList.add("block"));const o=document.getElementById(`nav-${t}`);o&&(o.classList.add("active","shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]","transform","-translate-y-1"),o.classList.remove("opacity-70","border-transparent"));const s=document.getElementById("filters-panel"),r=document.getElementById("filter-group-profession"),c=document.getElementById("filter-group-station");s&&(s.classList.remove("hidden"),r&&r.classList.add("hidden"),c&&c.classList.add("hidden"),"examiner-sp-analysis"===t?r&&r.classList.remove("hidden"):"examiner-analysis"!==t&&"sp-analysis"!==t||c&&c.classList.remove("hidden")),window.innerWidth<768&&u(),n&&"function"==typeof n&&n(t)}function b(t,e){const n=document.getElementById(t);n&&(n.innerText=e)}function f(){const e=t.currentView;"examiner-sp-analysis"===e?y():"examiner-analysis"===e?h():"student-analysis"===e?x():"sp-analysis"===e&&E()}function y(){const n=document.getElementById("global-profession-filter")?.value||"all",a=document.getElementById("global-year-filter")?.value||"all",o=document.getElementById("global-date-filter")?.value||"all",s=(c=n,l=a,d=o,t.globalData.filter(t=>{if("all"!==c&&!t.profession.includes(c))return!1;let e=t.examDate&&t.examDate.length>10?t.examDate.substring(0,10):t.examDate;return!!("all"===l||e&&e.includes(l))&&("all"===d||e===d)}));var c,l,d;const i=function(n){0===Object.keys(t.globalSpMap).length&&e("globalSpMap",r(t.globalData));const a=n.length;let o=0,s=0,c=0,l=0,d={q1:0,q2:0,q3:0,q4:0,q5:0,q6:0,q7:0,q8:0},i={},m={},u=[];return n.forEach(e=>{const n=e.scores||{},a=n.q1||0,r=n.q2||0,g=n.q3||0,p=n.q4||0,b=n.q5||0,f=n.q6||0,y=n.q7||0,h=n.q8||0;let x=(a+(r>0?6-r:0)+(g>0?6-g:0)+p+b+f+y+h)/8;o+=x,s+=a,c+=h,l++,d.q1+=a,d.q2+=6-r,d.q3+=6-g,d.q4+=p,d.q5+=b,d.q6+=f,d.q7+=y,d.q8+=h;const E=e.profession||"其他";i[E]||(i[E]={sum:0,count:0}),i[E].sum+=x,i[E].count+=1;let $=t.globalSpMap[e.spName||e.SPName||"未知SP"];m[$]||(m[$]={sum:0,count:0}),m[$].sum+=x,m[$].count+=1,e.generalComment&&u.push(e.generalComment)}),{total:a,avgScore:l?(o/l).toFixed(1):"-",q1Avg:l?(s/l).toFixed(1):"-",q8Avg:l?(c/l).toFixed(1):"-",qSums:d,profStats:i,spPerformance:m,allComments:u}}(s);b("stat-total-records",i.total),b("stat-avg-score",i.avgScore),b("stat-q1-score",i.q1Avg),b("stat-q8-score",i.q8Avg),i.total>0&&(function(e,n){const a=document.getElementById("chart-radar")?.getContext("2d");if(!a)return;const o=[e.q1/n,e.q2/n,e.q3/n,e.q4/n,e.q5/n,e.q6/n,e.q7/n,e.q8/n].map(t=>t.toFixed(2));t.radarChartInstance&&t.radarChartInstance.destroy(),t.radarChartInstance=new Chart(a,{type:"radar",data:{labels:["Q1 角色","Q2 避免操弄","Q3 避免質疑","Q4 身體","Q5 表情","Q6 肢體","Q7 回答","Q8 態度"],datasets:[{label:"平均得分",data:o,backgroundColor:"rgba(28, 78, 140, 0.2)",borderColor:"#1C4E8C",pointBackgroundColor:"#EAB936",borderWidth:3}]},options:{scales:{r:{min:1,max:5,ticks:{stepSize:1}}},maintainAspectRatio:!1}})}(i.qSums,i.total),function(e){const n=document.getElementById("chart-profession")?.getContext("2d");if(!n)return;const a=Object.keys(e),o=a.map(t=>(e[t].sum/e[t].count).toFixed(2));t.barChartInstance&&t.barChartInstance.destroy(),t.barChartInstance=new Chart(n,{type:"bar",data:{labels:a,datasets:[{label:"平均評分",data:o,backgroundColor:"#EAB936",borderColor:"#000",borderWidth:2}]},options:{scales:{y:{min:0,max:5}},maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}(i.profStats),function(t,e,n,a){const o=["無","沒有","sp","的","很","也","了","有","表現","學生","考生","good","ok","尚可"];let s={};n.forEach(t=>{String(t).replace(/[.,\/#!$%\^&\*;:{}=\-_`~()。，、！]/g," ").split(/\s+/).forEach(t=>{t.length>1&&!o.includes(t.toLowerCase())&&(s[t]=(s[t]||0)+1)})});const r=Object.entries(s).sort((t,e)=>e[1]-t[1]).slice(0,10),c=document.getElementById("keyword-cloud");c&&(c.innerHTML="",r.forEach(([t,e])=>{const n=document.createElement("span"),a=["小聲","矛盾","不自然","過度","差"].some(e=>t.includes(e));n.className="keyword-tag "+(a?"keyword-neg":"keyword-pos"),n.textContent=`${t} (${e})`,c.appendChild(n)}));const l=document.getElementById("recent-comments-list");l&&(l.innerHTML="",n.slice(-6).reverse().forEach(t=>{const e=document.createElement("div");e.className="text-xs border-b border-gray-100 pb-1 mb-1 text-gray-600",e.innerText=`"${t}"`,l.appendChild(e)}));const d=Object.entries(a).map(([t,e])=>({name:t,avg:e.sum/e.count,count:e.count})).sort((t,e)=>t.avg-e.avg).slice(0,3),i=document.getElementById("sp-watchlist");i&&(i.innerHTML="",d.length>0?d.forEach(t=>{const e=document.createElement("li");e.className="flex justify-between items-center text-xs";const n=t.avg<3.5?"text-red-400 font-bold":"text-gray-300";e.innerHTML=`<span>${t.name}</span> <span class="${n}">${t.avg.toFixed(1)} <span class="text-[10px] text-gray-500">(${t.count}筆)</span></span>`,i.appendChild(e)}):i.innerHTML='<li class="text-gray-500">無足夠數據</li>');const m={"Q1 角色":t.q1/e,"Q2 避免操弄":t.q2/e,"Q3 避免質疑":t.q3/e,"Q4 身體":t.q4/e,"Q5 表情":t.q5/e,"Q6 肢體":t.q6/e,"Q7 回答":t.q7/e,"Q8 態度":t.q8/e};let u=6,g="";for(const[t,e]of Object.entries(m))e<u&&(u=e,g=t);const p=document.getElementById("action-priority"),b=document.getElementById("action-suggestion");p&&(p.innerText=g+` (Score: ${u.toFixed(1)})`),b&&(b.innerText=`針對「${g}」面向，建議安排 SP 進行工作坊回訓或個別指導。`)}(i.qSums,i.total,i.allComments,i.spPerformance)),function(e){const n=document.getElementById("table-comments-body");n&&(n.innerHTML="",e.slice(0,50).forEach(e=>{let a=t.globalSpMap[e.spName||e.SPName||"未知SP"],o=document.createElement("tr");o.className="border-b border-gray-200 text-xs hover:bg-gray-50",o.innerHTML=`\n            <td class="p-3">${e.examDate}</td>\n            <td class="p-3 font-bold">${a}</td>\n            <td class="p-3">${e.examinerName}</td>\n            <td class="p-3">${e.stationNumber}</td>\n            <td class="p-3">${e.profession}</td>\n            <td class="p-3">${e.scores.q1}</td>\n            <td class="p-3 text-red-500">${e.scores.q2}</td>\n            <td class="p-3 text-red-500">${e.scores.q3}</td>\n            <td class="p-3">${e.scores.q4}</td>\n            <td class="p-3">${e.scores.q5}</td>\n            <td class="p-3">${e.scores.q6}</td>\n            <td class="p-3">${e.scores.q7}</td>\n            <td class="p-3">${e.scores.q8}</td>\n            <td class="p-3 truncate max-w-[200px]">${e.generalComment||"-"}</td>\n        `,n.appendChild(o)}))}(s)}function h(){const e=document.getElementById("global-year-filter")?.value||"all",n=document.getElementById("global-date-filter")?.value||"all",a=document.getElementById("global-station-filter")?.value||"all",o=(s=t.rawFeedbackData,r=e,c=n,l=a,s.filter(t=>{let e=(t.date||t.examDate||"").substring(0,10);return!("all"!==r&&!e.includes(r)||"all"!==c&&e!==c||"all"!==l&&String(t.stationNumber)!==l)}));var s,r,c,l;const d=function(t){const e=t.length;let n=Array(8).fill(0),a={},o=[];t.forEach(t=>{const e=[t.q1,t.q2,t.q3,t.q4,t.q5,t.q6,t.q7,t.q8].map(t=>Number(t)||0);e.forEach((t,e)=>n[e]+=t);const s=t.stationNumber||"Unk";a[s]||(a[s]={sum:0,count:0});const r=e.reduce((t,e)=>t+e,0)/8;a[s].sum+=r,a[s].count++,t.q9&&o.push(t.q9),t.q10&&o.push(t.q10)});const s=n.map(t=>e>0?(t/e).toFixed(2):0),r=e>0?(n.reduce((t,e)=>t+e,0)/(8*e)).toFixed(2):0;let c=6,l=-1;s.forEach((t,e)=>{Number(t)>0&&Number(t)<c&&(c=Number(t),l=e)});const d=["Q1 測驗內容","Q2 評核項目","Q3 評分說明","Q4 試題指引","Q5 測驗時間","Q6 動線規劃","Q7 廣播鈴聲","Q8 試務流程"];return{total:e,totalAvg:r,lowestDim:l>=0?d[l]:"無",lowestScore:l>=0?c.toFixed(2):"--",qAvgs:s,labels:d,stationStats:a,comments:o,minIdx:l}}(o);b("fb-stat-count",d.total),b("fb-stat-avg",d.totalAvg),b("fb-stat-low",d.lowestDim),b("fb-stat-low-score",d.lowestScore),d.total>0&&(function(e,n,a){const o=document.getElementById("fb-chart-questions")?.getContext("2d");o&&(t.feedbackCharts.q&&t.feedbackCharts.q.destroy(),t.feedbackCharts.q=new Chart(o,{type:"bar",data:{labels:e,datasets:[{label:"滿意度",data:n,backgroundColor:"#1C4E8C"}]},options:{indexAxis:"y",maintainAspectRatio:!1}}));const s=Object.keys(a).sort((t,e)=>Number(t)-Number(e)),r=s.map(t=>(a[t].sum/a[t].count).toFixed(2)),c=document.getElementById("fb-chart-stations")?.getContext("2d");c&&(t.feedbackCharts.s&&t.feedbackCharts.s.destroy(),t.feedbackCharts.s=new Chart(c,{type:"bar",data:{labels:s.map(t=>`第${t}站`),datasets:[{label:"滿意度",data:r,backgroundColor:"#EAB936"}]},options:{maintainAspectRatio:!1}}))}(d.labels,d.qAvgs,d.stationStats),function(t,e,n){const a=["無","沒有","建議","考題","的","覺得","尚可","良好","ok","good","是","在"];let o={};t.forEach(t=>{String(t).replace(/[.,\/#!$%\^&\*;:{}=\-_`~()。，、！]/g," ").split(/\s+/).forEach(t=>{t.length>1&&!a.includes(t.toLowerCase())&&(o[t]=(o[t]||0)+1)})});const s=Object.entries(o).sort((t,e)=>e[1]-t[1]).slice(0,10),r=document.getElementById("fb-keyword-cloud");r&&(r.innerHTML="",0===s.length&&(r.innerHTML='<span class="text-gray-400 text-xs">無足夠資料分析</span>'),s.forEach(([t,e])=>{const n=["不足","太短","吵","動線","難","不佳"].some(e=>t.includes(e));r.innerHTML+=`<span class="keyword-tag ${n?"keyword-neg":"keyword-pos"}">${t} (${e})</span>`}));const c=document.getElementById("fb-comments-list");c&&(c.innerHTML="",t.filter(t=>t&&""!==String(t).trim()).slice(-6).reverse().forEach(t=>{c.innerHTML+=`<div class="text-xs border-b border-gray-200 pb-2 mb-2 text-gray-700">"${t}"</div>`}));const l=document.getElementById("fb-action-priority"),d=document.getElementById("fb-action-suggestion");l&&(l.innerText=n||"無顯著問題");const i={0:"建議重新審視考題鑑別度與難易度分佈，或召開共識會議調整評分標準。",1:"評分項目可能過於繁瑣或模糊，建議簡化評核表或具體化行為指標。",2:"評分說明可能不夠明確，建議在考官共識營中加強說明或提供範例影片。",3:"試題指引資訊可能不足，建議增加考生端或考官端的背景資訊說明。",4:"測驗時間安排可能過於緊湊，建議檢視考題份量或考慮調整考試時間。",5:"動線規劃可能有改進空間，建議檢視考場標示或人員引導配置。",6:"廣播或鈴聲系統可能有干擾，建議檢查硬體設備或調整音量設定。",7:"試務流程有優化空間，建議加強試務人員培訓或標準化作業程序。"};d&&(d.innerText=i[e]||"目前各面向表現良好，請持續保持監測。")}(d.comments,d.minIdx,d.lowestDim)),function(t){const e=document.getElementById("fb-data-table-body");if(!e)return;e.innerHTML="";const n=t=>{const e=Number(t);let n="text-center p-3 font-mono";return n+=e<=2?" text-red-600 font-bold bg-red-50":e>=5?" text-[#1C4E8C] font-bold":" text-gray-600",`<td class="${n}">${e||"-"}</td>`};t.slice(0,100).forEach(t=>{const a=document.createElement("tr");a.className="border-b border-gray-200 hover:bg-gray-50 text-xs transition-colors";const o=(t.date||t.examDate||"").substring(0,10);a.innerHTML=`\n            <td class="p-3 font-mono text-gray-500">${o}</td>\n            <td class="p-3 font-bold">${t.examinerName||"-"}</td>\n            <td class="p-3 text-center"><span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">${t.stationNumber}</span></td>\n            ${n(t.q1)}${n(t.q2)}${n(t.q3)}${n(t.q4)}\n            ${n(t.q5)}${n(t.q6)}${n(t.q7)}${n(t.q8)}\n            <td class="p-3 text-gray-600 truncate max-w-[150px]" title="${t.q9}">${t.q9||"-"}</td>\n            <td class="p-3 text-gray-600 truncate max-w-[150px]" title="${t.q10}">${t.q10||"-"}</td>\n        `,e.appendChild(a)})}(o)}function x(){const e=document.getElementById("global-year-filter")?.value||"all",n=document.getElementById("global-date-filter")?.value||"all",a=(o=t.rawStudentData,s=e,r=n,o.filter(t=>{let e=t[2];return"string"==typeof e&&e.length>10&&(e=e.substring(0,10)),!("all"!==s&&!e.includes(s)||"all"!==r&&e!==r)}));var o,s,r;const c=function(t){const e=t.length;let n=Array(9).fill(0),a={},o=0,s=[];t.forEach(t=>{for(let e=0;e<9;e++){let a=Number(t[e+3])||0;n[e]+=a,5===e&&(o+=a)}let e=t[12]||"未填答";a[e]=(a[e]||0)+1,t[13]&&s.push({text:t[13],type:"考題"}),t[14]&&s.push({text:t[14],type:"整體"})});const r=n.map(t=>e>0?(t/e).toFixed(2):0),c=e>0?(n.reduce((t,e)=>t+e,0)/(9*e)).toFixed(2):0,l=e>0?(o/e).toFixed(2):0;let d=0,i="無";for(let[t,e]of Object.entries(a))e>d&&(d=e,i=t);return{total:e,totalAvg:c,spAvg:l,modeDiff:i,qAvgs:r,difficultyCounts:a,comments:s}}(a);b("stu-stat-count",c.total),b("stu-stat-avg",c.totalAvg),b("stu-stat-sp-score",c.spAvg),b("stu-stat-difficulty-mode",c.modeDiff),c.total>0&&(function(e,n){const a=document.getElementById("stu-chart-radar")?.getContext("2d");if(a){t.studentCharts.radar&&t.studentCharts.radar.destroy();const n=["Q1 內容","Q2 動線","Q3 指引","Q4 SP時間","Q5 SP難度","Q6 SP演出","Q7 技能時間","Q8 技能難度","Q9 流程"];t.studentCharts.radar=new Chart(a,{type:"radar",data:{labels:n,datasets:[{label:"平均滿意度",data:e,backgroundColor:"rgba(28, 78, 140, 0.2)",borderColor:"#1C4E8C",borderWidth:3}]},options:{scales:{r:{min:1,max:5}},maintainAspectRatio:!1}})}const o=document.getElementById("stu-chart-difficulty")?.getContext("2d");if(o){t.studentCharts.pie&&t.studentCharts.pie.destroy();const e=["非常簡單","簡單","剛好","困難","非常困難"],a=["#1C4E8C","#60A5FA","#EAB936","#F87171","#D03328"],s=e.map(t=>n[t]||0);t.studentCharts.pie=new Chart(o,{type:"doughnut",data:{labels:e,datasets:[{data:s,backgroundColor:a,borderColor:"#1A1A1A",borderWidth:2}]},options:{maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})}}(c.qAvgs,c.difficultyCounts),function(t,e,n){const a=["無","沒有","建議","覺得","的","是","很","有","也","了"];let o={};t.forEach(t=>{String(t.text).replace(/[.,\/#!$%\^&\*;:{}=\-_`~()。，、！？]/g," ").split(/\s+/).forEach(t=>{t.length>1&&!a.includes(t)&&(o[t]=(o[t]||0)+1)})});const s=Object.entries(o).sort((t,e)=>e[1]-t[1]).slice(0,10),r=document.getElementById("stu-keyword-cloud");r&&(r.innerHTML="",s.forEach(([t,e])=>{r.innerHTML+=`<span class="keyword-tag">${t} (${e})</span>`}));const c=document.getElementById("stu-comments-exam"),l=document.getElementById("stu-comments-general");c&&(c.innerHTML=""),l&&(l.innerHTML="");const d=t.filter(t=>"考題"===t.type).reverse().slice(0,20),i=t.filter(t=>"整體"===t.type).reverse().slice(0,20);c&&(0===d.length?c.innerHTML='<div class="text-xs text-gray-400 text-center py-4">無考題建議</div>':d.forEach(t=>{c.innerHTML+=`<div class="p-2 bg-white border-l-4 border-[#1C4E8C] text-xs text-gray-700 shadow-sm mb-2">${t.text}</div>`})),l&&(0===i.length?l.innerHTML='<div class="text-xs text-gray-400 text-center py-4">無整體建議</div>':i.forEach(t=>{l.innerHTML+=`<div class="p-2 bg-white border-l-4 border-[#D03328] text-xs text-gray-700 shadow-sm mb-2">${t.text}</div>`}));let m=6,u=-1;e.forEach((t,e)=>{Number(t)>0&&Number(t)<m&&(m=Number(t),u=e)});const g=document.getElementById("stu-insight-lowest-dim"),p=document.getElementById("stu-insight-lowest-score"),b=document.getElementById("stu-insight-action");g&&(g.innerText=u>=0?["Q1 內容","Q2 動線","Q3 指引","Q4 SP時間","Q5 SP難度","Q6 SP演出","Q7 技能時間","Q8 技能難度","Q9 流程"][u]:"無"),p&&(p.innerText=u>=0?`Score: ${m.toFixed(2)}`:"--"),b&&(b.innerText=u>=0?["檢視考題與平日教學連結度，加強考前複習。","檢查考場標示是否脫落，優化移動動線。","增加試題指引範例，確保考生理解題意。","評估SP站考題份量，或考慮延長時間。","調整SP劇本難度，避免過於刁鑽。","加強SP演出訓練，確保表演一致性。","評估技能站操作繁瑣度，簡化流程。","檢視技能評分標準，避免過於嚴苛。","加強試務人員訓練，維持考場秩序。"][u]:"各項指標表現良好。");let f="難度適中";n.includes("困難")?f="多數考生感到困難，建議檢視評分標準或教學內容。":n.includes("簡單")&&(f="多數考生認為簡單，可考慮增加考題鑑別度。");const y=document.getElementById("stu-insight-difficulty");y&&(y.innerText=f)}(c.comments,c.qAvgs,c.modeDiff)),function(t){const e=document.getElementById("stu-data-table-body");e&&(e.innerHTML="",t.slice(0,50).forEach(t=>{let n=t[2];"string"==typeof n&&n.length>10&&(n=n.substring(0,10));const a=document.createElement("tr");a.className="border-b border-gray-200 text-xs hover:bg-gray-50";const o=t=>{let e="text-center p-3 font-mono text-gray-600";return t<=2?e+=" text-red-600 font-bold bg-red-50":t>=5&&(e+=" text-[#1C4E8C] font-bold"),`<td class="${e}">${t||"-"}</td>`};a.innerHTML=`\n            <td class="p-3 font-mono text-gray-400">${t[0]?new Date(t[0]).toLocaleTimeString():"-"}</td>\n            <td class="p-3 font-bold text-[#1C4E8C]">${t[1]||"-"}</td>\n            <td class="p-3 font-mono">${n||"-"}</td>\n            ${o(t[3])}${o(t[4])}${o(t[5])}${o(t[6])}${o(t[7])}\n            ${o(t[8])}${o(t[9])}${o(t[10])}${o(t[11])}\n            <td class="p-3 text-center font-bold">${t[12]||"-"}</td>\n            <td class="p-3 truncate max-w-[150px]">${t[13]||"-"}</td>\n            <td class="p-3 truncate max-w-[150px]">${t[14]||"-"}</td>\n        `,e.appendChild(a)}))}(a)}function E(){const e=document.getElementById("global-year-filter")?.value||"all",n=document.getElementById("global-date-filter")?.value||"all",a=document.getElementById("global-station-filter")?.value||"all",o=(s=t.rawSpFeedbackData,r=e,c=n,l=a,s.filter(t=>{let e=(t.date||t.timestamp||"").toString();return e.length>=10&&(e=e.substring(0,10)),!("all"!==r&&!e.includes(r)||"all"!==c&&e!==c||"all"!==l&&String(t.stationNumber)!==l)}));var s,r,c,l;const d=function(t){const e=t.length;let n=Array(6).fill(0),a=0,o=0,s=[];t.forEach(t=>{[t.q1,t.q2,t.q3,t.q4,t.q5,t.q6].map(t=>Number(t)||0).forEach((t,e)=>n[e]+=t),a+=Number(t.q4_1)||0,o+=Number(t.q4_2)||0,t.q7_comment&&""!==String(t.q7_comment).trim()&&s.push(t.q7_comment)});const r=n.map(t=>e>0?(t/e).toFixed(2):0),c=e>0?(n.reduce((t,e)=>t+e,0)/(6*e)).toFixed(2):0,l=e>0?(a/e).toFixed(1):0,d=e>0?(o/e).toFixed(1):0,i=o>0?Math.round(a/o*100):0;return{total:e,totalAvg:c,avgActual:l,avgIdeal:d,workloadIndex:i,qAvgs:r,comments:s}}(o);b("sp-stat-count",d.total),b("sp-stat-avg",d.totalAvg),b("sp-stat-avg-plays",d.avgActual);const i=document.getElementById("sp-stat-workload");i&&(i.innerText=d.workloadIndex+"%",i.className=d.workloadIndex>110?"text-4xl font-black text-red-500":"text-4xl font-black text-white"),d.total>0&&(function(e,n,a){const o=document.getElementById("sp-chart-radar")?.getContext("2d");if(o){t.spCharts.radar&&t.spCharts.radar.destroy();const n=["Q1 劇本演出","Q2 考前演練","Q3 劇本訊息","Q4 負擔感受","Q5 換場休息","Q6 聯繫作業"];t.spCharts.radar=new Chart(o,{type:"radar",data:{labels:n,datasets:[{label:"平均滿意度",data:e,backgroundColor:"rgba(0, 0, 0, 0.2)",borderColor:"#000",borderWidth:3,pointBackgroundColor:"#EAB936"}]},options:{scales:{r:{min:1,max:5,ticks:{stepSize:1}}},maintainAspectRatio:!1}})}const s=document.getElementById("sp-chart-workload")?.getContext("2d");s&&(t.spCharts.bar&&t.spCharts.bar.destroy(),t.spCharts.bar=new Chart(s,{type:"bar",data:{labels:["實際演出次數","建議適宜次數"],datasets:[{label:"次數",data:[n,a],backgroundColor:["#1C4E8C","#EAB936"],borderWidth:2,borderColor:"#000"}]},options:{maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}},plugins:{legend:{display:!1}}}}))}(d.qAvgs,d.avgActual,d.avgIdeal),function(t){const e=["無","沒有","建議","覺得","的","是","很","及","與","在","了"];let n={};t.forEach(t=>{String(t).replace(/[.,\/#!$%\^&\*;:{}=\-_`~()。，、！？]/g," ").split(/\s+/).forEach(t=>{t.length>1&&!e.includes(t)&&(n[t]=(n[t]||0)+1)})});const a=Object.entries(n).sort((t,e)=>e[1]-t[1]).slice(0,8),o=document.getElementById("sp-keyword-cloud");o&&(o.innerHTML="",a.forEach(([t,e])=>{o.innerHTML+=`<span class="keyword-tag">${t} (${e})</span>`}));const s=document.getElementById("sp-comments-list");s&&(s.innerHTML="",t.slice(0,30).forEach(t=>{s.innerHTML+=`<div class="p-2 bg-white border-l-4 border-black text-xs text-gray-700 shadow-sm mb-2">${t}</div>`}))}(d.comments)),function(t){const e=document.getElementById("sp-data-table-body");e&&(e.innerHTML="",t.slice(0,100).forEach(t=>{let n=(t.date||"").toString();n.length>=10&&(n=n.substring(0,10));const a=document.createElement("tr");a.className="border-b border-gray-200 text-xs hover:bg-gray-50";const o=t=>{let e="text-center p-3 font-mono text-gray-600",n=Number(t);return n<=2?e+=" text-red-600 font-bold bg-red-50":n>=5&&(e+=" text-[#1C4E8C] font-bold"),`<td class="${e}">${t||"-"}</td>`};a.innerHTML=`\n            <td class="p-3 font-mono text-gray-500">${n}</td>\n            <td class="p-3 font-bold">${t.spName||"-"}</td>\n            <td class="p-3 text-center">${t.stationNumber||"-"}</td>\n            ${o(t.q1)}${o(t.q2)}${o(t.q3)}${o(t.q4)}\n            <td class="p-3 text-center font-bold text-[#1C4E8C]">${t.q4_1||"-"}</td>\n            <td class="p-3 text-center font-bold text-[#EAB936]">${t.q4_2||"-"}</td>\n            ${o(t.q5)}${o(t.q6)}\n            <td class="p-3 truncate max-w-[200px]" title="${t.q7_comment||""}">${t.q7_comment||"-"}</td>\n        `,e.appendChild(a)}))}(o)}function $(e){let n=[];"examiner-sp-analysis"===e?(n=t.globalData,g(0,n),y()):"examiner-analysis"===e?(n=t.rawFeedbackData,g(0,n),h()):"student-analysis"===e?(n=t.rawStudentData.map(t=>({date:t[2]})),g(0,n),x()):"sp-analysis"===e&&(n=t.rawSpFeedbackData.map(t=>({date:t.date||t.timestamp})),g(0,n),E())}document.addEventListener("DOMContentLoaded",()=>{"undefined"!=typeof lucide&&lucide.createIcons&&lucide.createIcons(),async function(){try{const[n,a,o,s]=await Promise.allSettled([c(),l(),d(),i()]);"fulfilled"===n.status&&(e("globalData",n.value),e("globalSpMap",r(n.value))),"fulfilled"===a.status&&e("rawFeedbackData",a.value),"fulfilled"===o.status&&e("rawStudentData",o.value),"fulfilled"===s.status&&e("rawSpFeedbackData",s.value),$(t.currentView),m("System Online","green")}catch(t){console.error("Fetch Error:",t),m("API Error","red")}}(),function(){const e=document.getElementById("global-profession-filter"),n=document.getElementById("global-year-filter"),a=document.getElementById("global-date-filter"),o=document.getElementById("global-station-filter");e&&e.addEventListener("change",f);n&&n.addEventListener("change",f);a&&a.addEventListener("change",f);o&&o.addEventListener("change",f);document.querySelectorAll('[id^="nav-"]').forEach(t=>{t.addEventListener("click",e=>{p(t.id.replace("nav-",""),$)})});const s=document.getElementById("sidebar-toggle");s&&s.addEventListener("click",u);!function(){const e={"export-feedback-csv":()=>function(t){let e="日期,考官,站號,Q1,Q2,Q3,Q4,Q5,Q6,Q7,Q8,考題建議,整體建議\n";t.forEach(t=>{const n=(t.date||t.examDate||"").substring(0,10),a=(t.q9||"").replace(/"/g,'""'),o=(t.q10||"").replace(/"/g,'""');e+=`"${n}","${t.examinerName}","${t.stationNumber}",${t.q1},${t.q2},${t.q3},${t.q4},${t.q5},${t.q6},${t.q7},${t.q8},"${a}","${o}"\n`});const n=new Blob(["\ufeff"+e],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(n),a.download="examiner_feedback.csv",a.click()}(t.rawFeedbackData),"export-student-csv":()=>function(t){let e="時間,姓名,日期,Q1,Q2,Q3,Q4,Q5,Q6,Q7,Q8,Q9,難度,考題建議,整體建議\n";t.forEach(t=>{const n=t[0]?new Date(t[0]).toLocaleTimeString():"",a=(t[13]||"").replace(/"/g,'""'),o=(t[14]||"").replace(/"/g,'""');e+=`"${n}","${t[1]}","${t[2]}",${t[3]},${t[4]},${t[5]},${t[6]},${t[7]},${t[8]},${t[9]},${t[10]},${t[11]},"${t[12]}","${a}","${o}"\n`});const n=new Blob(["\ufeff"+e],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(n),a.download="student_feedback.csv",a.click()}(t.rawStudentData),"export-sp-csv":()=>function(t){let e="日期,SP姓名,站號,Q1,Q2,Q3,Q4,實際次數,建議次數,Q5,Q6,Q7建議\n";t.forEach(t=>{let n=(t.date||"").toString();n.length>=10&&(n=n.substring(0,10));let a=(t.q7_comment||"").replace(/"/g,'""');e+=`"${n}","${t.spName}","${t.stationNumber}",${t.q1},${t.q2},${t.q3},${t.q4},${t.q4_1},${t.q4_2},${t.q5},${t.q6},"${a}"\n`});const n=new Blob(["\ufeff"+e],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(n),a.download="sp_feedback.csv",a.click()}(t.rawSpFeedbackData)};Object.entries(e).forEach(([t,e])=>{const n=document.getElementById(t);n&&n.addEventListener("click",e)})}()}()}),window.switchView=t=>p(t,$),window.toggleSidebar=u,window.closeModal=function(){const t=document.getElementById("modal-overlay");t&&t.classList.add("hidden")},window.handleGlobalFilterChange=f})();