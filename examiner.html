<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奇美醫院 OSCE 考官評分儀表板</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (Google Fonts) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide scrollbar for overflow-y-auto but allow scrolling */
        .overflow-y-auto::-webkit-scrollbar {
            width: 0.5em;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">
    <div id="root"></div>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN for JSX transformation in browser (for development, production build would pre-compile) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // Destructure React hooks from the global React object
        const { useState, useEffect, useCallback } = React;

        // 主應用程式組件
        const App = () => {
            // 模擬數據，根據您的評分模板和需求調整
            const initialDashboardData = {
                examinerId: "E02", // 模擬初始考官ID
                station: {
                    stationId: 5,
                    title: "胸腔引流術",
                    sessionStart: "2025-06-19T09:30:00+08:00",
                    sessionEnd: "2025-06-19T11:00:00+08:00",
                    totalCandidates: 2, // Modified: Total candidates is now 2
                },
                rubric: [
                    // 根據圖片模板，定義每個評分項的描述，並新增 'description' 字段用於 hover 提示
                    { item: "向病人自我介紹並說明處置目的", max: 2, description: { "1": "能簡單說明目的但缺乏互動", "2": "完整說明處置目的並良好互動" } },
                    { item: "正確洗手並戴上無菌手套", max: 2, description: { "1": "洗手步驟不完整或手套戴法有瑕疵", "2": "洗手與無菌手套穿戴完全正確" } },
                    { item: "綁止血帶於正確位置", max: 2, description: { "1": "止血帶位置略有偏差", "2": "止血帶綁於正確且舒適的位置" } },
                    { item: "使用 75% 酒精棉片由內向外消毒穿刺部位", max: 2, description: { "1": "消毒範圍不足或方向錯誤", "2": "完整消毒穿刺部位，由內向外" } },
                    { item: "拿針時檢查針具完好與排氣", max: 2, description: { "1": "檢查不夠細緻或排氣不完全", "2": "完整檢查針具並徹底排氣" } },
                    { item: "下針角度正確並穩定進針", max: 2, description: { "1": "角度略有偏移或進針不穩", "2": "下針角度精準且進針穩定流暢" } },
                    { item: "成功見回血並導入導管", max: 2, description: { "1": "回血慢或導管導入不順", "2": "迅速見回血並順利導入導管" } },
                    { item: "鬆開止血帶", max: 2, description: { "1": "鬆開時機稍晚或動作生硬", "2": "在適當時機迅速鬆開止血帶" } },
                    { item: "以紗布壓住穿刺處，拔除針頭", max: 2, description: { "1": "按壓位置不準或拔針不穩", "2": "精準按壓穿刺處並平穩拔除針頭" } },
                    { item: "將導管與延長管連接並固定於適當位置", max: 2, description: { "1": "連接不夠牢固或固定位置不佳", "2": "導管與延長管連接牢固並固定於適當位置" } },
                    { item: "以 3M 膠帶固定並標示日期", max: 2, description: { "1": "膠帶固定不牢或日期標示不明", "2": "膠帶固定牢固且明確標示日期" } },
                    { item: "正確脫手套並將廢棄物分類", max: 2, description: { "1": "脫手套方式不正確或分類有誤", "2": "正確脫除手套並妥善分類廢棄物" } },
                    { item: "操作結束後再次正確洗手", max: 2, description: { "1": "洗手步驟不完整", "2": "操作結束後再次正確洗手" } }
                ],
                currentCandidate: null, // 初始設為空，等待選擇
                reportUrls: {
                    batchPdf: "https://example.com/Station5_E02_20250619.pdf",
                    csv: "https://example.com/Station5_E02_20250619.csv"
                }
            };

            // 模擬考生資料 - 減少為2位考生
            const mockCandidates = [
                { id: "A01", name: "林小明", ticket: "A01", scored: false, savedScores: null, savedComment: "", savedOverallScore: null, savedItemNotes: null, savedExaminerFeedback: "", savedStandardizedPatientFeedback: "", totalScore: 0 },
                { id: "A02", name: "陳大華", ticket: "A02", scored: false, savedScores: null, savedComment: "", savedOverallScore: null, savedItemNotes: null, savedExaminerFeedback: "", savedStandardizedPatientFeedback: "", totalScore: 0 },
            ];

            // 模擬評核考官資料
            const mockExaminers = [
                { id: "E01", name: "李醫師" },
                { id: "E02", name: "王主任" },
                { id: "E03", name: "趙教授" },
                { id: "E04", name: "陳老師" },
            ];

            // 模擬教案指引內容
            const teachingGuideContent = {
                title: "胸腔引流術 - 教案指引",
                sections: [
                    {
                        heading: "考官指引",
                        content: `考官您好，本站為「胸腔引流術」考題，旨在評估考生在無菌操作、解剖定位、麻醉技巧、插管與固定等方面的綜合能力。請您根據評分標準，公正客觀地給予評分，並在「考官註解」中提供具體、建設性的回饋。
        
                        評分注意事項：
                        1. 無菌技術：請特別關注考生從洗手到穿戴手套、消毒過程的無菌意識與操作。
                        2. 解剖定位：評估考生能否準確找到穿刺點。
                        3. 麻醉效果：觀察考生麻醉藥物注射技巧與患者反應。
                        4. 插管技巧：評估進針角度、深度與導管放置的順暢性。
                        5. 固定與引流：確保導管固定牢固，並連接引流裝置。`
                    },
                    {
                        heading: "考生指引",
                        content: `考生您好，在「胸腔引流術」考站中，您需要展示在模擬情境下執行胸腔引流術的臨床技能。請注意無菌原則、與標準化病人的溝通、操作步驟的流暢性與安全性。
        
                        考前準備：請確認您已熟悉胸腔引流術的標準操作流程（SOP）和相關解剖知識。
                        考試流程：
                        1. 進入考站後，請先自我介紹並向病人說明操作目的。
                        2. 依序執行洗手、穿戴無菌手套、消毒皮膚等步驟。
                        3. 執行局部麻醉。
                        4. 執行胸腔穿刺引流。
                        5. 固定導管並連接引流瓶。
                        6. 完成操作後的收尾工作。`
                    },
                    {
                        heading: "標準化病人指引",
                        content: `標準化病人您好，在「胸腔引流術」考站中，您的角色是一位因氣胸需接受胸腔引流術的患者。請您根據以下指示，真實地表現病人的反應，以協助考官評估考生的表現。
        
                        情境設定：您因氣胸導致呼吸困難，感到胸痛。
                        表演要點：
                        1. 疼痛表現：當考生觸摸或操作時，若感到不適，可輕微皺眉或發出輕哼。若疼痛加劇，可表達「有點痛」。
                        2. 呼吸困難：可表現為呼吸急促或淺快。
                        3. 溝通互動：如果考生有向您說明、詢問感受，請您適當地給予回應。
                        4. 情緒反應：保持穩定，不過度焦慮或抱怨。`
                    },
                    {
                        heading: "教案內容與附件",
                        content: `[此處可放置具體SOP流程圖、解剖示意圖、或相關附件圖片]`
                    }
                ]
            };

            const [dashboardData, setDashboardData] = useState(initialDashboardData);
            const [sessionTimeLeft, setSessionTimeLeft] = useState(0); // 單位：秒
            const [overallComment, setOverallComment] = useState(""); // 整體總評
            const [overallScore, setOverallScore] = useState(null); // 整體表現評分 (1-5)
            const [itemNotes, setItemNotes] = useState(Array(initialDashboardData.rubric.length).fill("")); // 考官註解
            const [currentScores, setCurrentScores] = useState(Array(initialDashboardData.rubric.length).fill(null)); // 初始為 null 表示未評分
            const [examinerFeedback, setExaminerFeedback] = useState(""); // 考官回饋問卷內容
            const [standardizedPatientFeedback, setStandardizedPatientFeedback] = useState(""); // 評核標準化病人問卷內容

            const [showErrorModal, setShowErrorModal] = useState(false); // 顯示錯誤提示模態框
            const [errorMessage, setErrorMessage] = useState(""); // 錯誤訊息
            const [showCandidateListModal, setShowCandidateListModal] = useState(false); // 顯示考生列表模態框 (用於修改成績)

            // 新增模態框顯示狀態
            const [showTeachingGuideModal, setShowTeachingGuideModal] = useState(false);
            // 統一問卷顯示為一個模態框
            const [showFinalQuestionnairesModal, setShowFinalQuestionnairesModal] = useState(false);
            // 移除成績視覺化模態框相關狀態

            // 新增會話完成狀態
            const [showCompletionMessage, setShowCompletionMessage] = useState(false);


            // 新增狀態管理日期、考生、考官選擇 (考官預設帶入)
            const getTodayDateString = () => {
                const today = new Date();
                return today.toISOString().split('T')[0];
            };
            const [selectedDate, setSelectedDate] = useState(getTodayDateString());
            const [selectedCandidateId, setSelectedCandidateId] = useState(""); // 初始無選擇
            // 自動帶入考官ID
            const [selectedExaminerId, setSelectedExaminerId] = useState(initialDashboardData.examinerId);
            const [allCandidates, setAllCandidates] = useState(mockCandidates); // 用於儲存考生及其評分狀態

            // 計算已評考生數量
            const calculateScoredCandidates = useCallback(() => {
                return allCandidates.filter(c => c.scored).length;
            }, [allCandidates]);


            // 根據選擇的考生更新評分面板顯示
            useEffect(() => {
                const selectedCandidate = allCandidates.find(c => c.id === selectedCandidateId);
                if (selectedCandidate) {
                    setDashboardData(prevData => ({
                        ...prevData,
                        currentCandidate: {
                            id: selectedCandidate.id,
                            name: selectedCandidate.name,
                            ticket: selectedCandidate.ticket,
                            scores: selectedCandidate.savedScores || Array(prevData.rubric.length).fill(null),
                            comment: selectedCandidate.savedComment || "",
                            itemNotes: selectedCandidate.savedItemNotes || Array(prevData.rubric.length).fill(""),
                        }
                    }));
                    setOverallComment(selectedCandidate.savedComment || "");
                    setOverallScore(selectedCandidate.savedOverallScore || null);
                    setItemNotes(selectedCandidate.savedItemNotes || Array(dashboardData.rubric.length).fill(""));
                    setCurrentScores(selectedCandidate.savedScores || Array(dashboardData.rubric.length).fill(null));
                    setExaminerFeedback(selectedCandidate.savedExaminerFeedback || "");
                    setStandardizedPatientFeedback(selectedCandidate.savedStandardizedPatientFeedback || "");
                } else {
                    setDashboardData(prevData => ({
                        ...prevData,
                        currentCandidate: null
                    }));
                    setOverallComment("");
                    setOverallScore(null);
                    setItemNotes(Array(dashboardData.rubric.length).fill(""));
                    setCurrentScores(Array(dashboardData.rubric.length).fill(null));
                    setExaminerFeedback("");
                    setStandardizedPatientFeedback("");
                }
            }, [selectedCandidateId, dashboardData.rubric.length, allCandidates]);

            // 計算場次剩餘時間
            useEffect(() => {
                const sessionEndTime = new Date(dashboardData.station.sessionEnd).getTime();
                const calculateTimeLeft = () => {
                    const now = new Date().getTime();
                    const timeLeft = Math.max(0, Math.floor((sessionEndTime - now) / 1000));
                    setSessionTimeLeft(timeLeft);
                };

                calculateTimeLeft(); // 初次計算
                const timer = setInterval(calculateTimeLeft, 1000); // 每秒更新

                return () => clearInterval(timer); // 清理定時器
            }, [dashboardData.station.sessionEnd]);

            // 格式化時間，當倒數到 00:00 時不再顯示
            const formatTime = (totalSeconds) => {
                if (totalSeconds <= 0) {
                    return ""; // 不顯示任何文字
                }
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            // 處理評分項分數改變 (針對 Radio Button)
            const handleScoreChange = (index, value) => {
                const newScores = [...currentScores];
                newScores[index] = parseInt(value, 10);
                setCurrentScores(newScores);
            };

            // 處理考官註解改變
            const handleItemNoteChange = (index, value) => {
                const newNotes = [...itemNotes];
                newNotes[index] = value;
                setItemNotes(newNotes);
            };

            // 計算總分
            const calculateTotalScore = useCallback(() => {
                return currentScores.reduce((sum, score) => sum + (score !== null ? score : 0), 0);
            }, [currentScores]);


            // 提交考生評分
            const handleSubmitCandidateScore = () => {
                // 檢查基本選擇器是否已選
                if (!selectedDate || !selectedCandidateId) { // 考官ID已自動帶入，無需檢查
                    setErrorMessage("請先選擇測驗日期及考生！");
                    setShowErrorModal(true);
                    return;
                }

                // 檢查整體表現是否評分
                if (overallScore === null) {
                    setErrorMessage("請選擇考生整體表現的評分！");
                    setShowErrorModal(true);
                    return;
                }

                // 檢查所有題目是否都已評分，並收集未評的題目
                const unscoredItems = [];
                currentScores.forEach((score, index) => {
                    if (score === null) {
                        unscoredItems.push(dashboardData.rubric[index].item);
                    }
                });

                if (unscoredItems.length > 0) {
                    setErrorMessage(`尚有題目未評分，請檢查：\n${unscoredItems.map((item, idx) => `${idx + 1}. ${item}`).join('\n')}`);
                    setShowErrorModal(true);
                    return;
                }

                // 計算當前考生的總分
                const currentCandidateTotalScore = calculateTotalScore();

                // 這裡應將所有數據提交至後端
                console.log("提交考生評分:", {
                    examDate: selectedDate,
                    examinerId: selectedExaminerId,
                    candidateId: selectedCandidateId,
                    stationId: dashboardData.station.stationId,
                    scores: currentScores,
                    overallScore: overallScore, // 整體表現評分
                    overallComment: overallComment, // 整體總評文字 (現在不是必填)
                    itemNotes: itemNotes,
                    totalScore: currentCandidateTotalScore, // 總分
                    examinerFeedback: examinerFeedback, // 考官回饋問卷
                    standardizedPatientFeedback: standardizedPatientFeedback // 標準化病人問卷
                });

                // 更新考生狀態為已評分
                let updatedCandidates = [];
                setAllCandidates(prevCandidates => {
                    updatedCandidates = prevCandidates.map(c =>
                        c.id === selectedCandidateId
                            ? {
                                ...c,
                                scored: true,
                                savedScores: currentScores,
                                savedComment: overallComment,
                                savedOverallScore: overallScore,
                                savedItemNotes: itemNotes,
                                savedExaminerFeedback: examinerFeedback,
                                savedStandardizedPatientFeedback: standardizedPatientFeedback,
                                totalScore: currentCandidateTotalScore // Save total score
                            }
                            : c
                    );
                    return updatedCandidates;
                });

                // 判斷是否所有考生都已評分
                // 使用新的 updatedCandidates 來判斷是否所有考生都已評分
                const areAllCandidatesNowScored = updatedCandidates.every(c => c.scored);

                if (areAllCandidatesNowScored) {
                    // 所有考生都已評分，準備觸發最終問卷模態框
                    setSelectedCandidateId(""); // 清空當前評分面板
                    setOverallComment("");
                    setOverallScore(null);
                    setItemNotes(Array(dashboardData.rubric.length).fill(""));
                    setCurrentScores(Array(dashboardData.rubric.length).fill(null));
                    // 自動彈出問卷視窗
                    setShowFinalQuestionnairesModal(true);
                } else {
                    // 自動切換到下一位未評分的考生 (如果還有)
                    const currentCandidateIndex = updatedCandidates.findIndex(c => c.id === selectedCandidateId); // Use updatedCandidates
                    let nextCandidate = null;
                    // 從當前考生之後尋找未評分的考生
                    for (let i = currentCandidateIndex + 1; i < updatedCandidates.length; i++) { // Use updatedCandidates
                        if (!updatedCandidates[i].scored) { // Use updatedCandidates
                            nextCandidate = updatedCandidates[i];
                            break;
                        }
                    }
                    // 如果後面沒有，則從頭開始尋找未評分的考生
                    if (!nextCandidate) { // Fix: Changed from !nextCandidates to !nextCandidate
                        for (let i = 0; i < updatedCandidates.length; i++) { // Use updatedCandidates
                            if (!updatedCandidates[i].scored) { // Use updatedCandidates
                                nextCandidate = updatedCandidates[i];
                                break;
                            }
                        }
                    }

                    if (nextCandidate) {
                        setSelectedCandidateId(nextCandidate.id);
                    } else {
                        // This case should ideally not be reached if `areAllCandidatesNowScored` logic is correct
                        setDashboardData(prevData => ({ ...prevData, currentCandidate: null }));
                        setSelectedCandidateId("");
                    }

                    // 重置評分面板狀態，為下一位考生準備
                    setOverallComment("");
                    setOverallScore(null);
                    setItemNotes(Array(dashboardData.rubric.length).fill(""));
                    setCurrentScores(Array(dashboardData.rubric.length).fill(null)); // 重置為 null 待評
                }

                console.log("考生評分已提交！");
            };

            // 處理最終完成本次測驗評分 (點擊"完成本次測驗評分"按鈕)
            const handleFinalSubmitSessionTrigger = () => {
                // 首先檢查所有考生是否真的都評分了
                if (calculateScoredCandidates() !== allCandidates.length) {
                    setErrorMessage("仍有考生未完成評分！請完成所有考生評分後再點擊此按鈕。");
                    setShowErrorModal(true);
                    return;
                }
                // 如果所有考生都已評分，則彈出問卷模態框
                setShowFinalQuestionnairesModal(true);
            };

            // 在最終問卷模態框中提交問卷
            const handleQuestionnairesSubmit = () => {
                if (!examinerFeedback.trim() || !standardizedPatientFeedback.trim()) {
                    setErrorMessage("請填寫所有回饋問卷才能完成本次測驗！");
                    setShowErrorModal(true);
                    return;
                }
                // 所有條件都已滿足，顯示完成訊息
                setShowFinalQuestionnairesModal(false); // 關閉問卷模態框
                setShowCompletionMessage(true); // 顯示最終感謝畫面
                console.log("本次測驗評分全部完成！");
            };


            // 定義主色調深紫色
            const highlightPurple = '#6B468C'; // 考官圖示的紫色 (用於按鈕和邊框)

            // 新增的按鈕柔和顏色 (加深處理)
            const darkerSoftBlue = '#4A7CA1'; // 較深的藍色
            const darkerSoftOrange = '#D18765'; // 較深的橘色
            const darkerSoftGreen = '#82B498'; // 較深的綠色


            const overallScoreDescriptions = {
                1: "差",
                2: "待加強",
                3: "普通",
                4: "良好",
                5: "優秀"
            };

            const currentExaminerName = mockExaminers.find(e => e.id === selectedExaminerId)?.name || '考官';

            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-800 flex flex-col" style={{ fontFamily: 'Inter', sansSerif: 'sans-serif' }}>
                    {/* 完成測驗的感謝畫面 */}
                    {showCompletionMessage && (
                        <div className="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
                            <div className="text-9xl mb-8 animate-bounce">😊</div> {/* 大笑臉動畫 */}
                            <p className="text-4xl font-bold text-gray-800 mb-4">感謝您完成本次 OSCE 測驗評分！</p>
                            <p className="text-xl text-gray-600">您的貢獻對我們至關重要。</p>
                        </div>
                    )}

                    {/* 頂部導覽列 - 參照考生頁面樣式 */}
                    <header className="text-white shadow-md p-4 sticky top-0 z-10" style={{ backgroundColor: highlightPurple }}>
                        <div className="max-w-7xl mx-auto flex justify-between items-center w-full">
                            {/* 左側大標題 */}
                            <h1 className="text-2xl font-bold">奇美醫院 OSCE 考官評分儀表板</h1>

                            {/* 右側考官資訊與時間 */}
                            <div className="flex items-center space-x-4 text-base md:text-lg">
                                <span className="font-semibold">{currentExaminerName} 你好</span>
                                <span>{new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' })}</span>
                                <span>{new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                        </div>
                    </header>

                    {/* 主要內容區塊 - 類似考生頁面的寬度 */}
                    <main className="flex-1 max-w-7xl mx-auto py-6 px-4 md:px-6 lg:px-8">

                        {/* 頂部白底資訊框 */}
                        <div className="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4" style={{ borderColor: highlightPurple }}>
                            {/* 測驗日期、考生選擇 */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6 mb-4">
                                <div className="flex flex-col">
                                    <label htmlFor="exam-date-main" className="font-semibold text-gray-700 mb-1">測驗日期:</label>
                                    <input
                                        type="date"
                                        id="exam-date-main"
                                        value={selectedDate}
                                        onChange={(e) => setSelectedDate(e.target.value)}
                                        className="p-2 rounded-md border border-gray-300 text-gray-800 bg-white w-full"
                                    />
                                </div>
                                <div className="flex flex-col">
                                    <label htmlFor="candidate-select-main" className="font-semibold text-gray-700 mb-1">考生:</label>
                                    <select
                                        id="candidate-select-main"
                                        value={selectedCandidateId}
                                        onChange={(e) => setSelectedCandidateId(e.target.value)}
                                        className="p-2 rounded-md border border-gray-300 text-gray-800 bg-white w-full"
                                    >
                                        <option value="">請選擇考生</option>
                                        {allCandidates.map(candidate => (
                                            <option key={candidate.id} value={candidate.id}>
                                                {candidate.name} ({candidate.ticket}) {candidate.scored ? '(已評)' : ''}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            {/* 目前的站別、已評考生數、剩餘時間 */}
                            <div className="flex flex-wrap items-center gap-x-6 gap-y-2 pt-4 border-t border-gray-200">
                                <span className="font-extrabold text-xl text-gray-800">目前站別: Station {dashboardData.station.stationId} ({dashboardData.station.title})</span> {/* Enlarged text */}
                                <span className="font-semibold text-gray-800">已評考生: {calculateScoredCandidates()} / {allCandidates.length}</span>
                                {sessionTimeLeft > 0 && ( /* Removed "已結束" text */
                                    <span className={`font-semibold px-2 py-0.5 rounded-full ${sessionTimeLeft <= 300 ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`}>
                                    本場次剩餘：{formatTime(sessionTimeLeft)}
                                    </span>
                                )}
                            </div>

                            {/* 教案指引按鈕 (已評核學員所有成績視覺化 按鈕已移除) */}
                            <div className="flex flex-wrap justify-start gap-4 pt-4 mt-4 border-t border-gray-200">
                                <button
                                    onClick={() => setShowTeachingGuideModal(true)}
                                    className="flex-1 min-w-[150px] max-w-[200px] text-white py-2 rounded-lg hover:opacity-90 transition duration-200 ease-in-out text-lg font-bold shadow-md"
                                    style={{ backgroundColor: darkerSoftBlue }}
                                >
                                    教案指引
                                </button>
                            </div>

                            {/* 已評核考生成績修改按鈕 */}
                            <div className="flex justify-end pt-4 border-t border-gray-200 mt-4">
                                <button
                                    onClick={() => setShowCandidateListModal(true)}
                                    className="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm font-medium"
                                >
                                    已評核考生成績修改
                                </button>
                            </div>
                        </div>


                        {/* 評分面板 */}
                        <section className="bg-white p-6 rounded-lg shadow-xl flex flex-col space-y-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                                評分面板 - 考生: {dashboardData.currentCandidate?.name || "請選擇考生"} ({dashboardData.currentCandidate?.ticket || "N/A"})
                            </h2>

                            {(!selectedCandidateId) ? ( // Check only selectedCandidateId
                                <p className="text-center text-gray-600 text-lg mt-8">請先選擇測驗日期及考生開始評分。</p>
                            ) : (
                                <>
                                    {/* 評分項目 (使用 Radio Button 和考官註解) */}
                                    <div className="space-y-4">
                                        {/* 評分選項標題 */}
                                        <div className="grid grid-cols-12 gap-2 mb-2 text-sm font-semibold text-gray-600 border-b pb-2">
                                            <div className="col-span-5 md:col-span-4"></div>
                                            <div className="col-span-3 md:col-span-3 text-center">
                                                <div className="flex justify-around items-center w-full"> {/* Use w-full for full width */}
                                                    <span className="w-1/3 text-nowrap">沒有做到 0分</span>
                                                    <span className="w-1/3 text-nowrap">部分做到 1分</span>
                                                    <span className="w-1/3 text-nowrap">完全做到 2分</span>
                                                </div>
                                            </div>
                                            <div className="col-span-4 md:col-span-5 text-center">考官註解</div>
                                        </div>
                                        {dashboardData.rubric.map((item, index) => (
                                            <div key={index} className="grid grid-cols-12 items-center p-3 bg-gray-50 rounded-md relative">
                                                {/* 題目名稱 */}
                                                <label htmlFor={`score-${index}`} className="text-base font-medium text-gray-700 col-span-5 md:col-span-4 flex items-center">
                                                    {index + 1}. {item.item}
                                                    {/* 提示符號 */}
                                                    {item.description && (
                                                        <div className="relative group ml-2">
                                                            <span className="text-blue-500 cursor-help text-lg">ⓘ</span> {/* Info icon */}
                                                            {/* Tooltip on hover */}
                                                            <div className="absolute left-full ml-2 top-1/2 -translate-y-1/2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20 whitespace-normal pointer-events-none">
                                                                <p className="font-bold mb-1">部分做到 (1分):</p>
                                                                <p className="mb-2">{item.description["1"]}</p>
                                                                <p className="font-bold mb-1">完全做到 (2分):</p>
                                                                <p>{item.description["2"]}</p>
                                                            </div>
                                                        </div>
                                                    )}
                                                </label>

                                                {/* Radio Buttons - 優化間距 */}
                                                <div className="col-span-3 md:col-span-3 flex justify-around items-center w-full"> {/* Use w-full for full width */}
                                                    <label className="flex items-center space-x-1 cursor-pointer p-1">
                                                        <input
                                                            type="radio"
                                                            id={`score-${index}-0`}
                                                            name={`rubric-item-${index}`}
                                                            value="0"
                                                            checked={currentScores[index] === 0}
                                                            onChange={(e) => handleScoreChange(index, e.target.value)}
                                                            className="form-radio h-5 w-5 text-blue-600"
                                                        />
                                                        <span className="text-sm"></span>
                                                    </label>
                                                    <label className="flex items-center space-x-1 cursor-pointer p-1">
                                                        <input
                                                            type="radio"
                                                            id={`score-${index}-1`}
                                                            name={`rubric-item-${index}`}
                                                            value="1"
                                                            checked={currentScores[index] === 1}
                                                            onChange={(e) => handleScoreChange(index, e.target.value)}
                                                            className="form-radio h-5 w-5 text-blue-600"
                                                        />
                                                        <span className="text-sm"></span>
                                                    </label>
                                                    <label className="flex items-center space-x-1 cursor-pointer p-1">
                                                        <input
                                                            type="radio"
                                                            id={`score-${index}-2`}
                                                            name={`rubric-item-${index}`}
                                                            value="2"
                                                            checked={currentScores[index] === 2}
                                                            onChange={(e) => handleScoreChange(index, e.target.value)}
                                                            className="form-radio h-5 w-5 text-blue-600"
                                                        />
                                                        <span className="text-sm"></span>
                                                    </label>
                                                </div>
                                                {/* 考官註解 */}
                                                <div className="col-span-4 md:col-span-5">
                                                    <textarea
                                                        rows="1"
                                                        className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                                        placeholder="考官註解 (選填)"
                                                        value={itemNotes[index]}
                                                        onChange={(e) => handleItemNoteChange(index, e.target.value)}
                                                    ></textarea>
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    {/* 整體總評區塊 */}
                                    <div className="mt-8 pt-6 border-t border-gray-200">
                                        <div className="flex justify-between items-end mb-4">
                                            <p className="block text-lg font-bold text-gray-800 mb-0">
                                                您認為考生整體表現如何：
                                            </p>
                                            {/* 總分顯示 */}
                                            <div className="flex items-baseline space-x-2">
                                                <span className="text-2xl font-bold text-gray-900">總分:</span>
                                                <span className="text-4xl font-extrabold" style={{ color: highlightPurple }}>{calculateTotalScore()}</span>
                                                <span className="text-2xl font-bold text-gray-900">分</span>
                                            </div>
                                        </div>

                                        {/* 考生整體表現評分 - 優化佈局 */}
                                        <div className="mb-4 grid grid-cols-5 gap-0 border border-gray-200 rounded-md p-0 overflow-hidden" style={{ borderColor: highlightPurple }}> {/* Apply border to container, set gap to 0 */}
                                            {[1, 2, 3, 4, 5].map(score => (
                                                <label key={score} className="flex flex-col items-center justify-center cursor-pointer p-2 hover:bg-gray-100 transition-colors duration-150 relative border-r last:border-r-0" style={{ borderColor: highlightPurple }}> {/* Add right border */}
                                                    <span className="text-base font-medium text-gray-700 mb-1">
                                                        {overallScoreDescriptions[score]}
                                                    </span>
                                                    <div className="flex items-center space-x-1">
                                                        <input
                                                            type="radio"
                                                            name="overall-performance"
                                                            value={score}
                                                            checked={overallScore === score}
                                                            onChange={(e) => setOverallScore(parseInt(e.target.value))}
                                                            className="form-radio h-5 w-5 text-purple-600"
                                                        />
                                                        <span className="text-base text-gray-700">{score}分</span>
                                                    </div>
                                                </label>
                                            ))}
                                        </div>

                                        <p className="block text-lg font-bold text-gray-800 mb-2">
                                            評語：
                                        </p>
                                        <textarea
                                            id="overall-comment"
                                            rows="4"
                                            className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="請輸入整體總評語 (選填)..."
                                            value={overallComment}
                                            onChange={(e) => setOverallComment(e.target.value)}
                                        ></textarea>
                                    </div>

                                    {/* 提交按鈕 */}
                                    {calculateScoredCandidates() === allCandidates.length ? (
                                        <button
                                            onClick={handleFinalSubmitSessionTrigger} // Changed to trigger the final questionnaire modal first
                                            className="w-full text-white py-3 mt-6 rounded-lg hover:opacity-90 transition duration-200 ease-in-out text-lg font-bold shadow-lg"
                                            style={{ backgroundColor: highlightPurple }}
                                        >
                                            完成本次測驗評分
                                        </button>
                                    ) : (
                                        <button
                                            onClick={handleSubmitCandidateScore}
                                            className="w-full text-white py-3 mt-6 rounded-lg hover:opacity-90 transition duration-200 ease-in-out text-lg font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                            style={{ backgroundColor: highlightPurple }}
                                            disabled={!selectedCandidateId}
                                        >
                                            提交 {dashboardData.currentCandidate?.ticket || "考生"} 評分
                                        </button>
                                    )}
                                </>
                            )}
                        </section>
                    </main>

                    {/* 自定義錯誤提示模態框 */}
                    {showErrorModal && (
                        <div className="fixed inset-0 bg-red-600 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
                                <h3 className="text-xl font-bold mb-4 text-red-700">錯誤提示</h3>
                                <p className="mb-6 text-gray-700 whitespace-pre-wrap">
                                    {errorMessage}
                                </p>
                                <button
                                    onClick={() => setShowErrorModal(false)}
                                    className="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition duration-150 ease-in-out"
                                >
                                    確定
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 已評核考生成績修改列表模態框 */}
                    {showCandidateListModal && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full text-left">
                                <h3 className="text-xl font-bold mb-4 text-gray-800 border-b pb-2">選擇考生進行修改</h3>
                                <p className="mb-4 text-gray-700">點擊考生姓名即可載入其評分數據進行修改。</p>
                                <div className="max-h-96 overflow-y-auto border border-gray-200 rounded-md p-2">
                                    {allCandidates.map(candidate => (
                                        <div
                                            key={candidate.id}
                                            className={`flex items-center justify-between p-3 my-1 rounded-md cursor-pointer transition duration-150 ease-in-out ${
                                                candidate.id === selectedCandidateId ? 'bg-blue-100 border-blue-500' : 'bg-gray-50 hover:bg-gray-100'
                                            }`}
                                            onClick={() => {
                                                setSelectedCandidateId(candidate.id);
                                                setShowCandidateListModal(false); // 選擇後關閉模態框
                                            }}
                                        >
                                            <span className="font-medium text-lg text-gray-800">
                                                {candidate.name} ({candidate.ticket})
                                            </span>
                                            {candidate.scored ? (
                                                <span className="text-green-600 font-semibold text-sm ml-2">
                                                    (已評 - 總分: {candidate.totalScore !== undefined ? candidate.totalScore : 'N/A'})
                                                </span>
                                            ) : (
                                                <span className="text-gray-500 text-sm">未評分</span>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-6 flex justify-end">
                                    <button
                                        onClick={() => setShowCandidateListModal(false)}
                                        className="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out"
                                    >
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 教案指引模態框 */}
                    {showTeachingGuideModal && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-8 rounded-lg shadow-xl max-w-4xl w-full h-5/6 flex flex-col">
                                <h3 className="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">{teachingGuideContent.title}</h3>
                                <div className="overflow-y-auto flex-1 pr-4"> {/* Added pr-4 for scrollbar space */}
                                    {teachingGuideContent.sections.map((section, index) => (
                                        <div key={index} className="mb-6">
                                            <h4 className="text-xl font-semibold text-gray-700 mb-2" style={{ color: highlightPurple }}>{section.heading}</h4>
                                            <p className="text-gray-700 whitespace-pre-wrap">{section.content}</p>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-6 flex justify-end border-t pt-4">
                                    <button
                                        onClick={() => setShowTeachingGuideModal(false)}
                                        className="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out"
                                    >
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 考官回饋問卷 & 評核標準化病人問卷的整合模態框 */}
                    {showFinalQuestionnairesModal && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-8 rounded-lg shadow-xl max-w-3xl w-full flex flex-col">
                                <h3 className="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">完成測驗前請填寫回饋問卷</h3>
                                <div className="overflow-y-auto flex-1 pr-4 space-y-6">
                                    {/* 考官回饋問卷 */}
                                    <div>
                                        <label htmlFor="examiner-feedback-final" className="block text-lg font-bold text-gray-800 mb-2">
                                            考官回饋問卷：
                                        </label>
                                        <textarea
                                            id="examiner-feedback-final"
                                            rows="8"
                                            className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="請輸入考官對本次考試的回饋內容..."
                                            value={examinerFeedback}
                                            onChange={(e) => setExaminerFeedback(e.target.value)}
                                        ></textarea>
                                    </div>
                                    {/* 評核標準化病人問卷 */}
                                    <div>
                                        <label htmlFor="standardized-patient-feedback-final" className="block text-lg font-bold text-gray-800 mb-2">
                                            評核標準化病人問卷：
                                        </label>
                                        <textarea
                                            id="standardized-patient-feedback-final"
                                            rows="8"
                                            className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="請輸入您對標準化病人的評核內容..."
                                            value={standardizedPatientFeedback}
                                            onChange={(e) => setStandardizedPatientFeedback(e.target.value)}
                                        ></textarea>
                                    </div>
                                </div>
                                <div className="mt-6 flex justify-end border-t pt-4">
                                    <button
                                        onClick={handleQuestionnairesSubmit}
                                        className="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-150 ease-in-out font-bold"
                                    >
                                        提交問卷並完成測驗
                                    </button>
                                    <button
                                        onClick={() => setShowFinalQuestionnairesModal(false)}
                                        className="ml-4 bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out"
                                    >
                                        稍後再填寫 (關閉)
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Render the App component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

